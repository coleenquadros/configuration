---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: managed-services

name: ci-int-managed-services-jobs

description: ''

app:
  $ref: /services/managed-services/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

type: jobs

config:
  - project:
      name: mk-strimzi-operator-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: strimzi-operator
      quay_org: app-sre
      jobs:
        - 'gl-pr-check-managed-services':
            display_name: mk-strimzi-operator pr-check
        - 'managed-services-gl-build-test-branch':
            branch: mk-release
            display_name: mk-strimzi-operator release
            archive_artifacts: 'test-results/**'
            junit_results: 'test-results/strimzi-operator/failsafe-reports/*.xml'
            cleanup_script: './build_cleanup.sh'
            release: true
        - 'managed-services-gl-build-test-branch':
            branch: mk-release-0.23.x
            display_name: mk-strimzi-operator 0.23.x release
            archive_artifacts: 'test-results/**'
            junit_results: 'test-results/strimzi-operator/failsafe-reports/*.xml'
            cleanup_script: './build_cleanup.sh'
            release: true
        - 'managed-services-security-scan':
            display_name: mk-strimzi-operator security-scan
            branch: mk-master
            ci_cmd: 'make scan_project'
            slack_channel_notification: mk-ci-cd
            cron_expression: 'H 6 * * *'
        # - 'mk-nightly-build-test-branch':
        #     branch: mk-master
        #     display_name: mk-strimzi-operator nightly
        #     archive_artifacts: 'test-results/**'
        #     junit_results: 'test-results/strimzi-operator/failsafe-reports/*.xml'
        #     cleanup_script: './build_cleanup.sh'
        #     ci_cmd: './build_deploy.sh nightly'
        #     cron_expression: 'H 5 * * 1,2,3,4,5' # mon-fri early morning
        #     backup_ecr_push_creds_account_region: "quayio-prod/eu-central-1"

  - project:
      name: mk-apache-kafka-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: apache-kafka
      quay_org: app-sre
      jobs:
        - 'gl-pr-check-apache-kafka':
            display_name: mk-apache-kafka pr-check
        - 'managed-services-gl-build-test-branch':
            branch: mk-release
            display_name: mk-apache-kafka build and test mk-release
            archive_artifacts: 'test-results/**'
            junit_results: 'test-results/strimzi-operator/failsafe-reports/*.xml'
            cleanup_script: './build_cleanup.sh'
            release: true
        - 'managed-services-security-scan':
            display_name: mk-apache-kafka security-scan
            branch: mk-release
            ci_cmd: 'make scan_project'
            slack_channel_notification: mk-ci-cd
            cron_expression: 'H 6 * * *'

  - project:
      name: mk-kafka-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: kafka-ui
      jobs:
        - 'gl-pr-check':
            display_name: mk-kafka-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: mk-kafka-ui build-mk-release

  - project:
      name: guides-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: guides
      jobs:
        - 'gl-pr-check':
            display_name: guides pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: guides build-mk-release
  
  - project:
      name: cli-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: cli
      jobs:
        - 'gl-build-master-managed-services':
            display_name: cli build-main
            branch: main
            build_deploy_script_path: './hack/build_deploy.sh'

  - project:
      name: kas-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: kas-ui
      jobs:
        - 'gl-pr-check':
            display_name: kas-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: kas-ui build-mk-release
  - project:
      name: srs-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: srs-ui
      jobs:
        - 'gl-pr-check':
            display_name: srs-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: srs-ui build-mk-release
  - project:
      name: sr-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: sr-ui
      jobs:
        - 'gl-pr-check':
            display_name: sr-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: sr-ui build-mk-release

  - project:
      name: application-services-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: application-services-ui
      jobs:
        - 'gl-pr-check':
            display_name: application-services-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: application-services-ui build-mk-release

  - project:
      name: strimzi-operator-bundle
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: strimzi-operator-bundle
      jobs:
        - 'gl-pr-check-managed-services':
            display_name: strimzi-operator-bundle pr-check
        - 'gl-build-master':
            branch: staging
            display_name: strimzi-operator-bundle build staging
        - 'strimzi-operator-test':
            display_name: strimzi-operator system-test staging
            branch: staging

  - project:
      name: mk-kas-fleetshard-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: kas-fleetshard
      quay_org: app-sre
      jobs:
        - 'gl-pr-check':
            display_name: kas-fleetshard pr-check
        - 'managed-services-gl-build-test-branch':
            branch: mk-main
            display_name: kas-fleetshard build and test mk-main
            archive_artifacts: 'systemtest/target/logs/**,systemtest/target/failsafe-reports/**'
            junit_results: 'systemtest/target/failsafe-reports/*.xml'
            cleanup_script: 'make ci/pipeline/cleanup'
            release: false
        - 'managed-services-gl-build-test-branch':
            branch: mk-release
            display_name: kas-fleetshard build and test mk-release
            archive_artifacts: 'systemtest/target/logs/**,systemtest/target/failsafe-reports/**'
            junit_results: 'systemtest/target/failsafe-reports/*.xml'
            cleanup_script: 'make ci/pipeline/cleanup'
            release: true

  - project:
      name: kas-fleet-manager
      label: kas-fleet-manager
      node: managed-services
      gl_group: service
      gl_project: kas-fleet-manager
      jobs:
        - 'gl-pr-check-kas-fleet-manager':
            display_name: kas-fleet-manager pr-check
            concurrent_build: true
        - 'gl-build-main-kas-fleet-manager':
            display_name: kas-fleet-manager build main
            branch: main
        - 'kas-fleet-manager-tests':
            display_name: KasFleetManager Tests periodic stage
            timeout: 7200
            disable: false
            cron_expression: 'H 6 * * 1-5'
            ci_cmd: './pr_check.sh'
            slack_channel_notification: mk-kas-fleet-manager
            branch: main
        - 'kas-fleet-manager-perf-test':
            branch: main
            display_name: kas-fleet-manager API perf test
            timeout: 7200
            slack_channel_notification: mk-kas-fleet-manager
            cron_expression: 'H 7 * * 2-5' # 7am UTC Tuesday to Friday

  - project:
      name: managed-services-kafka-performance-tests
      label: managed-services
      node: managed-services
      gl_group: mk-bin-packing
      gl_project: mk-performance-tests
      jobs:
        - 'managed-kafka-performance':
            display_name: 'managed-kafka-performance'
            mk_perf_type: 'value-prod'
            mk_perf_test: 'io.kafka.performance.**'
            timeout: 360
            slack_channel_notification: mk-ci-cd

  - project:
      name: managed-service-ci-tools
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-ci-tools
      jobs:
        - 'gl-pr-check':
            display_name: managed-service-ci-tools pr-check
            pr_check_script_path: './hack/pr_check.sh'
        - 'gl-build-master':
            display_name: managed-service-ci-tools build master
            build_deploy_script_path: './hack/build_deploy.sh'
        - 'managed-services-pull-upstream':
            display_name: managed services pull upstream
            ci_cmd: 'make pull/upstream/all'
            slack_channel_notification: mk-ci-cd
            cron_expression: '0 */1 * * *' # Every 1h
        - 'managed-kafka-promote-ui-beta':
            display_name: managed-kafka promote ui components to beta
            timeout: 120
        - 'managed-kafka-promote-ui-stable':
            display_name: managed-kafka promote ui components to stable
            timeout: 120

  - project:
      name: managed-services-kafka-fault-tests
      label: managed-services
      node: managed-services
      gh_org: bf2fc6cc711aee1a0c2a
      gh_repo: kas-fault-tests
      jobs:
        - 'managed-kafka-fault-tests':
            default_branch: main
            display_name: 'managed-kafka-fault-tests'
            timeout: 3600
            slack_channel_notification: forum-managed-kafka
            cron_expression: 'H 4 * * 1-5' # At 04:00 on every day-of-week from Monday through Friday

  - project:
      name: mk-e2e-test-suite
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-e2e-test-suite
      jobs:
        - 'gl-pr-check':
            display_name: mk-e2e-test-suite pr-check
            pr_check_script_path: './pr_check.sh'
        - 'managed-kafka-e2e-test-suite':
            branch: main
            display_name: periodic mk-e2e tests
            timeout: 60
            cron_expression: '5 */1 * * *' # At 5 minute past every 1 hour
        - 'managed-kafka-e2e-test-suite-sandbox':
            branch: main
            display_name: periodic sandbox mk-e2e tests
            timeout: 30
            cron_expression: '35 */6 * * *' # At 35 minute past every 6 hour
  - project:
      name: kas-upgrade-configurations
      label: kas-upgrade-configurations
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: kas-upgrade-configurations
      jobs:
        - 'gl-pr-check-kas-upgrade-configurations':
            display_name: kas-upgrade-configurations pr-check
            pr_check_script_path: './hack/pr_check.sh'
        - 'gl-build-main-kas-upgrade-configurations':
            display_name: kas-upgrade-configurations deploy
            build_deploy_script_path: './hack/deploy.sh'
            branch: main
  - project:
      name: mk-token-refresher
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-token-refresher
      jobs:
        - 'gl-pr-check':
            display_name: mk-token-refresher pr-check
            pr_check_script_path: './pr_check.sh'
        - 'gl-build-master-managed-services':
            display_name: mk-token-refresher build master
            build_deploy_script_path: './build_deploy.sh'
            branch: master

  - project:
      name: mk-client-examples
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: client-examples
      jobs:
        - 'gl-pr-check-managed-services':
            display_name: mk-client-examples pr-check
            pr_check_script_path: './pr_check.sh'
        - 'gl-build-master-managed-services':
            display_name: mk-client-examples build mk-release-0.23.x
            build_deploy_script_path: './build_deploy.sh'
            branch: mk-release-0.23.x
