---
$schema: /vault-config/policy-1.yml

labels:
  service: vault.devshift.net

name: "vault-manager-policy"
instance:
  $ref: /services/vault.devshift.net/config/prod/devshift-net.yml
rules: |
  #manage audit
  path "/sys/audit" {
    policy = "sudo"
    capabilities = ["create", "update", "delete"]
  }
  #manage auth
  path "/auth/*" {
    capabilities = ["create", "read", "update", "delete", "list"]
  }
  #manage github
  #note '/auth/github*' allows to have multiple GH orgs
  #path "/auth/github*" {
  #  capabilities = ["create", "read", "update", "delete", "list"]
  #}
  #manage policies
  #allow CRUD on policies
  path "/sys/policy/*" {
    capabilities = ["create", "read", "update", "delete"]
  }
  #allow LIST policies
  path "/sys/policy" {
    capabilities = ["read","list"]
  }
  #allow CRUD policies on web UI
  path "/sys/policies/acl/*" {
    capabilities = ["create", "read", "update", "delete","list"]
  }
  #manage secret-engines
  #allow CRUD on mounts
  path "sys/mounts/*" {
    capabilities = ["create", "read", "update", "delete"]
  }
  #allow LIST mounts
  path "sys/mounts" {
    capabilities = ["read","list"]
  }
  #manage auth-backends
  #allow CRUD on auth
  path "/sys/auth/*" {
    policy = "sudo"
    capabilities = ["create", "read", "update", "delete"]
  }
  #allow LIST auth
  path "/sys/auth" {
    policy = "sudo"
    capabilities = ["read","list"]
  }
  #manage identity resources
  path "/identity/*" {
    capabilities = ["create", "read", "update", "delete", "list"]
  }
  #allow read of vault-manager secret
  path "/app-sre/ci-int/vault-manager-creds" {
    policy = "sudo"
    capabilities = ["read"]
  }
  #allow read of vault-manager-stage secret
  path "/app-sre/ci-int/vault-manager-stage-creds" {
    policy = "sudo"
    capabilities = ["read"]
  }
  #allow read of vault-manager CI Ext secret
  path "/app-sre/ci-ext/vault-manager-creds" {
    policy = "sudo"
    capabilities = ["read"]
  }
  #allow read of vault-manager oidc secret
  path "/app-interface/data/app-sre/vault-prod/oidc/*" {
    capabilities = ["read", "list"]
  }
  path "/app-interface/data/app-sre/vault-prod/oidc" {
    capabilities = ["read", "list"]
  }
  # allow vault-manger to read kubernetes public cert files
  path "/app-interface/data/app-sre/vault-prod/kubernetes/*" {
    capabilities = ["read", "list"]
  }
  path "/app-interface/data/app-sre/vault-prod/kubernetes" {
    capabilities = ["read", "list"]
  }
  # grant permissions for smqe-approle output_path
  path "/insights/data/secrets/qe/stage/swatch/smqe-approle" {
    capabilities = ["read", "create", "update"]
  }
  # grant permissions for vault-replication approle output path
  path "/app-sre/creds/vault-replication-approle-main" {
    capabilities = ["read", "create", "update"]
  }
  # grant permissions for development approles output path
  path "/app-sre/approles/dev/*" {
    capabilities = ["read", "list", "create", "update"]
  }
  #allow read of vault-manager-dev secret
  path "/app-sre/ci-int/vault-manager-dev-creds" {
    capabilities = ["read"]
  }
