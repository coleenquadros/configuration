---
$schema: /app-sre/slo-document-1.yml

labels:
  service: tower-analytics

name: tower-analytics

namespaces:
- $ref: /services/insights/tower-analytics/namespaces/tower-analytics-prod.yml

app:
  $ref:  /services/insights/tower-analytics/app.yml

slos:
- name: Requests result in successful (non-5xx) response
  dashboard: https://grafana.app-sre.devshift.net/d/slo-dashboard/slo-dashboard?orgId=1&from=now-7d&to=now&var-datasource=crcp01ue1-prometheus&var-label=tower-analytics
  SLIType: availability
  SLISpecification: Proportion of sucessful requests with a non-5xx response against all requests on tower-analytics API
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/app-interface/slos/reconciliation-of-app-interface-integrations.md
  expr: |
    1-(
      sum(rate(api_3scale_gateway_api_status{exported_service="tower-analytics",status="5xx"}[{{window}}]))
      /
      sum(rate(api_3scale_gateway_api_status{exported_service="tower-analytics"}[{{window}}]))
    )
  prometheusRules: /resources/insights-prod/tower-analytics-prod/automation-analytics.prometheusrules.yaml

- name: Request latency
  dashboard: https://grafana.app-sre.devshift.net/d/slo-dashboard/slo-dashboard?orgId=1&from=now-7d&to=now&var-datasource=crcp01ue1-prometheus&var-label=tower-analytics
  SLIType: latency
  SLISpecification: Proportion of requests with less than <2000 ms against all requests on tower-analytics API
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/app-interface/slos/reconciliation-of-app-interface-integrations.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(api_3scale_gateway_api_time_bucket{le="2000.0", exported_service="tower-analytics"}[{{window}}])) 
    / 
    sum(rate(api_3scale_gateway_api_time_bucket{le="+Inf", exported_service="tower-analytics"}[{{window}}]))
  prometheusRules: /resources/insights-prod/tower-analytics-prod/automation-analytics.prometheusrules.yaml
