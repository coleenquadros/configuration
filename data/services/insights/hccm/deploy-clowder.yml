---
$schema: /app-sre/saas-file-2.yml

labels:
  service: hccm
  platform: insights

name: hccm-clowder
description: hccm app on the Insights Platform deployed with Clowder

app:
  $ref: /services/insights/hccm/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.app-sre-prod-01.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

managedResourceTypes:
- ClowdApp
- PersistentVolumeClaim
- ConfigMap

imagePatterns:
- quay.io/cloudservices

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all

parameters:
  CLOWDER_ENABLED: true

resourceTemplates:
- name: koku
  path: /deploy/clowdapp.yaml
  url: https://github.com/project-koku/koku
  targets:

  # Ephemeral
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true # tells app-sre to not actually run the deploy job for this target
    ref: internal # altered by bonfire
    parameters:
      KOKU_MIN_REPLICAS: 1
      LISTENER_MIN_REPLICAS: 1
      MASU_MIN_REPLICAS: 1
      SCHEDULER_MIN_REPLICAS: 1
      SOURCES_CLIENT_MIN_REPLICAS: 1
      SOURCES_LISTENER_MIN_REPLICAS: 1
      WORKER_CELERY_MIN_REPLICAS: 1
      WORKER_COST_MODEL_MIN_REPLICAS: 1
      WORKER_DOWNLOAD_MIN_REPLICAS: 1
      WORKER_OCP_MIN_REPLICAS: 1
      WORKER_PRIORITY_MIN_REPLICAS: 1
      WORKER_REFRESH_MIN_REPLICAS: 1
      WORKER_SUMMARY_MIN_REPLICAS: 1

  # Staging:
  - namespace:
      $ref: /services/insights/hccm/namespaces/stage-hccm-stage.yml
    ref: e6f1216a6299e4492f03f37796af07808b827dac
    parameters:
      IMAGE_TAG: e6f1216
      APP_DOMAIN: apps.crcs02ue1.urby.p1.openshiftapps.com
      S3_BUCKET_NAME: hccm-stage-s3
      KOKU_SENTRY_ENV: stage
      ENABLE_API_SENTRY: True
      ENABLE_CELERY_SENTRY: True
      DEMO_ACCOUNTS: '{"6193296":{"arn:aws:iam::589173575009:role/NisePopulatorAccessRole":{"source_type": "AWS", "report_prefix":"cur","report_name":"awscost"},"5d4eb34d-43c7-4b06-8257-1cb599b48d1e":{"source_type": "Azure", "report_prefix":"cur","report_name":"azurecost","container_name":"cur"}}}'
      ENABLE_PARQUET_PROCESSING: False
      ENABLE_S3_ARCHIVING: True
      ENABLE_TRINO_SOURCES: ''
      ENABLE_TRINO_SOURCE_TYPE: 'GCP'
      ENABLE_TRINO_ACCOUNTS: 'acct6193296'
      AUTO_DATA_INGEST: True
      UPDATE_TIMEOUT: 14400
      RETAIN_NUM_MONTHS: 3
      VACUUM_DATA_DAY_OF_WEEK: 0
      # Deployment specific variables:
      # koku-api
      KOKU_MIN_REPLICAS: 3
      KOKU_CPU_REQUEST: 500m
      KOKU_CPU_LIMIT: 1
      KOKU_MEMORY_REQUEST: 512Mi
      KOKU_MEMORY_LIMIT: 1Gi
      # listener
      LISTENER_MIN_REPLICAS: 2
      LISTENER_CPU_REQUEST: 200m
      LISTENER_CPU_LIMIT: 500m
      LISTENER_MEMORY_REQUEST: 512Mi
      LISTENER_MEMORY_LIMIT: 1Gi
      # masu
      MASU_MIN_REPLICAS: 1
      MASU_MEMORY_REQUEST: 256Mi
      MASU_MEMORY_LIMIT: 512Mi
      # scheduler
      SCHEDULER_MIN_REPLICAS: 1
      SCHEDULER_MEMORY_REQUEST: 256Mi
      SCHEDULER_MEMORY_LIMIT: 512Mi
      # sources-client
      SOURCES_CLIENT_MIN_REPLICAS: 1
      SOURCES_CLIENT_CPU_REQUEST: 100m
      SOURCES_CLIENT_CPU_LIMIT: 250m
      SOURCES_CLIENT_MEMORY_REQUEST: 200Mi
      SOURCES_CLIENT_MEMORY_LIMIT: 400Mi
      # sources-listener
      SOURCES_LISTENER_MIN_REPLICAS: 1
      SOURCES_LISTENER_CPU_REQUEST: 100m
      SOURCES_LISTENER_CPU_LIMIT: 250m
      SOURCES_LISTENER_MEMORY_REQUEST: 200Mi
      SOURCES_LISTENER_MEMORY_LIMIT: 400Mi
      # worker-celery
      WORKER_CELERY_MIN_REPLICAS: 2
      WORKER_CELERY_CPU_REQUEST: 200m
      WORKER_CELERY_CPU_LIMIT: 250m
      WORKER_CELERY_MEMORY_REQUEST: 512Mi
      WORKER_CELERY_MEMORY_LIMIT: 1Gi
      # worker-cost-model
      WORKER_COST_MODEL_MIN_REPLICAS: 2
      WORKER_COST_MODEL_CPU_REQUEST: 100m
      WORKER_COST_MODEL_CPU_LIMIT: 200m
      WORKER_COST_MODEL_MEMORY_REQUEST: 200Mi
      WORKER_COST_MODEL_MEMORY_LIMIT: 400Mi
      # worker-download
      WORKER_DOWNLOAD_MIN_REPLICAS: 2
      WORKER_DOWNLOAD_CPU_REQUEST: 500m
      WORKER_DOWNLOAD_CPU_LIMIT: 1
      WORKER_DOWNLOAD_MEMORY_REQUEST: 2Gi
      WORKER_DOWNLOAD_MEMORY_LIMIT: 4Gi
      # worker-ocp
      WORKER_OCP_MIN_REPLICAS: 2
      WORKER_OCP_CPU_REQUEST: 100m
      WORKER_OCP_CPU_LIMIT: 200m
      WORKER_OCP_MEMORY_REQUEST: 200Mi
      WORKER_OCP_MEMORY_LIMIT: 400Mi
      # worker-priority
      WORKER_PRIORITY_MIN_REPLICAS: 2
      WORKER_PRIORITY_CPU_REQUEST: 250m
      WORKER_PRIORITY_CPU_LIMIT: 500m
      WORKER_PRIORITY_MEMORY_REQUEST: 1Gi
      WORKER_PRIORITY_MEMORY_LIMIT: 2Gi
      # worker-refresh
      WORKER_REFRESH_MIN_REPLICAS: 2
      WORKER_REFRESH_CPU_REQUEST: 100m
      WORKER_REFRESH_CPU_LIMIT: 200m
      WORKER_REFRESH_MEMORY_REQUEST: 200Mi
      WORKER_REFRESH_MEMORY_LIMIT: 400Mi
      # worker-summary
      WORKER_SUMMARY_MIN_REPLICAS: 2
      WORKER_SUMMARY_CPU_REQUEST: 100m
      WORKER_SUMMARY_CPU_LIMIT: 200m
      WORKER_SUMMARY_MEMORY_REQUEST: 200Mi
      WORKER_SUMMARY_MEMORY_LIMIT: 400Mi

  # Production:
  - namespace:
      $ref: /services/insights/hccm/namespaces/hccm-prod.yml
    ref: e6f1216a6299e4492f03f37796af07808b827dac
    parameters:
      IMAGE_TAG: e6f1216
      APP_DOMAIN: apps.crcp01ue1.o9m8.p1.openshiftapps.com
      S3_BUCKET_NAME: hccm-prod-s3
      KOKU_SENTRY_ENV: prod
      ENABLE_API_SENTRY: True
      ENABLE_CELERY_SENTRY: True
      DEMO_ACCOUNTS: '{"6193296":{"arn:aws:iam::589173575009:role/NisePopulatorAccessRole":{"source_type": "AWS", "report_prefix":"cur","report_name":"awscost"},"5d4eb34d-43c7-4b06-8257-1cb599b48d1e":{"source_type": "Azure", "report_prefix":"cur","report_name":"azurecost","container_name":"cur"}}}'
      ENABLE_PARQUET_PROCESSING: False
      ENABLE_S3_ARCHIVING: True
      ENABLE_TRINO_SOURCES: 'f71993c9-db47-4dcf-b375-c32d84502b13,118445f0-7304-4311-aa22-ed86b484f48d,79419ac3-cf38-450c-84cf-7d2accc2c293,889668d0-8bdc-4e96-84fe-4311b3514efb,b139babe-9f1a-4519-ae49-bfd4e06807a2,cbf2420e-ab4b-4ab3-b27c-d5a05d578262,d24bd391-fc65-4275-a7bb-174c91e1c9fe,f1eb8998-4984-4ee5-9bfb-f0370cb690a4,cc11e600-9888-4614-be92-634b132c0f44,a84c1928-4891-4ff0-b458-f4fd27a7218a,a6568967-155a-428f-a20c-3c5d46f45ad8'
      ENABLE_TRINO_SOURCE_TYPE: 'GCP'
      ENABLE_TRINO_ACCOUNTS: 'acct7049367'
      AUTO_DATA_INGEST: True
      RETAIN_NUM_MONTHS: 3
      INITIAL_INGEST_OVERRIDE: 'True'
      INITIAL_INGEST_NUM_MONTHS: 1
      SCHEDULE_CHECK_INTERVAL: 720
      SOURCE_STATUS_FREQUENCY_MINUTES: 60
      UPDATE_TIMEOUT: 14400
      VACUUM_DATA_DAY_OF_WEEK: 0
      PRESTO_HOST: 'presto'
      PRESTO_PORT: 8080
      # Deployment specific variables:
      # koku-api
      KOKU_MIN_REPLICAS: 5
      KOKU_CPU_REQUEST: 200m
      KOKU_CPU_LIMIT: 1
      KOKU_MEMORY_REQUEST: 1Gi
      KOKU_MEMORY_LIMIT: 2Gi
      # listener
      LISTENER_MIN_REPLICAS: 2
      LISTENER_CPU_REQUEST: 200m
      LISTENER_CPU_LIMIT: 1
      LISTENER_MEMORY_REQUEST: 1Gi
      LISTENER_MEMORY_LIMIT: 2Gi
      # masu
      MASU_MIN_REPLICAS: 1
      MASU_MEMORY_REQUEST: 256Mi
      MASU_MEMORY_LIMIT: 512Mi
      # scheduler
      SCHEDULER_MIN_REPLICAS: 1
      SCHEDULER_MEMORY_REQUEST: 256Mi
      SCHEDULER_MEMORY_LIMIT: 512Mi
      # sources-client
      SOURCES_CLIENT_MIN_REPLICAS: 1
      SOURCES_CLIENT_CPU_REQUEST: 250m
      SOURCES_CLIENT_CPU_LIMIT: 500m
      SOURCES_CLIENT_MEMORY_REQUEST: 256Mi
      SOURCES_CLIENT_MEMORY_LIMIT: 1Gi
      # sources-listener
      SOURCES_LISTENER_MIN_REPLICAS: 1
      SOURCES_LISTENER_CPU_REQUEST: 250m
      SOURCES_LISTENER_CPU_LIMIT: 500m
      SOURCES_LISTENER_MEMORY_REQUEST: 256Mi
      SOURCES_LISTENER_MEMORY_LIMIT: 1Gi
      # worker-celery
      WORKER_CELERY_MIN_REPLICAS: 2
      WORKER_CELERY_CPU_REQUEST: 200m
      WORKER_CELERY_CPU_LIMIT: 1
      WORKER_CELERY_MEMORY_REQUEST: 512Mi
      WORKER_CELERY_MEMORY_LIMIT: 1Gi
      # worker-cost-model
      WORKER_COST_MODEL_MIN_REPLICAS: 2
      WORKER_COST_MODEL_CPU_REQUEST: 100m
      WORKER_COST_MODEL_CPU_LIMIT: 300m
      WORKER_COST_MODEL_MEMORY_REQUEST: 512Mi
      WORKER_COST_MODEL_MEMORY_LIMIT: 1Gi
      # worker-download
      WORKER_DOWNLOAD_MIN_REPLICAS: 4
      WORKER_DOWNLOAD_CPU_REQUEST: 500m
      WORKER_DOWNLOAD_CPU_LIMIT: 1
      WORKER_DOWNLOAD_MEMORY_REQUEST: 5Gi
      WORKER_DOWNLOAD_MEMORY_LIMIT: 8Gi
      # worker-ocp
      WORKER_OCP_MIN_REPLICAS: 4
      WORKER_OCP_CPU_REQUEST: 100m
      WORKER_OCP_CPU_LIMIT: 200m
      WORKER_OCP_MEMORY_REQUEST: 200Mi
      WORKER_OCP_MEMORY_LIMIT: 400Mi
      # worker-priority
      WORKER_PRIORITY_MIN_REPLICAS: 4
      WORKER_PRIORITY_CPU_REQUEST: 250m
      WORKER_PRIORITY_CPU_LIMIT: 500m
      WORKER_PRIORITY_MEMORY_REQUEST: 2Gi
      WORKER_PRIORITY_MEMORY_LIMIT: 4Gi
      # worker-refresh
      WORKER_REFRESH_MIN_REPLICAS: 2
      WORKER_REFRESH_CPU_REQUEST: 100m
      WORKER_REFRESH_CPU_LIMIT: 200m
      WORKER_REFRESH_MEMORY_REQUEST: 200Mi
      WORKER_REFRESH_MEMORY_LIMIT: 400Mi
      # worker-summary
      WORKER_SUMMARY_MIN_REPLICAS: 3
      WORKER_SUMMARY_CPU_REQUEST: 100m
      WORKER_SUMMARY_CPU_LIMIT: 200m
      WORKER_SUMMARY_MEMORY_REQUEST: 512Mi
      WORKER_SUMMARY_MEMORY_LIMIT: 1Gi

- name: hive-metastore
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ubi-hive
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true # tells app-sre to not actually run the deploy job for this target
    ref: internal # altered by bonfire
    parameters:
      IMAGE_TAG: 2.3.3-003
      S3_BUCKET_NAME: hccm-eph-s3
  - namespace:
      $ref: /services/insights/hccm/namespaces/stage-hccm-stage.yml
    ref: e2d38d5cec970895e8591f46ef56d3688208bc34
    parameters:
      IMAGE_TAG: 2.3.3-003
      S3_BUCKET_NAME: hccm-stage-s3
      CPU_REQUEST: 200m
      CPU_LIMIT: 500m
      MEMORY_REQUEST: 1Gi
      MEMORY_LIMIT: 2Gi
  - namespace:
      $ref: /services/insights/hccm/namespaces/hccm-prod.yml
    ref: e2d38d5cec970895e8591f46ef56d3688208bc34
    parameters:
      IMAGE_TAG: 2.3.3-003
      MIN_REPLICAS: 1
      S3_BUCKET_NAME: hccm-prod-s3
      CPU_REQUEST: 200m
      CPU_LIMIT: 500m
      MEMORY_REQUEST: 512Mi
      MEMORY_LIMIT: 2Gi

- name: presto
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ubi-trino
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true # tells app-sre to not actually run the deploy job for this target
    ref: internal # altered by bonfire
    parameters:
      IMAGE_TAG: 348-003
      S3_BUCKET_NAME: hccm-eph-s3
  - namespace:
      $ref: /services/insights/hccm/namespaces/stage-hccm-stage.yml
    ref: 7fde696eecd680ccb60cc5ba11359887997e48b1
    parameters:
      IMAGE_TAG: 348-003
      S3_BUCKET_NAME: hccm-stage-s3
  - namespace:
      $ref: /services/insights/hccm/namespaces/hccm-prod.yml
    ref: 7fde696eecd680ccb60cc5ba11359887997e48b1
    parameters:
      IMAGE_TAG: 348-003
      S3_BUCKET_NAME: hccm-prod-s3
      COORDINATOR_REPLICAS: 1
      WORKER_REPLICAS: 3
      COORDINATOR_CPU_REQUEST: 200m
      COORDINATOR_CPU_LIMIT: 500m
      COORDINATOR_MEMORY_REQUEST: 8Gi
      COORDINATOR_MEMORY_LIMIT: 16Gi
      WORKER_CPU_REQUEST: 200m
      WORKER_CPU_LIMIT: 1
      WORKER_MEMORY_REQUEST: 4Gi
      WORKER_MEMORY_LIMIT: 8Gi
      QUERY_MAX_MEMORY: 8GB
      QUERY_MAX_MEMORY_PER_NODE: 2GB
      QUERY_MAX_TOTAL_MEMORY_PER_NODE: 4GB

- name: koku-report-emailer
  path: /deploy/clowdapp.yaml
  url: https://github.com/project-koku/koku-report-emailer
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true # tells app-sre to not actually run the deploy job for this target
    ref: internal # altered by bonfire
  - namespace:
      $ref: /services/insights/hccm/namespaces/stage-hccm-stage.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-ext/ci-ext.yml
      name: project-koku-koku-report-emailer-gh-build-main
    parameters:
      COST_MGMT_RECIPIENTS: '{"dmcpherscc":{"cc":["jkoehler@redhat.com", "dgutride@redhat.com"]}, "muhlcc":{}, "clovecc":{}, "gbuchanacc":{}}'
      EMAIL_SCHEDULE: '0 13 * * 1'
