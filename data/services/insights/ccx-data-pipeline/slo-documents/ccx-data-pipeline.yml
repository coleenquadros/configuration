---
$schema: /app-sre/slo-document-1.yml

labels:
  service: ccx-data-pipeline

name: ccx-data-pipeline

app:
  $ref: /services/insights/ccx-data-pipeline/app.yml

namespaces:
- $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml

slos:
- name: Archive processing is taking too long
  dashboard: https://grafana.app-sre.devshift.net/d/ccxprocessingslo/ccx-processing-slo?orgId=1&viewPanel=14
  SLIType: latency
  SLISpecification: The processing time of ccx-data-pipeline and db-writer is taking too long
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/ccx/ccx-docs/-/blob/master/source/customer/sops/archives_are_not_processed.rst
  expr: |
    (((((  
      sum(
          increase(successful_messages_processing_time_sum{namespace="ccx-data-pipeline-prod", service="ccx-insights-results-db-writer-prometheus-exporter"}[{{window}}])
      ) /  
      sum(   
          increase(successful_messages_processing_time_count{namespace="ccx-data-pipeline-prod", service="ccx-insights-results-db-writer-prometheus-exporter"}[{{window}}])
      )
    ) < 5) + 
    ((
        sum(    
            increase(ccx_process_duration_seconds_sum{namespace="ccx-data-pipeline-prod", service="ccx-data-pipeline-prometheus-exporter"}[{{window}}])  
        ) /  
        sum(   
            increase(ccx_process_duration_seconds_count{namespace="ccx-data-pipeline-prod", service="ccx-data-pipeline-prometheus-exporter"}[{{window}}])
        )
    ) < 5))
    /
    ((  
        sum(
            increase(successful_messages_processing_time_sum{namespace="ccx-data-pipeline-prod", service="ccx-insights-results-db-writer-prometheus-exporter"}[{{window}}])
        ) /  
        sum(   
            increase(successful_messages_processing_time_count{namespace="ccx-data-pipeline-prod", service="ccx-insights-results-db-writer-prometheus-exporter"}[{{window}}])
        )
    )  + 
    (
        sum(    
            increase(ccx_process_duration_seconds_sum{namespace="ccx-data-pipeline-prod", service="ccx-data-pipeline-prometheus-exporter"}[{{window}}])  
        ) /  
        sum(   
            increase(ccx_process_duration_seconds_count{namespace="ccx-data-pipeline-prod", service="ccx-data-pipeline-prometheus-exporter"}[{{window}}])
        )
    ))) OR on() vector(0))
  prometheusRules: /observability/prometheusrules/insights-ccx-processing-slo.prometheusrules.yaml

- name: API responses are taking too long
  dashboard: https://grafana.app-sre.devshift.net/d/ccxprocessingslo/ccx-processing-slo?orgId=1&viewPanel=8
  SLIType: latency
  SLISpecification: The response time of smart-proxy is taking too long
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/ccx/ccx-docs/-/blob/master/source/customer/sops/rest_api_gt_1_sec.rst
  expr: |
    (( count ( rate(api_endpoints_response_time_sum{namespace="ccx-data-pipeline-prod", service="ccx-smart-proxy"}[{{window}}]) < 0.5 ) 
    /
    count(rate(api_endpoints_response_time_sum{namespace="ccx-data-pipeline-prod", service="ccx-smart-proxy"}[{{window}}])) ) OR on() vector(0))
  prometheusRules: /observability/prometheusrules/insights-ccx-processing-slo.prometheusrules.yaml

- name: API 500 responses are too frequent
  dashboard: https://grafana.app-sre.devshift.net/d/ccxprocessingslo/ccx-processing-slo?orgId=1&viewPanel=12
  SLIType: availability
  SLISpecification: Too much 500 status code returned
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/ccx/ccx-docs/-/blob/master/source/customer/sops/too_much_500.rst
  expr: |
    (sum(rate(api_endpoints_status_codes{namespace="ccx-data-pipeline-prod", service="ccx-smart-proxy", status_code!="500"}[{{window}}]))
    /
    sum(rate(api_endpoints_status_codes{namespace="ccx-data-pipeline-prod", service="ccx-smart-proxy"}[{{window}}])))
  prometheusRules: /observability/prometheusrules/insights-ccx-processing-slo.prometheusrules.yaml
