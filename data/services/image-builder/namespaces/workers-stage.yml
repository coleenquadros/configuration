---
$schema: /openshift/namespace-1.yml

labels: {}

name: workers-stage
description: staging namespace for image-builder

cluster:
  $ref: /openshift/app-sre-stage-01/cluster.yml

app:
  $ref: /services/image-builder/app.yml

environment:
  $ref: /products/osdv4/environments/stage.yml

networkPoliciesAllow:
  - $ref: /services/observability/namespaces/openshift-customer-monitoring.app-sre-stage-01.yml

limitRanges:
  $ref: /dependencies/openshift/limitranges/standard-resource-limits.yml

quota:
  $ref: /services/insights/default-quota.yml

managedRoles: true

managedResourceTypes: []

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/image-builder-stage/account.yml
  resources:
  - provider: secrets-manager
    identifier: azure-service-account
    secret:
      path: app-interface/image-builder/stage/azure-service-account
      version: 1
      field: all
    output_resource_name: azure-service-account
  - provider: secrets-manager
    identifier: gcp-service-account
    secret:
      path: app-interface/image-builder/stage/gcp-service-account
      version: 1
      field: all
    output_resource_name: gcp-service-account
  - provider: secrets-manager
    identifier: image-builder-crc-worker
    secret:
      # equivalent of client-credentials in workers-production.yml
      path: app-interface/image-builder/stage/image-builder-crc-worker
      version: 1
      field: all
    output_resource_name: image-builder-crc-worker
  - provider: secrets-manager
    identifier: subscription-manager-command
    secret:
      path: app-interface/image-builder/stage/subscription-manager-command
      version: 2
      field: all
    output_resource_name: subscription-manager-command
  - provider: cloudwatch
    identifier: workers-aoc-staging
    defaults: /terraform/resources/image-builder/stage/cloudwatch-1.yml
    output_resource_name: workers-aoc-staging
  - provider: aws-iam-role
    identifier: workers-aoc-staging-role
    assume_role:
      Service:
      - ec2.amazonaws.com
    inline_policy:
      {
        Version: "2012-10-17",
        Statement: [
          {
            "Sid": "WorkerReadSecrets",
            "Effect": "Allow",
            "Action": [
              "secretsmanager:GetResourcePolicy",
              "secretsmanager:GetSecretValue",
              "secretsmanager:DescribeSecret",
              "secretsmanager:ListSecretVersionIds"
            ],
            "Resource": [
              "arn:aws:secretsmanager:us-east-1:920877988636:secret:azure-service-account-IF93Wk",
              "arn:aws:secretsmanager:us-east-1:920877988636:secret:gcp-service-account-IF93Wk",
              "arn:aws:secretsmanager:us-east-1:920877988636:secret:image-builder-crc-worker-8EFumn",
              "arn:aws:secretsmanager:us-east-1:920877988636:secret:subscription-manager-command-xFcPpj"
            ]
          },
          {
            "Sid": "BasicCloudWatchUsage",
            "Effect": "Allow",
            "Action": [
              "cloudwatch:PutMetricData",
              "ec2:DescribeVolumes",
              "ec2:DescribeTags",
            ],
            "Resource": "*",
          },
          {
            "Sid": "CloudWatchDescribeLogGroups",
            "Effect": "Allow",
            "Action": [
              "logs:DescribeLogGroups"
            ],
            "Resource": "arn:aws:logs:us-east-1:920877988636:log-group:*",
          },
          {
            "Sid": "CloudWatchDescribeLogStreams",
            "Effect": "Allow",
            "Action": [
              "logs:PutLogEvents",
              "logs:DescribeLogStreams",
              "logs:CreateLogStream",
            ],
            "Resource": "arn:aws:logs:us-east-1:920877988636:log-group:workers-aoc-staging:*",
          },
          {
            "Sid": "VMImportEC2Policy",
            "Effect": "Allow",
            "Action": [
              "ec2:CopySnapshot",
              "ec2:Describe*",
              "ec2:ModifySnapshotAttribute",
              "ec2:DeleteTags",
              "ec2:CreateTags",
              "ec2:RegisterImage",
              "ec2:ImportSnapshot",
              "ec2:ModifyImageAttribute",
              "ec2:DeregisterImage",
              "ec2:DeleteSnapshot",
            ],
            "Resource": "*",
          },
          {
            "Sid": "VMImportS3Policy",
            "Effect": "Allow",
            "Action": [
              "s3:GetBucketLocation",
              "s3:ListBucket",
              "s3:GetObject",
              "s3:PutObject",
              "s3:DeleteObject",
            ],
            "Resource": [
              "arn:aws:s3:::image-builder-service-stage-2",
              "arn:aws:s3:::image-builder-service-stage-2/*",
            ]
          },
          {
            "Sid": "DescribeAutoScalingInstancesPolicy",
            "Effect": "Allow",
            "Action": [
              "autoscaling:DescribeAutoScalingInstances",
            ],
            "Resource": "*"
          },
          {
            "Sid": "SetInstanceProtectionPolicy",
            "Effect": "Allow",
            "Action": [
              "autoscaling:SetInstanceProtection",
            ],
            "Resource": [
              "arn:aws:autoscaling:us-east-1:920877988636:autoScalingGroup:*:autoScalingGroupName/imagebuilder-workers-aoc-x86-staging",
              "arn:aws:autoscaling:us-east-1:920877988636:autoScalingGroup:*:autoScalingGroupName/imagebuilder-workers-aoc-aarch64-staging",
            ]
          },
          {
            "Sid": "CopyImagePolicy",
            "Effect": "Allow",
            "Action": "ec2:CopyImage",
            "Resource": "arn:aws:ec2:*::image/*"
          }
        ]
      }
    output_resource_name: workers-aoc-staging-role
  - provider: aws-iam-role
    identifier: vmimport
    assume_role:
      Service:
      - vmie.amazonaws.com
    assume_condition:
      StringEquals:
        sts:Externalid: vmimport
    inline_policy:
      {
        Version: "2012-10-17",
        Statement: [
          {
            "Sid": "VMImportEC2Policy",
            "Effect": "Allow",
            "Action": [
              "ec2:CopySnapshot",
              "ec2:Describe*",
              "ec2:ModifySnapshotAttribute",
              "ec2:RegisterImage",
            ],
            "Resource": "*",
          },
          {
            "Sid": "VMImportS3Policy",
            "Effect": "Allow",
            "Action": [
              "s3:GetBucketLocation",
              "s3:ListBucket",
              "s3:GetObject",
            ],
            "Resource": [
              "arn:aws:s3:::image-builder-service-stage-2",
              "arn:aws:s3:::image-builder-service-stage-2/*",
            ]
          }
        ]
      }
  - provider: s3
    identifier: image-builder-service-stage-2
    defaults: /terraform/resources/image-builder/stage/s3-2.yml
  - provider: asg
    identifier: imagebuilder-workers-aoc-x86-staging
    defaults: /terraform/resources/image-builder/stage/asg/asg-1.yml
    cloudinit_configs:
    - content: /terraform/resources/image-builder/stage/asg/worker_aoc.cfg
    variables:
      workspace_name: staging
      composer_host_aoc: api.openshift.com
      composer_host_aoc_staging: api.stage.openshift.com
      worker_config_aws_bucket: "image-builder-service-stage-2"
      worker_config_gcp_bucket: "image-upload-bkt-us"
      token_url: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token"
    image:
      - provider: git
        tag_name: composer_commit
        url: https://github.com/osbuild/osbuild-composer
        ref: 72d33c8651e218e0a96990de56b36d413c52b37d
        upstream:
          instance:
            $ref: /dependencies/ci-ext/ci-ext.yml
          name: osbuild-osbuild-composer-gh-build-main-packer
      - provider: static
        tag_name: arch
        value: x86_64
  - provider: asg
    identifier: imagebuilder-workers-aoc-aarch64-staging
    defaults: /terraform/resources/image-builder/stage/asg/asg-aarch64.yml
    cloudinit_configs:
    - content: /terraform/resources/image-builder/stage/asg/worker_aoc.cfg
    variables:
      workspace_name: staging
      composer_host_aoc: api.openshift.com
      composer_host_aoc_staging: api.stage.openshift.com
      worker_config_aws_bucket: "image-builder-service-stage-2"
      worker_config_gcp_bucket: "image-upload-bkt-us"
      token_url: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token"
    image:
      - provider: git
        tag_name: composer_commit
        url: https://github.com/osbuild/osbuild-composer
        ref: 72d33c8651e218e0a96990de56b36d413c52b37d
        upstream:
          instance:
            $ref: /dependencies/ci-ext/ci-ext.yml
          name: osbuild-osbuild-composer-gh-build-main-packer
      - provider: static
        tag_name: arch
        value: aarch64
