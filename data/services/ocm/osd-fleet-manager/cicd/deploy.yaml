---
$schema: /app-sre/saas-file-2.yml
labels:
  service: ocm
name: osd-fleet-manager
description: SaaS file for OSD Fleet Manager
app:
  $ref: /services/ocm/osd-fleet-manager/app.yml
pipelinesProvider:
  $ref: /services/ocm/pipelines/tekton.ocm-pipelines.appsrep05ue1.yaml
slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-uhc-info
managedResourceTypes:
- Deployment
- Service
- ConfigMap
- PodDisruptionBudget

imagePatterns:
- quay.io/app-sre/osd-fleet-manager
- quay.io/app-sre/envoyproxy

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all
resourceTemplates:
#
# - integration, stage and production environments defined below
# - each environment may have 1 or more sector deployments
# - keep the common parameters on the environment level, only sector-specific parameters should be defined on the target level
# - keep the parameters ordered alphabetically
#
- name: osd-fleet-manager-integration
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /templates/named-service-template.yml
  parameters:
    AWS_BASE_DOMAIN: i3.devshift.org
    CLUSTER_CHANNEL: stable
    CLUSTER_EXPIRATION_TIME_DELTA_DAYS: 3650
    CLUSTER_TEMPLATES: |2-
        # HyperShift Service Cluster
        hs-sc:
          name_prefix: "hs-sc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.xlarge
          compute_autoscale: false
          compute_nodes: 3
          network_type: OVNKubernetes
          private: false

        # HyperShift Management Cluster
        hs-mc:
          name_prefix: "hs-mc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.4xlarge
          compute_autoscale: true
          compute_autoscale_min_replicas: 3
          compute_autoscale_max_replicas: 36
          network_type: OVNKubernetes
          private: false
    DEVELOPER_USERS:
    - fleet-manager-debug
    DISABLE_ENABLED_REGION_CHECK: true
    ENABLE_SIMPLE_IDENTITY_PROVIDER: true
    ENVIRONMENT: integration
    EXTERNAL_DNS_DOMAIN_FILTER: i3.devshift.org
    HCP_TELEMETER_URL: https://infogw.api.integration.openshift.com/metrics/v1/receive
    HYPERSHIFT_OPERATOR_OVERRIDING_DATA: |2-
          # openshift/hypershift.git branch release-4.13 commit 139955c0d99e13dc882fa01663457d896aa9f836
          hypershift-operator: quay.io:443/acm-d/hypershift-rhel8-operator@sha256:b7ffc7943f14ef464ea0644bce1e3850928d24ce8c482b70994887a7b04804fd
          apiserver-network-proxy: quay.io:443/acm-d/apiserver-network-proxy-rhel8@sha256:281c31c439d4116a7180519370955254d1845e57fb0c2b9b55a84e4798bec9ce
          aws-encryption-provider: quay.io:443/acm-d/aws-encryption-provider-rhel8@sha256:5c1afc24ccc9ef5c41f78a6561fc43c6f653bc772c752a656f01d8596ffccaa8
          cluster-api: quay.io:443/acm-d/cluster-api-rhel8@sha256:c6edc4a5f6cc09f6ac733350615d8c134993af83e8d07025e3aa4dec596a2488
          cluster-api-provider-agent: quay.io:443/acm-d/cluster-api-provider-agent-rhel8@sha256:7dd4c639450284a8a4893fad89b49183a244deeaf05bc25370446316593a51e3
          cluster-api-provider-aws: quay.io:443/acm-d/cluster-api-provider-aws-rhel8@sha256:1915ed9c08b461fcaefbf9f7933c5c0b805e175698abde1335d3814ebb5e8148
          cluster-api-provider-azure: quay.io:443/acm-d/cluster-api-provider-azure-rhel8@sha256:404bde6e2915b24cf46352d9352128392c50c4efd790845be413982ef5154b43
          cluster-api-provider-kubevirt: quay.io:443/acm-d/cluster-api-provider-kubevirt-rhel8@sha256:8d7f489b7040e2c528e51e46b290074fc161a42cdf3120c2cc0544b3ca97dde9
    MANAGEMENT_CLUSTER_MAX_HOSTED_CLUSTER: '80'
    MANAGEMENT_CLUSTER_HIGH_SATURATION_THRESHOLD: '80'
    OCM_URL: ${OCM_BASE_URL}
    READ_ONLY_USERS:
    - fleet-manager-debug
    REPLICAS: 1
    RHOBS_URL: https://rhobs.rhobsp02ue1.api.openshift.com/api/metrics/v1/hypershift-platform-staging/api/v1/receive
    RHOBS_ENV: int
    SECTOR_ASSIGNMENT_POLICY: |-
      rules:
      # us-east-1 clusters go to the canary sector
      - predicate:
          region: us-east-1
        sector: canary
      # put everything else into the main sector
      - sector: main
    SUPPORTED_CLOUD_PROVIDERS: |-
      - name: aws
        regions:
          - name: us-west-2
    TELEMETER_SERVER_URL: https://infogw.api.integration.openshift.com
  targets:
  - name: osd-fleet-manager-integration-canary
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/integration.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-osd-fleet-manager-gl-build-main
    promotion:
      publish:
      - ocm-osdfm-deployed-int-canary
    parameters:
      DEPLOYMENT_NAME: canary
  - name: osd-fleet-manager-integration-main
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/integration.yml
    ref: 5fb674c69217f60f5955981379cd61e44fd75c7f
    promotion:
      auto: true
      subscribe:
      - ocm-osdfm-deployed-int-canary
      publish:
      - ocm-osdfm-deployed-int-main
      promotion_data:
      - channel: ocm-osdfm-deployed-int-canary
        data:
        - parent_saas: osd-fleet-manager
          target_config_hash: 7912c4b65e5cfc69
          type: parent_saas_config
    parameters:
      DEPLOYMENT_NAME: main
      ENABLE_GLOBAL_WORKERS: true
- name: osd-fleet-manager-stage
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /templates/named-service-template.yml
  parameters:
    AWS_BASE_DOMAIN: s3.devshift.org
    CLUSTER_CHANNEL: stable
    CLUSTER_EXPIRATION_TIME_DELTA_DAYS: 3650
    CLUSTER_TEMPLATES: |2-
        # HyperShift Service Cluster
        hs-sc:
          name_prefix: "hs-sc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.4xlarge
          compute_autoscale: false
          compute_nodes: 3
          network_type: OVNKubernetes
          private: false

        # HyperShift Management Cluster
        hs-mc:
          name_prefix: "hs-mc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.4xlarge
          compute_autoscale: true
          compute_autoscale_min_replicas: 3
          compute_autoscale_max_replicas: 36
          network_type: OVNKubernetes
          private: false
    ENABLE_SIMPLE_IDENTITY_PROVIDER: true
    ENVIRONMENT: stage
    ENABLE_SENTRY: true
    EXTERNAL_DNS_DOMAIN_FILTER: s3.devshift.org
    HCP_TELEMETER_URL: https://infogw.api.stage.openshift.com/metrics/v1/receive
    MANAGEMENT_CLUSTER_MAX_HOSTED_CLUSTER: '80'
    MANAGEMENT_CLUSTER_HIGH_SATURATION_THRESHOLD: '80'
    OCM_URL: ${OCM_BASE_URL}
    READ_ONLY_USERS:
    - fleet-manager-debug
    REPLICAS: 1
    RHOBS_ENV: staging
    RHOBS_URL: https://rhobs.rhobsp02ue1.api.openshift.com/api/metrics/v1/hypershift-platform-staging/api/v1/receive
    SECTOR_ASSIGNMENT_POLICY: |-
      rules:
      # us-east-2 clusters go to the perf sector
      - predicate:
          region: us-east-2
        sector: perf
      # put everything else into the main sector
      - sector: main
    SENTRY_PROJECT: 39
    SENTRY_URL: https://sentry.stage.devshift.net
    SUPPORTED_CLOUD_PROVIDERS: |-
      - name: aws
        regions:
          - name: us-west-2
          - name: us-east-2 # reserved for perf testing
          - name: us-east-1 # reserved for aws outpost integration work
    TELEMETER_SERVER_URL: https://infogw.api.stage.openshift.com
  targets:
  - name: osd-fleet-manager-stage-canary
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/stage.yml
    ref: 32db5bbc0231508b998b7c8d99c590d182b9033b
    promotion:
      auto: true
      subscribe:
      - ocm-osdfm-deployed-int-main
      publish:
      - ocm-osdfm-deployed-stage-canary
      promotion_data:
      - channel: ocm-osdfm-deployed-int-main
        data:
        - parent_saas: osd-fleet-manager
          target_config_hash: 2e29e52ae546ce9c
          type: parent_saas_config
    parameters:
      DEPLOYMENT_NAME: canary
  - name: osd-fleet-manager-stage-perf
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/stage.yml
    ref: 33d68d68d884ac1ba1ca99922c86bef4319bfafb
    promotion:
      publish:
      - ocm-osdfm-deployed-stage-perf
    parameters:
      DEPLOYMENT_NAME: perf
      DATAPLANE_CLUSTER_SCALING_TYPE: manual
  - name: osd-fleet-manager-stage-main
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/stage.yml
    ref: 32db5bbc0231508b998b7c8d99c590d182b9033b
    promotion:
      auto: true
      subscribe:
      - ocm-osdfm-deployed-stage-canary
      publish:
      - ocm-osdfm-deployed-stage-main
      promotion_data:
      - channel: ocm-osdfm-deployed-stage-canary
        data:
        - parent_saas: osd-fleet-manager
          target_config_hash: cbb4ea6b038ee938
          type: parent_saas_config
    parameters:
      DEPLOYMENT_NAME: main
      ENABLE_GLOBAL_WORKERS: true
- name: osd-fleet-manager-production
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /templates/named-service-template.yml
  parameters:
    AWS_BASE_DOMAIN: p3.openshiftapps.com
    CLUSTER_CHANNEL: stable
    CLUSTER_TEMPLATES: |2-
        # HyperShift Service Cluster
        hs-sc:
          name_prefix: "hs-sc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.4xlarge
          compute_autoscale: true
          compute_autoscale_min_replicas: 3
          compute_autoscale_max_replicas: 9
          compute_nodes: 3
          network_type: OVNKubernetes
          private: false

        # HyperShift Management Cluster
        hs-mc:
          name_prefix: "hs-mc-"
          # See /api/clusters_mgmt/v1/versions for list of supported version IDs
          openshift_version: "openshift-v4.12.1"
          multi_az: true
          ccs: true
          compute_machine_type: m5.4xlarge
          compute_autoscale: true
          compute_autoscale_min_replicas: 3
          compute_autoscale_max_replicas: 60
          network_type: OVNKubernetes
          private: false
    ENABLE_SIMPLE_IDENTITY_PROVIDER: true
    ENABLE_SENTRY: false
    ENVIRONMENT: production
    EXTERNAL_DNS_DOMAIN_FILTER: p3.openshiftapps.com
    HCP_TELEMETER_URL: https://infogw.api.openshift.com/metrics/v1/receive
    MANAGEMENT_CLUSTER_MAX_HOSTED_CLUSTER: '40'
    MANAGEMENT_CLUSTER_HIGH_SATURATION_THRESHOLD: '80'
    OCM_URL: ${OCM_BASE_URL}
    READ_ONLY_USERS:
    - fleet-manager-debug
    REPLICAS: 1
    RHOBS_URL: https://rhobs.rhobsp02ue1.api.openshift.com/api/metrics/v1/hypershift-platform/api/v1/receive
    RHOBS_ENV: prod
    SECTOR_ASSIGNMENT_POLICY: |-
      rules:
      # us-east-1 clusters go to the green sector
      - predicate:
          region: us-east-1
        sector: green
      # put everything else into the blue sector
      - sector: blue
    SENTRY_PROJECT: 1028
    SENTRY_URL: https://sentry.devshift.net
    SUPPORTED_CLOUD_PROVIDERS: |-
      - name: aws
        regions:
          - name: us-east-1
          - name: eu-west-1
    TELEMETER_SERVER_URL: https://infogw.api.openshift.com
  targets:
  - name: osd-fleet-manager-production-red
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/production.yml
    ref: 33d68d68d884ac1ba1ca99922c86bef4319bfafb
    promotion:
      publish:
      - ocm-osdfm-deployed-production-red
    parameters:
      DEPLOYMENT_NAME: red
  - name: osd-fleet-manager-production-green
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/production.yml
    ref: 33d68d68d884ac1ba1ca99922c86bef4319bfafb
    promotion:
      auto: true
      subscribe:
      - ocm-osdfm-deployed-production-red
      publish:
      - ocm-osdfm-deployed-production-green
    parameters:
      DEPLOYMENT_NAME: green
  - name: osd-fleet-manager-production-blue
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/production.yml
    ref: 33d68d68d884ac1ba1ca99922c86bef4319bfafb
    promotion:
      auto: true
      subscribe:
      - ocm-osdfm-deployed-production-green
      publish:
      - ocm-osdfm-deployed-production-blue
    parameters:
      DEPLOYMENT_NAME: blue
      ENABLE_GLOBAL_WORKERS: true
- name: osd-fleet-manager-dashboards
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: 11cf225548d95fa904de19b5127ec0ebdb9cfc7c
