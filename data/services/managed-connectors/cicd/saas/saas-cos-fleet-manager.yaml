---
$schema: /app-sre/saas-file-2.yml

labels:
  service: cos-fleet-manager

name: saas-cos-fleet-manager
description: 'SaaS tracking file for COS Fleet Manager'

app:
  $ref: /services/managed-connectors/app.yaml

pipelinesProvider:
  $ref: /services/managed-connectors/pipelines/tekton.cos-fleet-manager-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: rhoc-api-alert

managedResourceTypes:
- Deployment
- Service
- ConfigMap

imagePatterns:
- quay.io/rhoas/cos-fleet-manager
- quay.io/centos/centos
- quay.io/rhoas/envoyproxy
- quay.io/observatorium/token-refresher
- quay.io/rhoas/mk-token-refresher

authentication:
  image:
    path: managed-services/quay-org-accounts/rhoas/robots/rhoas-pull
    field: all

resourceTemplates:
- name: observatorium-token-refresher
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/observatorium-token-refresher.yml
  targets:
    - namespace:
        $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
      ref: main
      parameters:
        ISSUER_URL: ${SSO_BASE_URL}
        OBSERVATORIUM_URL: https://observatorium-mst.api.stage.openshift.com/api/metrics/v1/rhoc
        OBSERVATORIUM_TOKEN_REFRESHER_IMAGE: quay.io/rhoas/mk-token-refresher
        OBSERVATORIUM_TOKEN_REFRESHER_IMAGE_TAG: 0b54d2e
- name: connectors-quota-configuration
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/connectors-quota-configuration.yml
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
- name: cos-fleet-catalog-camel
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/cos-fleet-catalog-camel.yaml
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
- name: cos-fleet-catalog-debezium
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/cos-fleet-catalog-debezium.yaml
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
- name: connector-metadata-camel
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/connector-metadata-camel-template.yaml
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
- name: connector-metadata-debezium
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/connector-metadata-debezium-template.yaml
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
- name: cos-fleet-manager
  url: https://gitlab.cee.redhat.com/mk-ci-cd/cos-fleet-manager
  path: /templates/service-template.yml
  parameters:
    # Global parameter - Affects Production and Stage
    IMAGE_REGISTRY: quay.io
    # Global parameter - Affects Production and Stage
    IMAGE_REPOSITORY: rhoas/cos-fleet-manager
    # Global parameter - Affects Production and Stage
    # SSO_BASE_URL is defined at the environment parameters level
    JWKS_URL: ${SSO_BASE_URL}/protocol/openid-connect/certs
    # Global parameter - Affects Production and Stage
    # Change this to false if you want the users to be able to use the service without accepting any terms
    ENABLE_TERMS_ACCEPTANCE: "true"
    # Global parameter - Affects Production and Stage
    # Change this to false if you want to disable the deny list feature feature
    ENABLE_DENY_LIST: "true"
    # Global parameter - Affects Production and Stage
    # Change this to false to disable sentry
    ENABLE_SENTRY: "false"
    # Global parameter - Affects Production and Stage
    # Image to be used by Envoy sidecar container
    ENVOY_IMAGE: quay.io/rhoas/envoyproxy:v1.16.1
    # Global parameter - Affects Production and Stage
    # Vault secret names prefix
    VAULT_SECRET_PREFIX: "managed-connectors"
  targets:
  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-stage.yaml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: mk-ci-cd-cos-fleet-manager-gl-build-main
    parameters:
      DB_SSLMODE: verify-full
      ENVIRONMENT: stage
      REPLICAS: 3
      MAS_SSO_BASE_URL: https://identity.api.stage.openshift.com
      MAS_SSO_REALM: rhoas
      REDHAT_SSO_BASE_URL: https://sso.redhat.com
      SSO_PROVIDER_TYPE: redhat_sso
      OSD_IDP_MAS_SSO_REALM: rhoas-kafka-sre
      OCM_URL: https://api.openshift.com
      # Log level
      GLOG_V: 10
      # Announces public url to data-plane clients
      SERVICE_PUBLIC_HOST_URL: ${OCM_BASE_URL}

      MAS_SSO_ENABLE_AUTH: "true"
      # Max allowed service accounts created by users
      MAX_ALLOWED_SERVICE_ACCOUNTS: 50
      # Max limit for the fetching the clients from mas-sso
      MAX_LIMIT_FOR_SSO_GET_CLIENTS: 100
      # A list of usernames representing users who do not have access to the service
      DENIED_USERS: []
      # The type of vault to use to store secrets
      VAULT_KIND: "aws"
      # Vault secret names prefix enabled
      VAULT_SECRET_PREFIX_ENABLE: "true"

      # Cluster Organization ID to use for creating evaluation namespaces
      CONNECTOR_EVAL_ORGANIZATIONS: "13888347"
      # Enable support for 'unassigned' state for connectors, false for preview release
      CONNECTOR_ENABLE_UNASSIGNED_CONNECTORS: "false"
      # Namespace evaluation duration in golang duration format
      CONNECTOR_EVAL_DURATION: "48h"
      # Enable connector namespace lifecycle API, disabled for preview release
      CONNECTOR_NAMESPACE_LIFECYCLE_API: "false"
      # Connector configuration quota profile name
      CONNECTORS_EVAL_NAMESPACE_QUOTA_PROFILE: "evaluation-profile"

      # admin endpoins API configuration
      ADMIN_API_SSO_BASE_URL: https://auth.redhat.com
      ADMIN_API_SSO_ENDPOINT_URI: /auth/realms/EmployeeIDP
      ADMIN_API_SSO_REALM: EmployeeIDP
      ADMIN_AUTHZ_CONFIG:
        - method: GET
          roles:
            - "cos-fleet-manager-admin-read-stage"
            - "cos-fleet-manager-admin-write-stage"
            - "cos-fleet-manager-admin-full-stage"
        - method: PATCH
          roles:
            - "cos-fleet-manager-admin-write-stage"
            - "cos-fleet-manager-admin-full-stage"
        - method: PUT
          roles:
            - "cos-fleet-manager-admin-write-stage"
            - "cos-fleet-manager-admin-full-stage"
        - method: POST
          roles:
            - "cos-fleet-manager-admin-full-stage"
        - method: DELETE
          roles:
            - "cos-fleet-manager-admin-full-stage"

  - namespace:
      $ref: /services/managed-connectors/namespaces/managed-connectors-production.yaml
    ref: 39b948c4bbb9a4232f228b477f52477bbc91b2b9
    parameters:
      DB_SSLMODE: verify-full
      ENVIRONMENT: production
      REPLICAS: 6
      MAS_SSO_BASE_URL: https://identity.api.openshift.com
      MAS_SSO_REALM: rhoas
      REDHAT_SSO_BASE_URL: https://sso.redhat.com
      SSO_PROVIDER_TYPE: redhat_sso
      OSD_IDP_MAS_SSO_REALM: rhoas-kafka-sre
      OCM_URL: ${OCM_BASE_URL}
      # Log level
      GLOG_V: 10
      # Announces public url to data-plane clients
      SERVICE_PUBLIC_HOST_URL: ${OCM_BASE_URL}

      MAS_SSO_ENABLE_AUTH: "true"
      # Max allowed service accounts created by users
      MAX_ALLOWED_SERVICE_ACCOUNTS: 50
      # Max limit for the fetching the clients from mas-sso
      MAX_LIMIT_FOR_SSO_GET_CLIENTS: 100
      # A list of usernames representing users who do not have access to the service
      DENIED_USERS: []
      # The type of vault to use to store secrets
      VAULT_KIND: "aws"
      # Vault secret names prefix enabled
      VAULT_SECRET_PREFIX_ENABLE: "true"

      # Cluster Organization ID to use for creating evaluation namespaces
      CONNECTOR_EVAL_ORGANIZATIONS: "13888347"
      # Enable support for 'unassigned' state for connectors, false for preview release
      CONNECTOR_ENABLE_UNASSIGNED_CONNECTORS: "false"
      # Namespace evaluation duration in golang duration format
      CONNECTOR_EVAL_DURATION: "48h"
      # Enable connector namespace lifecycle API, disabled for preview release
      CONNECTOR_NAMESPACE_LIFECYCLE_API: "false"
      # Connector configuration quota profile name
      CONNECTORS_EVAL_NAMESPACE_QUOTA_PROFILE: "evaluation-profile"

      # Connector channels visible in this environment
      CONNECTORS_SUPPORTED_CHANNELS: "stable"

      # admin endpoins API configuration
      ADMIN_API_SSO_BASE_URL: https://auth.redhat.com
      ADMIN_API_SSO_ENDPOINT_URI: /auth/realms/EmployeeIDP
      ADMIN_API_SSO_REALM: EmployeeIDP
      ADMIN_AUTHZ_CONFIG:
        - method: GET
          roles:
            - "cos-fleet-manager-admin-read-prod"
            - "cos-fleet-manager-admin-write-prod"
            - "cos-fleet-manager-admin-full-prod"
        - method: PATCH
          roles:
            - "cos-fleet-manager-admin-write-prod"
            - "cos-fleet-manager-admin-full-prod"
        - method: PUT
          roles:
            - "cos-fleet-manager-admin-write-prod"
            - "cos-fleet-manager-admin-full-prod"
        - method: POST
          roles:
            - "cos-fleet-manager-admin-full-prod"
        - method: DELETE
          roles:
            - "cos-fleet-manager-admin-full-prod"
