---
$schema: /app-sre/slo-document-1.yml

labels:
  service: srs-service-registry

name: srs-service-registry

namespaces:
- $ref: /services/service-registry/namespaces/service-registry-stage.yml
- $ref: /services/service-registry/namespaces/service-registry-production.yml

slos:

# === Service Registry API

# = Availability

- name: Service Registry API (All) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(haproxy_backend_http_responses_total{route="service-registry-bu98",exported_namespace="service-registry-production",code!="5xx"}[{{window}}]))
    /
    sum(rate(haproxy_backend_http_responses_total{route="service-registry-bu98",exported_namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API (Read) Availability 99.95%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (read operations).  This best represents our SLA to RHOSR customers of 99.95% availability of the service.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",method="GET",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",method="GET",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.9995
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API (Write) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (write operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API (Search) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (search operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",path=~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",path=~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API Latency 90%
  SLIType: latency
  SLISpecification: Percentage of the successful service-registry requests served under 100ms
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="0.1",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API read operations Latency 99%
  SLIType: latency
  SLISpecification: Percentage of sufficiently fast requests for fetching content or meta-data of an artifact or artifact version, served under 100ms. This is one of the most basic SLOs for the product and in some way represents the service SLA for customers.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="0.1",status_code_group!~"5xx", method="GET", path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production", method="GET", path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API search operations Latency 99%
  SLIType: latency
  SLISpecification: Percentage of sufficiently fast requests for searching for or listing artifacts or artifact versions, served under 1s
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="1.0" ,status_code_group!~"5xx", path=~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production", path=~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Service Registry API write operations Latency 99%
  SLIType: latency
  SLISpecification: Percentage of sufficiently fast requests for creating, updating, and deleting content for an artifact or artifact version, served under 1s
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="1.0" ,status_code_group!~"5xx", method=~"POST|PUT|DELETE", path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production", method=~"POST|PUT|DELETE", path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Tenant Manager API availability
  SLIType: availability
  SLISpecification: Percentage of tenant-manager requests that are served successfully (status code != 5xx)
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="tenant-manager",namespace="service-registry-production",status_code_group!="5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Tenant Manager API Latency 90%
  SLIType: latency
  SLISpecification: Percentage of the successful tenant-manager requests served under 100ms
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="tenant-manager",namespace="service-registry-production",le="0.1",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

- name: Tenant Manager API Latency 99%
  SLIType: latency
  SLISpecification: Percentage of the successful tenant-manager requests served under 1000ms
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="tenant-manager",namespace="service-registry-production",le="1.0",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-routeName=service-registry-bu98

