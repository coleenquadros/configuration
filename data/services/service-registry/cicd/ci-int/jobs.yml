---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: service-registry

name: ci-int-service-registry-jobs

description: ''

app:
  $ref: /services/service-registry/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

type: jobs

config:
  - project:
      name: multitenant-service-registry
      label: service-registry
      node: managed-services
      gl_group: service-registry
      gl_project: srs-service-registry
      #quay_org: rhoas
      build_deploy_script_path: './build-deploy.sh'
      pr_check_script_path: './pr-check.sh'
      jobs:
        # using global job-template
        # object definition at /resources/jenkins/global/templates.yaml
        - 'gl-pr-check':
            display_name: srs-service-registry pr-check
            concurrent_build: true
            timeout: 60
        # using custom job-template. definition at /resources/jenkins/service-registry/job-templates.yaml
        # builds and pushes images for both srs-service-registry and srs-tenant-manager
        - 'gl-build-master-srs-projects':
            display_name: srs-service-registry build master
            branch: master
        - 'managed-services-security-scan':
            display_name: srs-service-registry security-scan
            branch: master
            ci_cmd: './security-scan.sh'
            cron_expression: 'H 0 * * 1,4'
            slack_channel_notification: service-registry

  - project:
      name: srs-tenant-manager
      label: service-registry
      node: managed-services
      gl_group: service-registry
      gl_project: srs-tenant-manager
      build_deploy_script_path: './build-deploy.sh'
      pr_check_script_path: './pr-check.sh'
      jobs:
        - 'gl-pr-check-srs-tenant-manager':
            display_name: srs-tenant-manager pr-check
            concurrent_build: true
        - 'gl-build-master-srs-projects':
            display_name: srs-tenant-manager build main
            branch: main
        - 'managed-services-security-scan':
            display_name: srs-tenant-manager security-scan
            branch: main
            ci_cmd: './security-scan.sh'
            cron_expression: 'H 0 * * 1,4'
            slack_channel_notification: service-registry

  - project:
      name: srs-fleet-manager
      label: service-registry
      node: managed-services
      gl_group: service-registry
      gl_project: srs-fleet-manager
      #quay_org: rhoas
      build_deploy_script_path: './build-deploy.sh'
      pr_check_script_path: './pr-check.sh'
      jobs:
        - 'gl-pr-check-srs-fleet-manager':
            display_name: srs-fleet-manager pr-check
            concurrent_build: true
        - 'gl-build-master-srs-projects':
            display_name: srs-fleet-manager build master
            branch: master
        - 'managed-services-security-scan':
            display_name: srs-fleet-manager security-scan
            branch: master
            ci_cmd: './security-scan.sh'
            cron_expression: 'H 0 * * 1,4'
            slack_channel_notification: service-registry

  - project:
      name: service-registry-perf-test
      label: service-registry
      node: managed-services
      gh_org: Apicurio
      gh_repo: apicurio-perf
      # quay_org: rhoas
      jobs:
        # build
        - 'gh-build-master-srs-projects':
            display_name: apicurio-perf build main
            branch: main
        - 'gh-pr-check':
            display_name: apicurio-perf pr-check
        # periodic performance tests - e2e
        - 'service-registry-performance-test':
            component: 'service-registry-perf-stage'
            branch: main
            display_name: 'service-registry performance tests'
            timeout: 3600
            slack_channel_notification: service-registry
            cron_expression: 'H 7 * * 2-5' # 7am UTC Tuesday to Friday
            ci_cmd: './perf_test.sh'
        # periodic performance tests - control plane
        - 'service-registry-periodic-test':
            component: 'srs-fleet-manager-perf-stage'
            branch: main
            display_name: 'srs-fleet-manager performance tests'
            timeout: 3600
            slack_channel_notification: service-registry
            cron_expression: 'H 5 * * 2-5' # 5am UTC Tuesday to Friday
            ci_cmd: './cp_perf_test.sh'

  - project:
      name: srs-ui
      label: service-registry
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: srs-ui
      #quay_org: rhoas
      jobs:
        - 'gl-build-master-srs-projects':
            display_name: srs-ui publish-image mk-release
            build_deploy_script_path: './build/publish-image.sh'
            branch: mk-release
