---
$schema: /app-sre/saas-file-2.yml

labels:
  service: quayio

name: quayio-utils
description: quayio utilities

app:
  $ref: /services/quayio/app.yml

pipelinesProvider:
  $ref: /services/quayio/pipelines/tekton.quayio-pipelines.app-sre-prod-01.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: oncall-quay

managedResourceTypes:
- Deployment
- Service
- ServiceAccount
- Role
- RoleBinding
- Job

imagePatterns:
- quay.io/app-sre/quayio-update-banner-job
- quay.io/app-sre/flush-redis
- quay.io/app-sre/quay
- quay.io/app-sre/syslog-cloudwatch-bridge

parameters:
  IMAGE: "quay.io/app-sre/quayio-update-banner-job"

resourceTemplates:
- name: quayio-update-banner-job
  path: /openshift.yml
  url: https://github.com/quay/update-banner-job
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: f1491c0657ae75aab55d4ea7faec1e82393dc9af
    parameters:
      JOB_NAME: "2021-06-24-sso-banner-update-1" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-rds"
      DB_CREDS_SECRET: "quayio-stage-57-rds"
      MESSAGE: "On August 1st 2021, Quay.io will transition to Red Hat Single Sign-On Services exclusively. You need to link your Quay.io login to a redhat.com account by this date, in order to be able to login to the web interface. CLI tokens and robot accounts are not impacted. Read more about this change in the [FAQ.](https://access.redhat.com/articles/5925591)"
      SEVERITY: "info"
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: f1491c0657ae75aab55d4ea7faec1e82393dc9af
    parameters:
      JOB_NAME: "2021-07-20-sso-banner-update-1" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quay-db-config-secret"
      MESSAGE: "On August 1st 2021, Quay.io will transition to Red Hat Single Sign-On Services exclusively. You need to link your Quay.io login to a redhat.com account by this date, in order to be able to login to the web interface. CLI tokens and robot accounts are not impacted. Read more about this change in the [FAQ](https://access.redhat.com/articles/5925591)."
      SEVERITY: "warning"
- name: flush-redis
  path: /openshift.yml
  url: https://github.com/app-sre/flush-redis
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: b01dcb1e602a909604244eb147a6958978ea7ecd
    parameters:
      JOB_NAME: "2021-04-13" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      REDIS_SECRET: "quayio-stage-elasticache"
      IMAGE: "quay.io/app-sre/flush-redis"
  # ONLY RUN IT ON ONE PROD CLUSTER
  # UNCOMMENT WHEN YOU NEED THIS JOB TO RUN.
  # ONCE UNCOMMENTED IT CAN BE LEFT UNCOMMENTED
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: b01dcb1e602a909604244eb147a6958978ea7ecd
    parameters:
      ACTIVE_DEADLINE_SECONDS: "600"
      REDIS_SECRET: "quayio-elasticache"
      IMAGE: "quay.io/app-sre/flush-redis"
      JOB_NAME: "flush-redis-prod-2021-07-23"

- name: quayio-recovery-endpoint
  path: /deploy/openshift/quay-recovery-endpoint.yaml
  url: https://github.com/quay/quay
  parameters:
    IMAGE: quay.io/app-sre/quay
    IMAGE_TAG: 0af8900
    QUAY_ENTRYPOINT: registry
    QUAY_APP_DEPLOYMENT_REPLICAS: 1
    QUAY_APP_CPU_REQUEST: 1
    QUAY_APP_CPU_LIMIT: 5
    QUAY_APP_MEMORY_REQUEST: 4Gi
    QUAY_APP_MEMORY_LIMIT: 24Gi
    QUAY_APP_DEPLOYMENT_PROGRESS_DEADLINE_SECONDS: 1800
    QUAY_APP_DEPLOYMENT_MAX_SURGE: 1
    QUAY_APP_READINESS_PROBE_TIMEOUT_SECONDS: 20
    QUAY_APP_LIVENESS_PROBE_TIMEOUT_SECONDS: 20
    QUAY_APP_LIVENESS_PROBE_PERIOD_SECONDS: 15
    QUAY_APP_DEPLOYMENT_NAMESPACE: quay
    QUAY_APP_COMPONENT_LABEL_VALUE: app-recovery
    QUAY_APP_CONFIG_SECRET: quay-config-recovery-secret
    DEBUGLOG: "true"
    QUAY_APP_COMPONENT_ANNOTATIONS_VALUE: "update_me_when_secret_changes_v2"
    QUAY_WORKER_MULTIPLIER_REGISTRY: 1
    QUAY_WORKER_CONNECTION_COUNT_REGISTRY: 80
    SYSLOG_IMAGE: quay.io/app-sre/syslog-cloudwatch-bridge
    SYSLOG_IMAGE_TAG: c19d7d1
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: a07b2c9c7cf9ddac9c79ba7f1023b4fcc013327b
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: a07b2c9c7cf9ddac9c79ba7f1023b4fcc013327b
