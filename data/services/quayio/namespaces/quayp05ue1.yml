---
$schema: /openshift/namespace-1.yml

labels:
  service: quayio

name: quay
description: prod namespace for quayio

cluster:
  $ref: /openshift/quayp05ue1/cluster.yml

app:
  $ref: /services/quayio/app.yml

environment:
  $ref: /products/quay/environments/production.yml

networkPoliciesAllow:
- $ref: /services/observability/namespaces/openshift-customer-monitoring.quayp05ue1.yml

managedRoles: true

sharedResources:
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml

managedResourceTypes:
- NetworkPolicy
- Secret
- ServiceAccount

openshiftResources:
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: false
    name: quay-config-secret-readonly
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  path: /services/common/serviceaccount.yaml
  variables:
    name: quay-db-jobs-sa

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-py3-config-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret-blue
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-recovery-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: true
    read_from_rds_replica: false
    enable_clair: false
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret-readonly-replica
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: true
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-clair-backfill-config.secret.yaml
  variables:
    recycle: true
    name: quay-clair-backfill-config-secret
    vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-service-tool-config.secret.yaml
  variables:
    name: quay-service-tool-config
    vault_secret_version: 1
    db_jobs_vault_secret_version: 1
    additional_config_vault_secret_version: 2

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-config.secret.yaml
  variables:
    standby: false
    additional_config_vault_secret_version: 2
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-1/quay/quay-extra-ca-certs
  version: 1
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-1/quay/quay-cloudwatch-iam-user
  version: 2
# ECR image pull secret
- provider: vault-secret
  path: app-sre/integrations-output/aws-ecr-image-pull-secrets/quayio-prod/eu-central-1/dockercfg
  version: 1
  type: kubernetes.io/dockerconfigjson
  name: quayio-backup-image-pull-secret
  annotations:
    qontract.ignore_reconcile_time: "true"
- provider: resource
  path: /quay-p/quay/quay.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quay-p/quay/quay-recovery.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quay-p/quay/quay-py3.web-allow-external.networkpolicy.yaml
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-jobs-config.secret.yaml
  variables:
    name: quay-db-jobs-prod-config
    vault_secret_version: 1
- provider: route
  path: /quay-p/quay/quay-service-tool.route.yaml
  vault_tls_secret_path: app-interface/quayio-prod-us-east-1/quay/service-tool-config-secret
  vault_tls_secret_version: 4


managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/quayio-prod/account.yml
  resources:
  - provider: rds
    identifier: quayio-production-py3
    availability_zone: us-east-1a
    defaults: /terraform/resources/quayio-production/rds-1.yml
    parameter_group: /terraform/resources/quayio-production/rds-parameter-group-readwrite-replica-1.yml
    overrides:
      apply_immediately: true
  - provider: elasticache
    identifier: quayio-production
    defaults: /terraform/resources/quayio-production/elasticache-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-parameter-group-1.yml
    output_resource_name: quayio-elasticache
  - provider: elasticache
    identifier: quayio-production-builders
    defaults: /terraform/resources/quayio-production/elasticache-builders-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-builders-parameter-group-1.yml
  - provider: elasticache
    identifier: quayio-production-modelcache
    defaults: /terraform/resources/quayio-production/elasticache-modelcache-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-modelcache-parameter-group-1.yml
    output_resource_name: quayio-production-modelcache
  - provider: s3-cloudfront
    identifier: quayio-production-s3
    storage_class: intelligent_tiering
    defaults: /terraform/resources/quayio-production/s3-cloudfront-us-east-1.yml
    output_resource_name: quayio-s3
  - provider: ecr
    region: eu-central-1
    identifier: quayio-backup
    output_resource_name: quayio-backup
  - provider: ecr
    region: eu-central-1
    identifier: quayio-py3-backup
    output_resource_name: quayio-py3-backup
  - provider: ecr
    region: eu-central-1
    identifier: syslog-cloudwatch-bridge-backup
    output_resource_name: syslog-cloudwatch-bridge-backup
  - provider: kinesis
    identifier: quay-prod-logentry-stream
    defaults: /terraform/resources/quayio-production/kinesis-1.yml
    output_resource_name: quayio-kinesis
# used in the quay-config secret HEALTH_CHECKER
  - provider: aws-iam-service-account
    identifier: quay-db-monitor
    policies:
    - AmazonRDSReadOnlyAccess
    output_resource_name: quay-db-monitor
  - provider: ecr
    region: eu-central-1
    identifier: quayio-update-py2-db-backup
    output_resource_name: quayio-update-py2-db-backup
  - provider: rds
    identifier: clair-backfiller
    defaults: /terraform/resources/quayio-production/rds-1.yml
    overrides:
      snapshot_identifier: rds:quayio-production-py3-2021-11-16-04-13
      instance_class: db.r4.4xlarge
      backup_retention_period: 0
      timeouts:
        create: 2h
    parameter_group: /terraform/resources/quayio-production/rds-parameter-group-1.yml
    output_resource_name: clair-backfiller
    enhanced_monitoring: true
  - provider: alb
    identifier: quayio-production-alb01
    output_resource_name: quayio-production-alb
    idle_timeout: 3600
    vpc:
      $ref: /aws/quayio-prod/vpcs/QuayVPC.yml
    certificate_arn: arn:aws:acm:us-east-1:206170669542:certificate/8a4a9a8b-d06b-46f6-a234-e7ef2ec657cf
    targets:
    - name: quayio-production-py2
      default: false
      openshift_service: quay-load-balancer-service
    - name: quayio-production-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    rules: []
