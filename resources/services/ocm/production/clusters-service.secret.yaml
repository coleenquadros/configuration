apiVersion: v1
kind: Secret
metadata:
  name: clusters-service
  labels:
    secret.version: "v15"
  annotations:
    qontract.recycle: "true"
data:
  api-connection.yaml:
    {{% b64encode %}}
    url: https://api.openshift.com
    client_id: !!binary {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'client.id', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
    client_secret: !!binary {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'client.secret', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
    token_url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
    trusted_cas:
    - /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
    {{% endb64encode %}}
  provision_shards_mapping.config:
    {{% b64encode %}}
    provision_shards_mapping:
    {{%- for shard in shards %}}
    {{%- for cloud_provider in shard.cloud_providers %}}
    - id: {{{ shard.id }}}
      cloud_provider_id: {{{ cloud_provider.id }}}
      region_id: {{{ cloud_provider.region_id }}}
    {{%- endfor %}}
    {{%- endfor %}}
    {{% endb64encode %}}
  provision_shards.config:
    {{% b64encode %}}
    provision_shards:
    {{%- for shard in shards %}}
    {{%- if current_hive_cluster.update({'name': shard.hive_cluster_name}) %}}{{%- endif %}}
    - id: {{{ shard.id }}}
      hive_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:hive:hive-frontend/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:hive:hive-frontend
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:hive:hive-frontend
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:hive:hive-frontend/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-hive-hive-frontend', 'token') }}}
      aws_account_operator_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:aws-account-operator:aws-account-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:aws-account-operator:aws-account-operator-client
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:aws-account-operator:aws-account-operator-client
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:aws-account-operator:aws-account-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-aws-account-operator-aws-account-operator-client', 'token') }}}
      gcp_project_operator_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:gcp-project-operator:gcp-project-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:gcp-project-operator:gcp-project-operator-client
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:gcp-project-operator:gcp-project-operator-client
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:gcp-project-operator:gcp-project-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-gcp-project-operator-gcp-project-operator-client', 'token') }}}
      aws_base_domain: p1.openshiftapps.com
      gcp_base_domain: p2.openshiftapps.com
    {{%- endfor %}}
    {{% endb64encode %}}
  client.id:
    {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'client.id', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
  client.secret:
    {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'client.secret', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
  sentry.dsn:
    {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'sentry.dsn', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
  telemeter.bearer:
    {{% b64encode %}}{{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/telemeter-prod-01-telemeter-production-uhc-prometheus-access', 'token') }}}{{% endb64encode %}}
  telemeter.url:
    {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'telemeter.url', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
  analytics.integration_key:
    {{% b64encode %}}{{{ vault('app-interface/app-sre/uhc-production/clusters-service', 'analytics.integration_key', '{{ vault_secret_version }}') }}}{{% endb64encode %}}
