apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: push-deploy-event-to-db
spec:
  params:
    - name: env_name
      type: string
    - name: app_name
      type: string
    - name: task_status
      type: string
    - name: trigger_integration
      type: string
    - name: trigger_reason
      type: string
  steps:
    - env:
        - name: PGHOST
          valueFrom:
            secretKeyRef:
              name: deploy-events-db
              key: db.host
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: deploy-events-db
              key: db.user
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: deploy-events-db
              key: db.password
        - name: PGPORT
          valueFrom:
            secretKeyRef:
              name: deploy-events-db
              key: db.port
        - name: PGDATABASE
          valueFrom:
            secretKeyRef:
              name: deploy-events-db
              key: db.name
        - name: trigger_reason
          value: $(params.trigger_reason)
        - name: trigger_integration
          value: $(params.trigger_integration)
      image: 'registry.redhat.io/rhel8/postgresql-13:1-72'
      name: push-deploy-event-to-db
      resources:
        limits:
          cpu: 20m
          memory: 30Mi
        requests:
          cpu: 20m
          memory: 30Mi
      script: |
        #!/usr/bin/env bash
        echo "Pushing deploy event to DB"
        task_status="NULL"
        if [ "$(params.task_status)" = "Succeeded" ]; then
          task_status="true"
        elif [ "$(params.task_status)" = "Failed" ]; then
          task_status="false"
        fi
        echo "Storing deploy event for app: $(params.app_name), env: $(params.env_name), status: $task_status, time: $(date -u), trigger_reason: $(params.trigger_reason), trigger_integration: $(params.trigger_integration)"
        psql -c "insert into deployments(deployment_time, succeeded, app_name, env_name, trigger_reason, trigger_integration) values(now(), $task_status, '$(params.app_name)', '$(params.env_name)', '$(params.trigger_reason)', '$(params.trigger_integration)')"

