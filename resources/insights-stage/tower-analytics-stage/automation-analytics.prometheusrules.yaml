---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tower-analytics-stage
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  - name: automation-analytics-up-stage
    rules:
    - alert: AutomationAnalyticsDataExporterServiceAbsent
      expr: absent(up{service=~"automation-analytics-data-exporter.*", namespace="tower-analytics-stage"})
      for: 2m
      labels:
        severity: medium
        service: insights
        env: prod
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. All Data Exporter pods have been down for two minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsDataExporterServiceAbsent.rst"

    - alert: AutomationAnalyticsProcessorServiceAbsent
      expr: absent(up{service=~"automation-analytics-processor-controller.*", namespace="tower-analytics-stage"})
      for: 2m
      labels:
        severity: high
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. All Processor pods have been down for two minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsProcessorServiceAbsent.rst"

    - alert: AutomationAnalyticsFastAPIServiceAbsent
      expr: absent(up{service=~"automation-analytics-api-fastapi.*", namespace="tower-analytics-stage"})
      for: 2m
      labels:
        severity: high
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. All FastAPI pods have been down for two minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsFastAPIServiceAbsent.rst"

    - alert: AutomationAnalyticsRollupServiceAbsent
      expr: absent(up{service=~"automation-analytics-rollups.*", namespace="tower-analytics-stage"})
      for: 2m
      labels:
        severity: high
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. All Rollup pods have been down for two minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRollupServiceAbsent.rst"

  - name: automation-analytics-restarts-stage
    rules:
    - alert: AutomationAnalyticsFastApiRestarts
      expr: round(sum(increase(kube_pod_container_status_restarts_total{container="automation-analytics-api-fastapi-v2", namespace="tower-analytics-stage"}[30m]))) > 5
      for: 1h
      labels:
        severity: info
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments/automation-analytics-api-fastapi-v2/pods"
        message: "Automation Analytics Alert. Pod was restarted more than 5 times in 30 minutes for the last 1 hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRestarts.rst"

    - alert: AutomationAnalyticsProcessorRestarts
      expr: round(sum(increase(kube_pod_container_status_restarts_total{container="automation-analytics-processor-controller-v1", namespace="tower-analytics-stage"}[30m]))) > 5
      for: 1h
      labels:
        severity: info
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments/automation-analytics-processor-v2/pods"
        message: "Automation Analytics Alert. Pod was restarted more than 5 times in 30 minutes for the last 1 hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRestarts.rst"

    - alert: AutomationAnalyticsRollupsRestarts
      expr: round(sum(increase(kube_pod_container_status_restarts_total{container="automation-analytics-rollups-v2", namespace="tower-analytics-stage"}[30m]))) > 5
      for: 1h
      labels:
        severity: info
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments/automation-analytics-rollups-v2/pods"
        message: "Automation Analytics Alert. Pod was restarted more than 5 times in 30 minutes for the last 1 hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRestarts.rst"

    - alert: AutomationAnalyticsDataExporterRestarts
      expr: round(sum(increase(kube_pod_container_status_restarts_total{container="automation-analytics-data-exporter", namespace="tower-analytics-stage"}[30m]))) > 5
      for: 1h
      labels:
        severity: info
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments/automation-analytics-data-exporter/pods"
        message: "Automation Analytics Alert. Pod was restarted more than 5 times in 30 minutes for the last 1 hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRestarts.rst"

  - name: automation-analytics-api-stage
    rules:
    - alert: AutomationAnalyticsApiResponse5xx
      expr: sum(rate(api_3scale_gateway_api_status{exported_service="tower-analytics",status="5xx"}[5m])) > 0
      for: 5m
      labels:
        severity: medium
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. FastAPI 5xx responses observed in the last 5 minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsApiResponse5xx.rst"

  - name: automation-analytics-rollups-stage
    rules:
    - alert: AutomationAnalyticsRollupsErrors
      expr: sum(rate(ta_rollup_processor_exception_total{namespace=~"tower-analytics-stage", pod=~"automation-analytics-rollups-.*"}[5m])) > 0
      for: 5m
      labels:
        severity: medium
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. Rollups processing errors observed in the last 5 minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsRollupsErrors.rst"

  - name: automation-analytics-processor-stage
    rules:
    - alert: AutomationAnalyticsProcessorErrors
      expr: sum(increase(ta_processor_exception_total{namespace=~"tower-analytics-stage", pod=~"automation-analytics-processor.*"}[1h])) > 15
      for: 5m
      labels:
        severity: medium
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. More than 15 Processor errors observed in the last hour."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsProcessorErrors.rst"

    - alert: AutomationAnalyticsProcessorStoppedProcessing
      expr: sum(increase(ta_processor_message_processed_total{namespace=~"tower-analytics-stage", pod=~"automation-analytics-processor.*"}[6h])) < 1
      for: 5m
      labels:
        severity: medium
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. Processor has too low processing rate, less than 1 payload was processed for more than past 6 hours"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsProcessorStoppedProcessing.rst"

    - alert: AutomationAnalyticsIngressRefusingPayloads
      expr: sum(increase(ingress_responses{useragent=~"(Red Hat Ansible Tower.*)|(Red Hat Ansible Automation Platform.*)|(AWX.*)", code="202"}[6h])) < 1
      for: 5m
      labels:
        severity: medium
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/tower-analytics-stage/deployments"
        message: "Automation Analytics Alert. Ingress is refusing payloads from Tower, less than 1 was accepted with code 202 for more than past 6 hours"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsIngressRefusingPayloads.rst"

    - alert: AutomationAnalyticsProcessorKafkaLag
      expr: sum(kafka_consumergroup_group_lag {topic="platform.upload.tower", group="processor-stage"}) > 100
      for: 10m
      labels:
        severity: info
        service: insights
        env: stage
        app_team: automation-analytics
      annotations:
        dashboard: "https://grafana.stage.devshift.net/d/81Du_aIHdf/automation-analytics?var-Datasource=crcs02ue1-prometheus&var-DatasourceRDS=app-sre-stage-01-prometheus&var-namespace=tower-analytics-stage&var-granularity=daily&var-granularity=monthly&var-granularity=yearly&var-realtime_rollup_series=ta_rollup_processor_rollup_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_event_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_host_explorer_rollup_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_failed_steps_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_jobs_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflow_hierarchy_time_bucket&var-realtime_rollup_series=ta_rollup_processor_rollup_job_explorer_rollup_workflows_time_bucket&var-granularity_rollups=job_explorer&var-granularity_rollups=event_explorer&var-granularity_rollups=host_explorer&var-processor_tables=analytics_bundle&var-processor_tables=events_table&var-processor_tables=unified_jobs"
        link_url: "https://kibana.apps.crcs02ue1.urby.p1.openshiftapps.com/app/kibana#/dashboard/c378da30-5c92-11eb-bad1-cf638f17b353?_a=(description:'',filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:levelname,negate:!f,params:(query:ERROR),type:phrase),query:(match_phrase:(levelname:ERROR))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:levelname,negate:!t,params:!(INFO,DEBUG),type:phrases,value:'INFO,%20DEBUG'),query:(bool:(minimum_should_match:1,should:!((match_phrase:(levelname:INFO)),(match_phrase:(levelname:DEBUG)))))),('$state':(store:appState),meta:(alias:'Message%20Recovery',disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:source_host,negate:!t,params:!('*automation-analytics-message-recover*','*automation-analytics-bundle-recovery*'),type:phrases,value:'*automation-analytics-message-recover*,%20*automation-analytics-bundle-recovery*'),query:(bool:(minimum_should_match:1,should:!((match_phrase:(source_host:'*automation-analytics-message-recover*')),(match_phrase:(source_host:'*automation-analytics-bundle-recovery*')))))),('$state':(store:appState),meta:(alias:FastAPI,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:source_host,negate:!t,params:(query:'*automation-analytics-api-fastapi*'),type:phrase),query:(match_phrase:(source_host:'*automation-analytics-api-fastapi*'))),('$state':(store:appState),meta:(alias:Processor,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:source_host,negate:!f,params:(query:'automation-analytics-processor*'),type:phrase),query:(match_phrase:(source_host:'automation-analytics-processor*'))),('$state':(store:appState),meta:(alias:Rollups,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:source_host,negate:!t,params:(query:'automation-analytics-rollups*'),type:phrase),query:(match_phrase:(source_host:'automation-analytics-rollups*'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:levelname,negate:!f,params:(query:WARNING),type:phrase),query:(match_phrase:(levelname:WARNING))),('$state':(store:appState),meta:(alias:'Red%20Hat%20accounts',disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:tenant,negate:!t,params:!('5318290','11009103','6340056','11789772','1979710','12817815','11971228','12369592'),type:phrases,value:'5,318,290,%2011,009,103,%206,340,056,%2011,789,772,%201,979,710,%2012,817,815,%2011,971,228,%2012,369,592'),query:(bool:(minimum_should_match:1,should:!((match_phrase:(tenant:'5318290')),(match_phrase:(tenant:'11009103')),(match_phrase:(tenant:'6340056')),(match_phrase:(tenant:'11789772')),(match_phrase:(tenant:'1979710')),(match_phrase:(tenant:'12817815')),(match_phrase:(tenant:'11971228')),(match_phrase:(tenant:'12369592')))))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:elapsed,negate:!f,params:(gte:30,lt:100),type:range),range:(elapsed:(gte:30,lt:100))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:exception,negate:!t,params:(query:'*sqlalchemy.exc.OperationalError:%20(psycopg2.errors.QueryCanceled)%20canceling%20statement%20due%20to%20statement%20timeout*'),type:phrase),query:(match_phrase:(exception:'*sqlalchemy.exc.OperationalError:%20(psycopg2.errors.QueryCanceled)%20canceling%20statement%20due%20to%20statement%20timeout*'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:'@message',negate:!t,params:(query:'%5BProcessor%5D%20Processing%20error:%20%5BErrno%202%5D%20No%20such%20file*'),type:phrase),query:(match_phrase:('@message':'%5BProcessor%5D%20Processing%20error:%20%5BErrno%202%5D%20No%20such%20file*'))),('$state':(store:appState),meta:(alias:!n,disabled:!t,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:message,negate:!f,params:(query:'%5BRBAC%5D%20RBAC%20Service%20call%20failure*'),type:phrase),query:(match_phrase:(message:'%5BRBAC%5D%20RBAC%20Service%20call%20failure*'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:'@message',negate:!t,params:(query:'Processing%20error:%20Error%20-3*'),type:phrase),query:(match_phrase:('@message':'Processing%20error:%20Error%20-3*'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:'@message',negate:!t,params:(query:'%5BProcessor%5D%20Processing%20error:%20Compressed%20file%20ended%20before%20the%20end-of-stream%20marker%20was%20reached'),type:phrase),query:(match_phrase:('@message':'%5BProcessor%5D%20Processing%20error:%20Compressed%20file%20ended%20before%20the%20end-of-stream%20marker%20was%20reached'))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:ffb9f2a0-5408-11eb-bad1-cf638f17b353,key:message.keyword,negate:!t,params:(query:'%5BProcessor%5D%20TAR%20archive%20error:%20file%20could%20not%20be%20opened%20successfully'),type:phrase),query:(match_phrase:(message.keyword:'%5BProcessor%5D%20TAR%20archive%20error:%20file%20could%20not%20be%20opened%20successfully')))),fullScreenMode:!f,options:(hidePanelTitles:!f,useMargins:!t),panels:!((embeddableConfig:(),gridData:(h:7,i:'41a415bd-3fbf-4af9-9e26-169807ceb4c0',w:48,x:0,y:0),id:a9478380-5c99-11eb-bad1-cf638f17b353,panelIndex:'41a415bd-3fbf-4af9-9e26-169807ceb4c0',type:visualization,version:'7.7.1'),(embeddableConfig:(),gridData:(h:15,i:ab8fcc36-f628-495f-9fee-2756275b03b9,w:11,x:0,y:7),id:'9d443b00-540b-11eb-bad1-cf638f17b353',panelIndex:ab8fcc36-f628-495f-9fee-2756275b03b9,type:visualization,version:'7.7.1'),(embeddableConfig:(),gridData:(h:15,i:'8fec71f1-a79f-49f3-be7f-ef82b1b9848e',w:10,x:11,y:7),id:'78898710-5c9a-11eb-bad1-cf638f17b353',panelIndex:'8fec71f1-a79f-49f3-be7f-ef82b1b9848e',type:visualization,version:'7.7.1'),(embeddableConfig:(table:!n,vis:(params:(sort:(columnIndex:1,direction:desc)))),gridData:(h:15,i:a278e299-a2f3-423e-b844-2f8ef0e0e68c,w:7,x:21,y:7),id:b3df3cd0-540a-11eb-bad1-cf638f17b353,panelIndex:a278e299-a2f3-423e-b844-2f8ef0e0e68c,type:visualization,version:'7.7.1'),(embeddableConfig:(),gridData:(h:15,i:'1fd74f16-1253-4f31-a636-d2c7bbc643fc',w:10,x:28,y:7),id:bc3eb200-5c95-11eb-bad1-cf638f17b353,panelIndex:'1fd74f16-1253-4f31-a636-d2c7bbc643fc',type:visualization,version:'7.7.1'),(embeddableConfig:(),gridData:(h:15,i:'984fc0df-c412-4385-a206-faa458427654',w:10,x:38,y:7),id:'4e919390-c43b-11eb-8c9c-c3e62251cf3b',panelIndex:'984fc0df-c412-4385-a206-faa458427654',type:visualization,version:'7.7.1'),(embeddableConfig:(columns:!(source_host,levelname,tenant,message,exception,tower_version,tower_license_type)),gridData:(h:39,i:'5ccbc380-0874-49c0-9894-4b098d97cfac',w:48,x:0,y:22),id:'3071ea30-5c90-11eb-bad1-cf638f17b353',panelIndex:'5ccbc380-0874-49c0-9894-4b098d97cfac',type:search,version:'7.7.1')),query:(language:kuery,query:''),timeRestore:!t,title:'Tower%20Analytics%20error%20dashboard',viewMode:view)&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-24h,to:now))"
        message: "Automation Analytics Alert. Kafka lag on platform.upload.tower reched {{ $value }} (limit is 100) for the last 10 minutes"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/tower-analytics/AutomationAnalyticsProcessorKafkaLag.rst"
