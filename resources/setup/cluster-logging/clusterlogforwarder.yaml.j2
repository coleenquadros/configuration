---
apiVersion: logging.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: instance
  namespace: openshift-logging
spec:
  {% if RHOBS_TOOLS_LOGGING | default(false) %}
  inputs:
    - application:
        selector:
          matchLabels:
            app.kubernetes.io/part-of: observatorium
      name: send-observatorium-app-logs
  {% endif %}
  outputs:
  - cloudwatch:
      groupBy: namespaceName
      groupPrefix: {{ resource.namespace.cluster.name }}
      region: {{ REGION | default(resource.namespace.cluster.spec.region) }}
    name: cloudwatch
    secret:
      name: {{ AWS_SECRET_NAME | default("app-sre-logs-cloudwatch-access") }}
    type: cloudwatch
  {% if RHOBS_LOGGING | default(false) %}
  - name: rhobs
    type: loki
    url: {{ RHOBS_URL | default("http://clo-token-refresher.openshift-logging.svc.cluster.local") }}
  {% endif %}
  {% if RHOBS_TOOLS_LOGGING | default(false) %}
  - name: loki-app
    secret:
      name: {{ RHOBS_TOOLS_LOKI_SECRET_NAME | default("lokistack-gateway-bearer-token") }}
    type: loki
    url: >-
      {{ RHOBS_TOOLS_LOKI_URL | default("https://observatorium-lokistack-gateway-http.observatorium-tools.svc:8080/api/logs/v1/application") }}
  {% endif %}
  pipelines:
  - name: app-logs
    inputRefs:
    - application
    outputRefs:
    - cloudwatch
    {% if RHOBS_LOGGING | default(false) %}
    - rhobs
    {% endif %}
    detectMultilineErrors: true
  {% if RHOBS_TOOLS_LOGGING | default(false) %}
  - name: observatorium-app-logs
    inputRefs:
    - send-observatorium-app-logs
    outputRefs:
    - loki-app
  {% endif %}
