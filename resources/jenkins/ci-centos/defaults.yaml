- defaults:
    name: global
    timeout: '15m'
    jobdescription: "Managed by Jenkins Job Builder, do not edit manually! Update via https://gitlab.cee.redhat.com/service/app-interface"
    git_organization: fabric8-services
    github_user: almighty-bot
    github_hooks: true
    branch: master
    discarder_days: -1
    discarder_num: -1
    build_branch: master
    manifest_bouncer_tag: d21c96f
    trigger_phrase: '.*\[test\].*'
    che-success-message: ""
    che-failure-message: ""
    che-error-message: ""
    kubeconfver: none
    sa_name: app-sre-bot

- admin_list_defaults: &admin_list_defaults
    name: 'admin_list_defaults'
    admin-list:
        - aditya-konarde
        - akurinnoy
        - alexeykazakov
        - amisevsk
        - andrewazores
        - aptmac
        - ashumilova
        - aslakknutsen
        - baijum
        - bartoszmajsak
        - chmouel
        - chrislessard
        - christianvogt
        - davidfestal
        - deepak1725
        - dgutride
        - DhritiShikhar
        - dlabrecq
        - dmytro-ndp
        - ebaron
        - edewit
        - evidolob
        - fabric8cd
        - fche
        - gastaldi
        - ia3andy
        - ibuziuk
        - inoxx03
        - invincibleJai
        - jfchevrette
        - jiekang
        - jmelis
        - joshuawilson
        - Katka92
        - kbsingh
        - khrm
        - l0rd
        - ldimaggi
        - ljelinkova
        - maorfr
        - mathur07
        - MatousJobanek
        - maxandersen
        - michaelkleinhenz
        - msrb
        - neugens
        - nimishamukherjee
        - pbergene
        - piyush-garg
        - pmacik
        - ppitonak
        - Preeticp
        - quintesse
        - RhCheGithubBot
        - rhopp
        - rkratky
        - rohitkrai03
        - rohanKanojia
        - rupalibehera
        - sahil143
        - sanketpathak
        - sawood14012
        - sbose78
        - sbryzak
        - ScrewTSW
        - skabashnyuk
        - skryzhny
        - sthaha
        - stooke
        - tisnik
        - tradej
        - tsmaeder
        - vikram-raj
        - vparfonov
        - xcoulon
        - yzainee
        - dgpatelgit
        - jparsai
        - rafiu007

- che_admin_list_defaults: &che_admin_list_defaults
    name: 'che_admin_list_defaults'
    admin-list:
        - akurinnoy
        - amisevsk
        - AndrienkoAleksandr
        - apupier
        - artaleks9
        - ashumilova
        - azatsarynnyy
        - benoitf
        - boczkowska
        - davidfestal
        - dmytro-ndp
        - dneary
        - ericwill
        - evidolob
        - flacatus
        - gazarenkov
        - gorkem
        - ibuziuk
        - JPinkney
        - Katka92
        - l0rd
        - metlos
        - mkuznyetsov
        - mmorhun
        - mshaposhnik
        - musienko-maxim
        - nickboldt
        - Ohrimenko1988
        - olexii4
        - rhopp
        - rkratky
        - RomanNikitenko
        - ScrewTSW
        - skabashnyuk
        - SkorikSergey
        - skryzhny
        - sleshchenko
        - snjeza
        - sparkoo
        - sunix
        - svor
        - themr0c
        - tolusha
        - tsmaeder
        - vinokurig
        - vitaliy-guliy
        - vkuznyetsov
        - vparfonov
        - vzhukovs
        # external users
        - monaka

- che_github_pull_request_defaults: &che_github_pull_request_defaults
    name: 'che_github_pull_request_defaults'
    <<: *che_admin_list_defaults
    cron: '* * * * *'
    github-hooks: true
    auth-id: "a3927836-8e6e-400a-ae13-058325ac6c0c"
    permit-all: false
    trigger-phrase: '{trigger_phrase}'
    allow-whitelist-orgs-as-admins: false
    status-context: "ci.centos.org PR check ({job_type})"
    success-comment: "{che-success-message}"
    failure-comment: "{che-failure-message}"
    error-comment: "{che-error-message}"


- github_pull_request_defaults: &github_pull_request_defaults
    name: 'github_pull_request_defaults'
    <<: *admin_list_defaults
    cron: '* * * * *'
    github-hooks: '{github_hooks}'
    trigger-phrase: '.*\[test\].*'
    permit-all: false
    allow-whitelist-orgs-as-admins: true
    status-context: "ci.centos.org PR build"

- trigger:
    name: githubprb
    triggers:
      - github-pull-request:
          <<: *github_pull_request_defaults

- trigger:
    name: che_githubprb
    triggers:
      - github-pull-request:
          <<: *che_github_pull_request_defaults

- scm:
    name: git-scm
    scm:
        - git:
            credentials-id: "c4872223-4024-4cd4-8e09-1bbdc7d6e971"
            url: "{git_url}"
            skip-tag: True
            git-tool: ci-git
            refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
            branches:
                - '${{ghprbActualCommit}}'
            basedir: '{git_basedir}'

- scm:
    name: che-git-scm
    scm:
        - git:
            credentials-id: "fa7e8bab-9c2d-45cb-9880-42b1acd82cd7"
            url: "{git_url}"
            skip-tag: True
            git-tool: ci-git
            refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
            branches:
                - '${{ghprbActualCommit}}'
            basedir: '{git_basedir}'

- vault_defaults: &vault_defaults
    name: 'vault_defaults'
    vault-url: 'https://vault.devshift.net'
    credentials-id: 'approle-devtoolsche'


- kube-config-dsaas-stg: &kube-config-dsaas-stg
    name: "kube-config-dsaas-stg"
    secret-path: 'app-sre/creds/kube-configs/app-sre-stage-02'
    secret-values:
      - env-var: 'KUBE_SERVER'
        vault-key: 'server'
      - env-var: 'KUBE_TOKEN'
        vault-key: 'token'

- kube-config-dsaas: &kube-config-dsaas
    name: "kube-config-dsaas-stg"
    secret-path: 'app-sre/creds/kube-configs/app-sre-prod-03'
    secret-values:
      - env-var: 'KUBE_SERVER'
        vault-key: 'server'
      - env-var: 'KUBE_TOKEN'
        vault-key: 'token'

- fabric8-planner-test-token: &fabric8-planner-test-token
    name: "fabric8-planner-test-token"
    secret-path: 'devtools-osio-ci/fabric8-planner-test-token-refresh-token'
    secret-values:
      - env-var: 'REFRESH_TOKEN'
        vault-key: 'token'

- npm-build-deliver-creds-gh-token: &npm-build-deliver-creds-gh-token
    name: "npm-build-deliver-creds-gh-token"
    secret-path: 'devtools-osio-ci/npm-build-deliver-creds-gh-token'
    secret-values:
      - env-var: 'GH_TOKEN'
        vault-key: 'token'

- npm-build-deliver-creds-npm-token: &npm-build-deliver-creds-npm-token
    name: "npm-build-deliver-creds-npm-token"
    secret-path: 'devtools-osio-ci/npm-build-deliver-creds-npm-token'
    secret-values:
      - env-var: 'NPM_TOKEN'
        vault-key: 'token'

- fabric8-build-dockerio-dockercfg: &fabric8-build-dockerio-dockercfg
    name: "fabric8-build-dockerio-dockercfg"
    secret-path: 'devtools-osio-ci/fabric8-build-dockerio-dockercfg'
    secret-values:
      - env-var: 'FABRIC8_DOCKERIO_CFG'
        vault-key: 'config.json'

- fabric8-github-ssh-key: &fabric8-github-ssh-key
    name: "fabric8-github-ssh-key"
    secret-path: 'devtools-osio-ci/fabric8-github-ssh-key'
    secret-values:
      - env-var: 'FABRIC8_GITHUB_SSH_KEY'
        vault-key: 'ssh-key'

- fabric8-hub-token: &fabric8-hub-token
    name: "fabric8-hub-token"
    secret-path: 'devtools-osio-ci/fabric8-hub-token'
    secret-values:
      - env-var: 'FABRIC8_HUB_TOKEN'
        vault-key: 'hub'

- fabric8-hub-token: &fabric8-build-devcluster
    name: "fabric8-build-devcluster"
    secret-path: 'devtools-osio-ci/fabric8-build-devcluster'
    secret-values:
      - env-var: 'FABRIC8_DEVCLUSTER_TOKEN'
        vault-key: 'OS_TOKEN'

- fabric8-maven-settingsxml: &fabric8-maven-settingsxml
    name: "fabric8-maven-settingsxml"
    secret-path: 'devtools-osio-ci/fabric8-maven-settingsxml'
    secret-values:
      - env-var: 'FABRIC8_MAVEN_SETTINGS'
        vault-key: 'settings.xml'

- registry-devshift-credentials: &registry-devshift-credentials
    name: "registry-devshift-credentials"
    secret-path: 'app-sre/cico/registry-devshift-credentials'
    secret-values:
      - env-var: 'DEVSHIFT_USERNAME'
        vault-key: 'devshift_username'
      - env-var: 'DEVSHIFT_PASSWORD'
        vault-key: 'devshift_password'

- quay-credentials: &quay-credentials
    name: "quay-credentials"
    secret-path: 'app-sre/cico/quay-credentials'
    secret-values:
      - env-var: 'QUAY_USERNAME'
        vault-key: 'quay_username'
      - env-var: 'QUAY_PASSWORD'
        vault-key: 'quay_password'

- quay-eclipse-che-credentials: &quay-eclipse-che-credentials
    name: "quay-eclipse-che-credentials"
    secret-path: 'devtools-osio-ci/quay-eclipse-che-credentials'
    secret-values:
      - env-var: 'QUAY_ECLIPSE_CHE_USERNAME'
        vault-key: 'quay_eclipse_che_username'
      - env-var: 'QUAY_ECLIPSE_CHE_PASSWORD'
        vault-key: 'quay_eclipse_che_password'

- quay-che-incubator-credentials: &quay-che-incubator-credentials
    name: "quay-che-incubator-credentials"
    secret-path: 'devtools-osio-ci/quay-che-incubator-credentials'
    secret-values:
      - env-var: 'QUAY_CHE_INCUBATOR_USERNAME'
        vault-key: 'quay_che_incubator_username'
      - env-var: 'QUAY_CHE_INCUBATOR_PASSWORD'
        vault-key: 'quay_che_incubator_password'

- eclipse-che-github-packages-credentials: &eclipse-che-github-packages-credentials
    name: "eclipse-che-github-packages-credentials"
    secret-path: 'devtools-osio-ci/github-packages-token'
    secret-values:
      - env-var: 'GITHUB_READ_PACKAGES_USERNAME'
        vault-key: 'username'
      - env-var: 'GITHUB_READ_PACKAGES_TOKEN'
        vault-key: 'token'

- che-bot-github-credentials: &che-bot-github-credentials
    name: "che-bot-github-credentials"
    secret-path: "devtools-osio-ci/che-bot-github-token"
    secret-values:
      - env-var: 'CHE_BOT_GITHUB_TOKEN'
        vault-key: 'che-bot-github-token'

- crw-bots-pull-secret: &crw-bots-pull-secret
    name: "crw-bots-pull-secret"
    secret-path: "devtools-osio-ci/crw-bots-pull-secret"
    secret-values:
      - env-var: 'CRW_BOTS_PULL_SECRETS'
        vault-key: 'crw-bots-pull-secret'

- che-bot-npm-auth-token: &che-bot-npm-auth-token
    name: "che-bot-npm-auth-token"
    secret-path: "devtools-osio-ci/che-bot-npm-auth-token"
    secret-values:
      - env-var: 'CHE_NPM_AUTH_TOKEN'
        vault-key: 'che-bot-npm-auth-token'

- eclipse-che-oss-sonatype: &eclipse-che-oss-sonatype
    name: "eclipse-che-oss-sonatype"
    secret-path: "devtools-osio-ci/che-oss-sonatype"
    secret-values:
      - env-var: 'CHE_OSS_SONATYPE_USERNAME'
        vault-key: 'che_oss_sonatype_username'
      - env-var: 'CHE_OSS_SONATYPE_PASSWORD'
        vault-key: 'che_oss_sonatype_password'
      - env-var: 'CHE_MAVEN_SETTINGS'
        vault-key: 'settings.xml'
      - env-var: 'CHE_OSS_SONATYPE_GPG_KEY'
        vault-key: 'che_oss_sonatype_gpg_key'
      - env-var: 'CHE_OSS_SONATYPE_PASSPHRASE'
        vault-key: 'che_oss_sonatype_gpg_passphrase'

- eclipse-che-github-ssh-key: &eclipse-che-github-ssh-key
    name: "eclipse-che-github-ssh-key"
    secret-path: 'devtools-osio-ci/eclipse-che-github-ssh-key'
    secret-values:
      - env-var: 'CHE_GITHUB_SSH_KEY'
        vault-key: 'che-github-ssh-key'

- osiotestmachine-clean-up-gh-token: &osiotestmachine-clean-up-gh-token
    name: "osiotestmachine-clean-up-gh-token"
    secret-path: 'devtools-osio-ci/osiotestmachine-clean-up-gh-token'
    secret-values:
      - env-var: 'GITHUB_TOKEN'
        vault-key: 'token'

- copr-mercator-api-token: &copr-mercator-api-token
    name: "copr-mercator-api-token"
    secret-path: 'devtools-osio-ci/copr-mercator-api-token'
    secret-values:
      - env-var: 'COPR_LOGIN_MERCATOR'
        vault-key: 'login'
      - env-var: 'COPR_TOKEN_MERCATOR'
        vault-key: 'token'

- rh-che-automation-credentials-dockerhub: &rh-che-automation-credentials-dockerhub
    name: "rh-che-automation-credentials-dockerhub"
    secret-path: 'devtools-osio-ci/rh-che-automation-credentials-dockerhub'
    secret-values:
      - env-var: 'RH_CHE_AUTOMATION_DOCKERHUB_USERNAME'
        vault-key: 'username'
      - env-var: 'RH_CHE_AUTOMATION_DOCKERHUB_PASSWORD'
        vault-key: 'password'

- fabric8-planner-test-preview-creds: &fabric8-planner-test-preview-creds
    name: "fabric8-planner-test-preview-creds"
    secret-path: 'devtools-osio-ci/fabric8-planner-test-preview-creds'
    secret-values:
      - env-var: 'USERNAME'
        vault-key: 'username'
      - env-var: 'PASSWORD'
        vault-key: 'password'

- recommender-api-token: &recommender-api-token
    name: "recommender-api-token"
    secret-path: 'devtools-osio-ci/recommender-api-token'
    secret-values:
      - env-var: 'RECOMMENDER_API_TOKEN'
        vault-key: 'token'

- registered-user-uuid: &registered-user-uuid
    name: "registered-user-uuid"
    secret-path: 'devtools-osio-ci/registered-user-uuid'
    secret-values:
      - env-var: 'REGISTERED_USER_UUID'
        vault-key: 'uuid'

- snyk_api_token: &snyk_api_token
    name: "snyk-api-token"
    secret-path: 'devtools-osio-ci/snyk_api_token'
    secret-values:
      - env-var: 'SNYK_TOKEN'
        vault-key: 'token'

- 3scale-user-key: &3scale-user-key
    name: "3scale-user-key"
    secret-path: 'devtools-osio-ci/3scale-user-key'
    secret-values:
      - env-var: 'THREE_SCALE_PREVIEW_USER_KEY'
        vault-key: 'user_key'

- 3scale-user-key-prod: &3scale-user-key-prod
    name: "3scale-user-key-prod"
    secret-path: 'devtools-osio-ci/3scale-user-key-prod'
    secret-values:
      - env-var: 'THREE_SCALE_PREVIEW_USER_KEY'
        vault-key: 'user_key'

- recommender-refresh-token: &recommender-refresh-token
    name: "recommender-refresh-token"
    secret-path: 'devtools-osio-ci/recommender-refresh-token'
    secret-values:
      - env-var: 'RECOMMENDER_REFRESH_TOKEN'
        vault-key: 'token'

- recommender-api-token-prod: &recommender-api-token-prod
    name: "recommender-api-token-prod"
    secret-path: 'devtools-osio-ci/recommender-api-token-prod'
    secret-values:
      - env-var: 'RECOMMENDER_API_TOKEN'
        vault-key: 'token'

- fabric8cd-sonatype-creds: &fabric8cd-sonatype-creds
    name: "fabric8cd-sonatype-creds"
    secret-path: 'devtools-osio-ci/sonatype-creds'
    secret-values:
      - env-var: 'SONATYPE_USERNAME'
        vault-key: 'sonatype_username'
      - env-var: 'SONATYPE_PASSWORD'
        vault-key: 'sonatype_password'

- gpgkeys-for-signing-maven-artefacts: &gpgkeys-for-signing-maven-artefacts
    name: "gpgkeys-for-signing-maven-artefacts"
    secret-path: 'devtools-osio-ci/gpgkeys'
    secret-values:
      - env-var: 'PUBRING'
        vault-key: 'pubring.gpg'
      - env-var: 'SEC_JENKINS'
        vault-key: 'sec-jenkins.gpg'
      - env-var: 'SECRING'
        vault-key: 'secring.gpg'
      - env-var: 'TRUSTDB'
        vault-key: 'trustdb.gpg'
      - env-var: 'GPG_PASSPHRASE'
        vault-key: 'gpg.passphrase'

- che-akamai-cdn-auth: &che-akamai-cdn-auth
    name: "che-akamai-cdn-auth"
    secret-path: "devtools-osio-ci/akamai-che-auth"
    secret-values:
      - env-var: 'AKAMAI_CHE_AUTH'
        vault-key: 'AKAMAI_CHE_AUTH'

- wrapper:
    name: che_credentials_wrapper
    wrappers:
        - credentials-binding:
            - username-password-separated:
                credential-id: b2ae0d9a-307a-4df3-b027-9aa0c22e29dd
                username: RHCHEBOT_DOCKER_HUB_USERNAME
                password: RHCHEBOT_DOCKER_HUB_PASSWORD
            - file:
                credential-id: 93da78ec-7785-49ab-a1ef-586424b3e94f
                variable: creds_config_file

- wrapper:
    name: che_functional_tests_credentials_wrapper-periodical-prod-preview.openshift.io-free-stg
    wrappers:
        - credentials-binding:
            - text:
                credential-id: 1e0bbb30-cddd-4b6f-bc61-bb4ebd2706e5
                variable: KEYCLOAK_TOKEN
            - username-password-separated:
                credential-id: ac51aeb0-a436-4a50-a71d-aa6f99075398
                username: OSIO_USERNAME
                password: OSIO_PASSWORD

- wrapper:
    name: che_functional_tests_credentials_wrapper-prcheck-openshift.io-2
    wrappers:
        - credentials-binding:
            - text:
                credential-id: de793dce-5821-4182-af4f-6c7b42b5c21d
                variable: KEYCLOAK_TOKEN
            - username-password-separated:
                credential-id: ac51aeb0-a436-4a50-a71d-aa6f99075398
                username: OSIO_USERNAME
                password: OSIO_PASSWORD

- wrapper:
    name: che_functional_tests_credentials_wrapper-prcheck-prod-preview.openshift.io-2a
    wrappers:
        - credentials-binding:
            - text:
                credential-id: 60bf228a-e858-4ae3-94fb-7e73fa7d52d9
                variable: KEYCLOAK_TOKEN
            - username-password-separated:
                credential-id: f9b7e98d-2ba0-40c3-8454-2475a064e216
                username: OSIO_USERNAME
                password: OSIO_PASSWORD

- job_template_defaults: &job_template_defaults
    name: 'job_template_defaults'
    description: |
      {jobdescription}
    node: "{ci_project}"
    concurrent: true
    beforeGetNode: ""
    properties:
        - github:
            url: https://github.com/{git_organization}/{git_repo}/
        - build-discarder:
            days-to-keep: '{discarder_days}'
            num-to-keep: '{discarder_num}'
    scm:
        - git-scm:
            git_url: https://{github_user}@github.com/{git_organization}/{git_repo}.git
            git_basedir: ''
    triggers:
        - githubprb:
            github_hooks: '{github_hooks}'
    builders:
        - shell: |
            # testing out the cico client
            set +e
            {beforeGetNode}
            cp ~/artifacts.key .
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f jenkins-env.json
            env > jenkins-env

            $ssh_cmd yum -y install rsync
            if [ -n "${{ghprbTargetBranch}}" ]; then
                git rebase --preserve-merges origin/${{ghprbTargetBranch}}
                rtn_code=$?
                if [ $rtn_code -ne 0 ]; then
                    echo "The branch can not be rebased onto origin/${{ghprbTargetBranch}}."
                    exit $rtn_code
                fi
            else
                echo "Not a PR build, using master"
            fi
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload \
            && /usr/bin/timeout {timeout} $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?
            if [ $rtn_code -eq 0 ]; then
                cico node done $CICO_ssid
            else
                if [[ $rtn_code -eq 124 ]]; then
                   echo "BUILD TIMEOUT";
                   cico node done $CICO_ssid
                else
                    # fail mode gives us 12 hrs to debug the machine
                    curl "http://admin.ci.centos.org:8080/Node/fail?key=$CICO_API_KEY&ssid=$CICO_ssid"
                fi
            fi
            exit $rtn_code

- job-template:
    name: '{ci_project}-{git_repo}'
    wrappers:
      - ansicolor
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-credentials
            - *registry-devshift-credentials
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-prcheck'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-credentials
            - *registry-devshift-credentials
      - che_functional_tests_credentials_wrapper-periodical-prod-preview.openshift.io-free-stg
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-create-comment'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *quay-credentials
        - *registry-devshift-credentials
        - *fabric8-hub-token
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-prcheck-publish-artifacts'
    publishers:
      - archive:
           artifacts: '{artifacts}'
           allow-empty: '{allow_empty}'
           fingerprint: '{fingerprint}'
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-coverage'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (coverage)"
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-e2e'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (e2e)"
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-wit-go-benchmarks'
    triggers:
      - timed: '59 23 * * 6'
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-analytics'
    disabled: '{obj:disabled}'
    registry: 'MISSING_REGISTRY_NAME'
    image_name: 'MISSING_IMAGE_NAME'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-credentials
            - *registry-devshift-credentials
      - ansicolor
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (fabric8-analytics)"
          org-list:
            - fabric8-analytics
            - kubesecurity
          success-comment: "$ghprbPullAuthorLoginMention Your image is available in the registry: `docker pull {registry}/{image_name}:SNAPSHOT-PR-$ghprbPullId`"
          <<: *github_pull_request_defaults
    publishers:
        - email:
            recipients: msawood@redhat.com
            notify-every-unstable-build: true
            send-to-individuals: true
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-f8planner'
    registry: 'MISSING_REGISTRY_NAME'
    image_name: 'MISSING_IMAGE_NAME'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *fabric8-planner-test-token
            - *quay-credentials
            - *registry-devshift-credentials
            - *fabric8-planner-test-preview-creds
      - ansicolor
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (fabric8-planner)"
          org-list:
            - fabric8-ui
          success-comment: "$ghprbPullAuthorLoginMention Your image is available in the registry. Run `docker pull {registry}/{image_name}:SNAPSHOT-PR-$ghprbPullId && docker run -it -p 5000:8080 {registry}/{image_name}:SNAPSHOT-PR-$ghprbPullId` and visit `http://localhost:5000` to access it."
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-analytics-copr-mercator'
    disabled: '{obj:disabled}'
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *copr-mercator-api-token
        - ansicolor
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR (copr) build (fabric8-analytics)"
          org-list:
            - fabric8-analytics
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-hdd'
    disabled: '{obj:disabled}'
    image_name: 'MISSING_IMAGE_NAME'
    registry: 'MISSING_REGISTRY_NAME'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-credentials
            - *registry-devshift-credentials
      - ansicolor
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (fabric8-hdd)"
          org-list:
            - fabric8-hdd
          success-comment: "$ghprbPullAuthorLoginMention Your image is available in the registry: `docker pull {registry}/{image_name}:SNAPSHOT-PR-$ghprbPullId`"
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-hdd-eslint'
    disabled: '{obj:disabled}'
    wrappers:
        - ansicolor
    git_organization: fabric8-hdd
    ci_project: 'devtools'
    ci_cmd: '/bin/bash cico_run_eslint.sh'
    timeout: '20m'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org eslint run (fabric8-hdd)"
          org-list:
            - fabric8-hdd
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-analytics-pylint'
    disabled: '{obj:disabled}'
    wrappers:
        - ansicolor
    git_organization: fabric8-analytics
    ci_project: 'devtools'
    ci_cmd: '/bin/bash cico_run_pylint.sh'
    timeout: '20m'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org pylint run (fabric8-analytics)"
          org-list:
            - fabric8-analytics
            - kubesecurity
          <<: *github_pull_request_defaults
    <<: *job_template_defaults


- job-template:
    name: '{ci_project}-{git_repo}-fabric8-analytics-pydoc'
    disabled: '{obj:disabled}'
    git_organization: fabric8-analytics
    ci_project: 'devtools'
    ci_cmd: '/bin/bash cico_run_pydoc.sh'
    timeout: '20m'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org check-style run (fabric8-analytics)"
          org-list:
            - fabric8-analytics
            - kubesecurity
          <<: *github_pull_request_defaults
    <<: *job_template_defaults

- job-template: &job_template_build_defaults
    name: 'job_template_build_defaults'
    subdir: ''
    description: |
      {jobdescription}
    node: "{ci_project}"
    properties:
        - github:
            url: https://github.com/{git_organization}/{git_repo}/
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{branch}'
    triggers:
        - github
    svc_name: none
    prj_name: dsaas-preview
    saas_git: none
    saas_service_name: none
    saasherder_prepare: |
        if [ "$SAAS_GIT" != "none" ]; then
            SAAS_ENV=staging
            PATH=~/bin/:$PATH:~/.local/bin/
            CONTEXT=$(echo $SAAS_GIT | sed 's/.*://')
            SAAS_GIT=$(echo $SAAS_GIT | sed 's/:.*//')
            SAASHERDER_OBJECT_WHITELIST=Deployment,DeploymentConfig,Service,ConfigMap,Role,RoleBinding,ServiceAccount,CronJob,StatefulSet
            if [[ -z "$SAAS_SERVICE_NAME" || "$SAAS_SERVICE_NAME" == "none" ]]; then
                SAAS_SERVICE_NAME=$GIT_REPO
            fi
            if [ "$SUBDIR" != "" ]; then
                SAAS_SERVICE_NAME=$SAAS_SERVICE_NAME"-"$SUBDIR
            fi
            git clone --depth 1 https://github.com/openshiftio/$SAAS_GIT saas.git
            cd saas.git
            [ "$CONTEXT" != "$SAAS_GIT" ] && saasherder --context $CONTEXT config get-contexts > /dev/null
            export DEVSHIFT_TAG_LEN=$(saasherder --environment $SAAS_ENV get hash_length $SAAS_SERVICE_NAME)
            cd ..
        fi
    saasherder_deploy: |
        if [ "$SVC_NAME" != "none" ]; then
            oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" rollout latest $SVC_NAME -n $PRJ_NAME
            rtn_code=$?
        fi
        if [ "$SAAS_GIT" != "none" ]; then
            cd saas.git
            saasherder --environment $SAAS_ENV update hash $SAAS_SERVICE_NAME $GIT_COMMIT
            saasherder --environment $SAAS_ENV pull $SAAS_SERVICE_NAME
            saasherder --environment $SAAS_ENV template --filter Route --output-dir $GIT_REPO-processed tag $SAAS_SERVICE_NAME
            saasherder --environment $SAAS_ENV label --output-dir $GIT_REPO-processed --saas-repo-url $SAAS_GIT $SAAS_SERVICE_NAME > label_selector
            oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" apply -f $GIT_REPO-processed/$SAAS_SERVICE_NAME.yaml -n $PRJ_NAME
            rtn_code=$?
            if [ $rtn_code -ne 0 ]; then
                echo "error during oc apply"
                exit $rtn_code
            fi
            label_selector=$(cat label_selector)
            resources_to_delete=$(oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" get $SAASHERDER_OBJECT_WHITELIST -o name -l "$label_selector" -n $PRJ_NAME)
            for r in $resources_to_delete; do
                oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" -n $PRJ_NAME delete $r
            done
            cd ..
        fi
    extra_target: ""
    builders:
        - shell: |
            # testing out the cico client
            set +e

            export CICO_API_KEY=$(cat ~/duffy.key )
            get_cico_node() {{
                # get node
                n=1
                while true
                do
                    cico_output=$(cico node get -f value -c ip_address -c comment)
                    if [ $? -eq 0 ]; then
                        read CICO_hostname CICO_ssid <<< $cico_output
                        if  [ ! -z "$CICO_hostname" ]; then
                            # we got hostname from cico
                            break
                        fi
                        echo "'cico node get' succeed, but can't get hostname from output" >&2
                    fi
                    if [ $n -gt 15 ]; then
                        # give up after 15 tries
                        echo "giving up on 'cico node get'" >&2
                        return 1
                    fi
                    echo "'cico node get' failed, trying again in 60s ($n/15)" >&2
                    n=$[$n+1]
                    sleep 60
                done
                echo "$CICO_hostname" "$CICO_ssid"
            }}

            # Verify Job configuration

            if [ "{svc_name}" == "none" -a "{saas_git}" == "none" ]; then
                echo "Not part of SAAS"
            else
                #Prepare values for deployment
                SVC_NAME={svc_name}
                SUBDIR="{subdir}"
                GIT_REPO={git_repo}
                PRJ_NAME={prj_name}
                SAAS_GIT={saas_git}
                {saasherder_prepare}
            fi

            if [ -z "$DEVSHIFT_TAG_LEN" ]; then
                export DEVSHIFT_TAG_LEN=7
            fi

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f jenkins-env.json
            env > jenkins-env

            # CentOS build

            cico_node_output=$(get_cico_node)
            [ "$?" != "0" ] && exit 1

            read CICO_hostname CICO_ssid <<< $cico_node_output

            ssh_cmd="ssh $sshopts $CICO_hostname"

            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?

            if [ "$rtn_code" != "0" ]; then
              curl "http://admin.ci.centos.org:8080/Node/fail?key=$CICO_API_KEY&ssid=$CICO_ssid"
              exit $rtn_code
            fi

            # RHEL build

            if [ -n "{extra_target}" ]; then
                $ssh_cmd -t "cd payload && TARGET=\"{extra_target}\" {ci_cmd}"
                rtn_code=$?

                if [ "$rtn_code" != "0" ]; then
                    curl "http://admin.ci.centos.org:8080/Node/fail?key=$CICO_API_KEY&ssid=$CICO_ssid"
                    exit $rtn_code
                fi
            fi

            #Deploy preview
            # Verify Job configuration
            if [ "{svc_name}" == "none" -a "{saas_git}" == "none" ]; then
                echo "Not part of SAAS, skipping deployment"
            else
                {saasherder_deploy}
            fi

            exit $rtn_code

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-analytics-build-{branch}'
    disabled: '{obj:disabled}'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{build_branch}'
    saasherder_prepare: |
        set -x
        if [ "$SAAS_GIT" != "none" ]; then
            SAAS_ENV=staging
            PATH=~/bin/:$PATH:~/.local/bin/
            CONTEXT=$(echo $SAAS_GIT | sed 's/.*://')
            SAAS_GIT=$(echo $SAAS_GIT | sed 's/:.*//')
            SAAS_SERVICE_NAMES=$SVC_NAME
            git clone --depth 1 https://github.com/openshiftio/$SAAS_GIT saas.git
            cd saas.git
            [ "$CONTEXT" != "$SAAS_GIT" ] && saasherder --context $CONTEXT config get-contexts > /dev/null
            cd ..
        fi

        set +x
    saasherder_deploy: |
        if [ "$SAAS_GIT" != "none" ]; then
            cd saas.git
            for SAAS_SERVICE_NAME in $SAAS_SERVICE_NAMES; do
                export DEVSHIFT_TAG_LEN=$(saasherder --environment $SAAS_ENV get hash_length $SAAS_SERVICE_NAME)
                saasherder --environment $SAAS_ENV update hash $SAAS_SERVICE_NAME $GIT_COMMIT
                saasherder --environment $SAAS_ENV pull $SAAS_SERVICE_NAME
                saasherder --environment $SAAS_ENV template --filter Route --output-dir $GIT_REPO-processed tag $SAAS_SERVICE_NAME
                oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" apply -f $GIT_REPO-processed/$SAAS_SERVICE_NAME.yaml -n $PRJ_NAME
                rtn_code=$(($rtn_code + $?))
            done
            cd ..
        fi
    <<: *job_template_build_defaults

- job-template: &job_template_build_master
    name: '{ci_project}-{git_repo}-build-{branch}'
    disabled: '{obj:disabled}'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *quay-eclipse-che-credentials
            - *quay-che-incubator-credentials
            - *registry-devshift-credentials
            - *eclipse-che-github-packages-credentials
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{build_branch}'
    <<: *job_template_build_defaults

- job-template: &job_template_build_master-v4
    name: '{ci_project}-{git_repo}-build-{branch}-v4'
    disabled: '{obj:disabled}'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *quay-eclipse-che-credentials
            - *quay-che-incubator-credentials
            - *registry-devshift-credentials
            - *eclipse-che-github-packages-credentials
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{build_branch}'
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-{subdir}-build-{branch}'
    <<: *job_template_build_master

- job-template:
    name: '{ci_project}-{git_organization}-{git_repo}-build-{branch}'
    <<: *job_template_build_master

- job-template:
    name: '{ci_project}-{git_repo}-ike-build-{branch}'
    saasherder_prepare: |
        SAAS_ENV=staging
        PATH=~/bin/:$PATH:~/.local/bin/
        CONTEXT=$(echo $SAAS_GIT | sed 's/.*://')
        SAAS_GIT=$(echo $SAAS_GIT | sed 's/:.*//')
        git clone --depth 1 https://github.com/openshiftio/$SAAS_GIT saas.git
        cd saas.git
        [ "$CONTEXT" != "$SAAS_GIT" ] && saasherder --context $CONTEXT config get-contexts > /dev/null

        if [ "$(saasherder --environment $SAAS_ENV get hash_length|sort -u|wc -l)" != "1" ]; then
            echo "In the ike-prow-plugins context all the tag lengths should be the same"
            exit 1
        fi

        export DEVSHIFT_TAG_LEN=$(saasherder --environment $SAAS_ENV get hash_length|head -n1)
        cd ..

    saasherder_deploy: |
        cd saas.git
        for SAAS_SERVICE_NAME in $(saasherder --environment $SAAS_ENV get-services); do
            saasherder --environment $SAAS_ENV update hash $SAAS_SERVICE_NAME $GIT_COMMIT
            saasherder --environment $SAAS_ENV pull $SAAS_SERVICE_NAME
            saasherder --environment $SAAS_ENV template --filter Route --output-dir $GIT_REPO-processed tag $SAAS_SERVICE_NAME
            oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" apply -f $GIT_REPO-processed/$SAAS_SERVICE_NAME.yaml -n $PRJ_NAME
        done
        rtn_code=$?
        cd ..
    <<: *job_template_build_master

- job-template:
    name: '{ci_project}-{git_repo}-f8a-build-{branch}'
    disabled: '{obj:disabled}'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
            - *recommender-api-token-prod
      - ansicolor
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    skip_deploy: 0
    run_e2e : '0'
    deployment_units: ''
    deployment_configs: ''
    extra_target: ''
    builders:
        - shell: |
            # testing out the cico client
            set +e
            set +x
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            export DEVSHIFT_TAG_LEN=7

            (
                # run in subshell not to affect current environment
                set +x

                # load creds_config_file
                eval "$(sed '/^\s*$/d;s/^/export /' $creds_config_file)"

                cp ~/cico-tools/env-toolkit .
                ./env-toolkit dump -f jenkins-env.json
                env > jenkins-env
            )

            set -x

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?

            # RHEL build
            if [[ $rtn_code -eq 0 && -n "{extra_target}" ]]; then
                $ssh_cmd -t "cd payload && TARGET=\"{extra_target}\" {ci_cmd}"
                rtn_code=$?
            fi

            # We want to reuse the node for running E2E tests,
            # but only if we are not doomed already.
            if [[ $rtn_code -ne 0 || {skip_deploy} -ne 0 ]]; then
                cico node done $CICO_ssid
            fi

            # Dump params for deploy-e2e-test-params
            cat > deploy-e2e-test-params << EOF
            GIT_ORGANIZATION={git_organization}
            UPSTREAM_GIT_COMMIT=$GIT_COMMIT
            SAAS_GIT={saas_git}
            DEPLOYMENT_UNITS={deployment_units}
            DEPLOYMENT_CONFIGS={deployment_configs}
            CICO_HOSTNAME=$CICO_hostname
            CICO_SSID=$CICO_ssid
            RUN_E2E={run_e2e}
            EOF

            exit $rtn_code
        - conditional-step:
            condition-kind: shell
            condition-command: |
                [[ {skip_deploy} -eq 0 ]] && exit 0 || exit 1
            steps:
                - trigger-builds:
                    - project:
                        - "devtools-f8a-master-deploy-e2e-test"
                      property-file: deploy-e2e-test-params
                      block: true
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-f8a-build-{branch}-v4'
    disabled: true
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
            - *recommender-api-token-prod
      - ansicolor
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    skip_deploy: 0
    deployment_units: ''
    deployment_configs: ''
    extra_target: ''
    builders:
        - shell: |
            # testing out the cico client
            set +e
            set +x
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            export DEVSHIFT_TAG_LEN=7

            (
                # run in subshell not to affect current environment
                set +x

                # load creds_config_file
                eval "$(sed '/^\s*$/d;s/^/export /' $creds_config_file)"

                cp ~/cico-tools/env-toolkit .
                ./env-toolkit dump -f jenkins-env.json
                env > jenkins-env
            )

            set -x

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?

            ## RHEL build
            if [[ $rtn_code -eq 0 && -n "{extra_target}" ]]; then
                $ssh_cmd -t "cd payload && TARGET=\"{extra_target}\" {ci_cmd}"
                rtn_code=$?
            fi

            # We want to reuse the node for running E2E tests,
            # but only if we are not doomed already.
            if [[ $rtn_code -ne 0 || {skip_deploy} -ne 0 ]]; then
                cico node done $CICO_ssid
            fi

            # Dump params for deploy-e2e-test-params
            cat > deploy-e2e-test-params << EOF
            GIT_ORGANIZATION={git_organization}
            UPSTREAM_GIT_COMMIT=$GIT_COMMIT
            SAAS_GIT={saas_git}
            DEPLOYMENT_UNITS={deployment_units}
            DEPLOYMENT_CONFIGS={deployment_configs}
            CICO_HOSTNAME=$CICO_hostname
            CICO_SSID=$CICO_ssid
            EOF

            exit $rtn_code

        - conditional-step:
            condition-kind: shell
            condition-command: |
                [[ {skip_deploy} -eq 0 ]] && exit 0 || exit 1
            steps:
                - trigger-builds:
                    - project:
                        - "devtools-f8a-master-deploy-e2e-test"
                      property-file: deploy-e2e-test-params
                      block: true
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-build-deploy-{branch}'
    disabled: '{obj:disabled}'
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
            - *recommender-api-token-prod
        - ansicolor
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    skip_deploy: 0
    deployment_units: ''
    deployment_configs: ''
    extra_target: ''
    builders:
        - shell: |
            # testing out the cico client
            set +e
            set +x
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            export DEVSHIFT_TAG_LEN=7

            (
                # run in subshell not to affect current environment
                set +x

                # load creds_config_file
                eval "$(sed '/^\s*$/d;s/^/export /' $creds_config_file)"

                cp ~/cico-tools/env-toolkit .
                ./env-toolkit dump -f jenkins-env.json
                env > jenkins-env
            )

            set -x

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?

            ## RHEL build
            if [[ $rtn_code -eq 0 && -n "{extra_target}" ]]; then
                $ssh_cmd -t "cd payload && TARGET=\"{extra_target}\" {ci_cmd}"
                rtn_code=$?
            fi


            GIT_ORGANIZATION={git_organization}
            UPSTREAM_GIT_COMMIT=$GIT_COMMIT
            SAAS_GIT={saas_git}
            DEPLOYMENT_UNITS="{deployment_units}"
            DEPLOYMENT_CONFIGS={deployment_configs}
            CICO_HOSTNAME=$CICO_hostname
            CICO_SSID=$CICO_ssid
            PRJ_NAME={prj_name}

            # Deploy
            {saasherder_prepare}
            export DEVSHIFT_TAG_LEN=7
            for DEPLOYMENT_UNIT in $DEPLOYMENT_UNITS; do
                export SAAS_SERVICE_NAME=$DEPLOYMENT_UNIT
                export GIT_REPO=$DEPLOYMENT_UNIT
                {saasherder_deploy}
            done
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-saasorg-build-{branch}'
    disabled: '{obj:disabled}'
    saas_organization: openshiftio
    parameters:
        - string:
            name: SAAS_ORGANIZATION
            default: '{saas_organization}'
    saasherder_prepare: |
        if [ "$SAAS_GIT" != "none" ]; then
            SAAS_ENV=staging
            PATH=~/bin/:$PATH:~/.local/bin/
            CONTEXT=$(echo $SAAS_GIT | sed 's/.*://')
            SAAS_GIT=$(echo $SAAS_GIT | sed 's/:.*//')
            if [[ -z "$SAAS_SERVICE_NAME" || "$SAAS_SERVICE_NAME" == "none" ]]; then
                SAAS_SERVICE_NAME=$GIT_REPO
            fi
            if [ "$SUBDIR" != "" ]; then
                SAAS_SERVICE_NAME=$SAAS_SERVICE_NAME"-"$SUBDIR
            fi
            git clone --depth 1 https://github.com/$SAAS_ORGANIZATION/$SAAS_GIT saas.git
            cd saas.git
            [ "$CONTEXT" != "$SAAS_GIT" ] && saasherder --context $CONTEXT config get-contexts > /dev/null
            export DEVSHIFT_TAG_LEN=$(saasherder --environment $SAAS_ENV get hash_length $SAAS_SERVICE_NAME)
            cd ..
        fi
    <<: *job_template_build_master

- fabric8-analytics-tests-template: &fabric8-analytics-tests-template
    name: 'fabric8-analytics-tests-template'
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *recommender-api-token
              - *3scale-user-key
              - *recommender-refresh-token
              - *registered-user-uuid
              - *snyk_api_token
        - ansicolor
    concurrent: false
    builders:
        - shell: |
            set -x
            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f integration-tests/jenkins-env.json
            env > integration-tests/jenkins-env

            gc() {{
                rtn_code=$?
                cico node done $CICO_ssid || :
                exit $rtn_code
            }}
            trap gc EXIT SIGINT
            set -e

            # Run E2E tests
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload-tests
            $ssh_cmd -t "cd payload-tests/integration-tests && /bin/bash cico_run_tests.sh"
    publishers:
        - email:
            recipients: msawood@redhat.com rh-depanalytics@redhat.com
            notify-every-unstable-build: true
            send-to-individuals: true
    <<: *job_template_defaults
    
- job-template:
    name: '{ci_project}-e2e-fabric8-analytics'
    disabled: '{obj:disabled}'
    triggers:
      - github-pull-request:
          status-context: "ci.centos.org PR build (fabric8-analytics)"
          org-list:
            - fabric8-analytics
          <<: *github_pull_request_defaults
    <<: *fabric8-analytics-tests-template

- job-template:
    name: '{ci_project}-test-end-to-end-prod-fabric8-analytics'
    disabled: '{obj:disabled}'
    triggers:
      - timed: '@hourly'
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *recommender-api-token-prod
              - *3scale-user-key-prod
        - ansicolor
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    concurrent: false
    builders:
        - shell: |
            set -x
            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            # We have to point other endpoints to production too
            export F8A_API_URL={f8a_api_url}
            export F8A_API_V2_URL={f8a_api_v2_url}

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f integration-tests/jenkins-env.json
            env > integration-tests/jenkins-env

            gc() {{
                rtn_code=$?
                cico node done $CICO_ssid || :
                exit $rtn_code
            }}
            trap gc EXIT SIGINT
            set -e

            # Run E2E tests
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload-tests
            $ssh_cmd -t "cd payload-tests/integration-tests && /bin/bash cico_run_tests.sh --tags=production"
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-f8a-{branch}-deploy-e2e-test'
    disabled: '{obj:disabled}'
    publishers:
        - email:
            recipients: msawood@redhat.com rh-depanalytics@redhat.com 
            notify-every-unstable-build: true
            send-to-individuals: true
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *kube-config-dsaas-stg
              - *recommender-api-token
              - *3scale-user-key
              - *recommender-refresh-token
              - *registered-user-uuid
              - *snyk_api_token
        - ansicolor
    concurrent: false
    parameters:
      - string:
          name: GIT_ORGANIZATION
          default: fabric8-analytics
      - string:
          name: UPSTREAM_GIT_COMMIT
      - string:
          name: SAAS_GIT
          default: '{saas_git}'
      - string:
          name: PRJ_NAME
          default: '{prj_name}'
      - string:
          name: SVC_NAME
          default: none
      - string:
          name: DEPLOYMENT_UNITS
      - string:
          name: DEPLOYMENT_CONFIGS
      - string:
          name: CICO_HOSTNAME
      - string:
          name: CICO_SSID
      - string:
          name: BUILD_URL
      - string:
          name: RUN_E2E
          default: '0'
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    builders:
        - shell: |
            # Verify Job configuration
            if [ "$SVC_NAME" == "none" -a "$SAAS_GIT" == "none" ]; then
                echo "require either svc_name or saas_git to be set"
                exit 1
            fi

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f integration-tests/jenkins-env.json
            env > integration-tests/jenkins-env

            export GIT_COMMIT=$UPSTREAM_GIT_COMMIT

            # What's the current deployment revision?
            export DC_NAME=${{DEPLOYMENT_CONFIGS##* }}
            DC_REVISION=$(oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" get dc/$DC_NAME -n $PRJ_NAME |grep $DC_NAME | awk '{{ print $2 }}')
            if [ -z "$DC_REVISION" ]; then
                # First deployment
                DC_REVISION=0
            fi

            # Deploy
            {saasherder_prepare}
            export DEVSHIFT_TAG_LEN=7
            for DEPLOYMENT_UNIT in $DEPLOYMENT_UNITS; do
                export SAAS_SERVICE_NAME=$DEPLOYMENT_UNIT
                export GIT_REPO=$DEPLOYMENT_UNIT
                {saasherder_deploy}
            done

            export CICO_API_KEY=$(cat ~/duffy.key )
            # Register rollback routine
            gc() {{
                rtn_code=$?
                for DEPLOYMENT_CONFIG in $DEPLOYMENT_CONFIGS; do
                    if [ $rtn_code -ne 0 ]; then
                        # Failure, rollback
                        oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" rollback dc/$DEPLOYMENT_CONFIG -n $PRJ_NAME --to-version=$DC_REVISION || :
                    fi
                done
                cico node done $CICO_SSID || :
                exit $rtn_code
            }}
            trap gc EXIT SIGINT
            set -e

            # Wait for the new deployment to begin
            # First wait for OpenShift to register the new deployment
            for i in `seq 30`; do
                NEW_DC_REVISION=$(oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" get dc/$DC_NAME -n $PRJ_NAME |grep $DC_NAME | awk '{{ print $2 }}') || :
                if [ ${{NEW_DC_REVISION:-0}} -gt $DC_REVISION ]; then
                    echo "The new deployment has been created."
                    break
                fi
                echo "The new deployment hasn't been created yet."
                sleep 5
            done
            if [ ! ${{NEW_DC_REVISION:-0}} -gt $DC_REVISION ]; then
                exit 1
            fi

            # Wait for the new deployment to actually begin
            (
                for i in `seq 30`; do
                    export DEPLOY_POD_NAME=${{DC_NAME}}-${{NEW_DC_REVISION}}-deploy
                    DEPLOYMENT_STATE=$(oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" get pod/${{DEPLOY_POD_NAME}} -n $PRJ_NAME |grep ${{DEPLOY_POD_NAME}} |awk '{{ print $3 }}') || :
                    if [ ${{DEPLOYMENT_STATE:-Pending}} == "Running" ]; then
                        echo "The new deployment has started."
                        exit 0
                    fi
                    echo "The new deployment hasn't started yet."
                    sleep 5
                done; exit 1
            )
            # And finally wait for the new deployment to be ready
            oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" logs -f dc/$DC_NAME -n $PRJ_NAME

            # Now is the time to run E2E tests
            if [ $RUN_E2E -ne '0' ]; then
                sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
                ssh_cmd="ssh $sshopts $CICO_HOSTNAME"
                rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_HOSTNAME:payload-tests
                $ssh_cmd -t "cd payload-tests/integration-tests && /bin/bash cico_run_tests.sh"
            fi

    <<: *job_template_build_defaults

- job-template: &build_che_template
    name: '{ci_project}-{git_repo}-build-che-credentials-{branch}'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
      - che_credentials_wrapper
      - che_functional_tests_credentials_wrapper-periodical-prod-preview.openshift.io-free-stg
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{branch}'
    extra_target: ""
    builders:
        - shell: |
            # testing out the cico client
            set +e
            set +x
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname
            set -x

            #Prepare values for deployment
            SVC_NAME={svc_name}
            GIT_REPO={git_repo}
            PRJ_NAME={prj_name}
            SAAS_GIT={saas_git}
            SAAS_SERVICE_NAME={saas_service_name}
            {saasherder_prepare}

            if [ -z "$DEVSHIFT_TAG_LEN" ]; then
                export DEVSHIFT_TAG_LEN=7
            fi

            (
                # run in subshell not to affect current environment
                set +x

                # load creds_config_file
                eval "$(sed '/^\s*$/d;s/^/export /' $creds_config_file)"

                cp ~/cico-tools/env-toolkit .
                ./env-toolkit dump -f jenkins-env.json
                env > jenkins-env
            )

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload

            $ssh_cmd -t "cd payload && {ci_cmd}"
            rtn_code=$?

            if [ "$rtn_code" != "0" ]; then
                curl "http://admin.ci.centos.org:8080/Node/fail?key=$CICO_API_KEY&ssid=$CICO_ssid"
                exit $rtn_code
            fi

            # RHEL build

            if [ -n "{extra_target}" ]; then
                $ssh_cmd -t "cd payload && export TARGET=\"{extra_target}\" && {ci_cmd}"
                rtn_code=$?

                if [ "$rtn_code" != "0" ]; then
                    curl "http://admin.ci.centos.org:8080/Node/fail?key=$CICO_API_KEY&ssid=$CICO_ssid"
                    exit $rtn_code
                fi
            fi

            rtn_code=$?
            if [ $rtn_code -eq 0 ]; then
                #Deploy preview
                {saasherder_deploy}
            fi
            cico node done $CICO_ssid
            exit $rtn_code
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-che-build-{branch}'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *quay-eclipse-che-credentials
            - *che-bot-github-credentials
            - *eclipse-che-oss-sonatype

    <<: *job_template_build_master

- job-template:
    name: '{ci_project}-che-theia-che-build-{branch}'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *quay-eclipse-che-credentials
            - *che-bot-github-credentials
            - *eclipse-che-oss-sonatype
            - *che-bot-npm-auth-token
            - *che-akamai-cdn-auth

    <<: *job_template_build_master

- eclipse-che-automation-template: &eclipse-che-automation-template
    name: "eclipse-che-automation-template"
    concurrent: false
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *quay-eclipse-che-credentials
            - *eclipse-che-oss-sonatype
            - *che-bot-github-credentials

    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-nightly-{test_type}'
    triggers:
        - timed: 'H 3 * * *'
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - main

    <<: *eclipse-che-automation-template

- job-template: &che-pullrequest-template
    concurrent: true
    defaults: global
    properties:
        - throttle:
            option: project
            max-total: 3
        - github:
            url: https://github.com/{git_organization}/{git_repo}/
        - build-discarder:
            days-to-keep: '{discarder_days}'
            num-to-keep: '{discarder_num}'
    triggers:
        - github-pull-request:
            trigger_phrase: '{trigger_phrase}'
            job_type: '{job_type}'
            <<: *che_github_pull_request_defaults
    scm:
        - che-git-scm:
            git_url: https://che-bot@github.com/{git_organization}/{git_repo}.git
            git_basedir: ''
    <<: *eclipse-che-automation-template

- job-template:
    name: '{ci_project}-{git_repo}-pullrequests-build'
    <<: *che-pullrequest-template

- job-template:
    name: '{ci_project}-{git_repo}-pullrequests-{job_type}'
    che-success-message: "E2E tests of Eclipse Che Multiuser on OCP has been successful:\n
    - [Build details](https://ci.centos.org/view/Devtools/job/devtools-che-pullrequests-java-selenium-tests/$BUILD_NUMBER/) \n
    - [Test report](http://artifacts.ci.centos.org/devtools/che/che-pullrequests-java-selenium-tests/$BUILD_NUMBER/report/site/failsafe-report.html) "
    che-failure-message: "E2E tests of Eclipse Che Multiuser on OCP has failed:\n
    - [Build details](https://ci.centos.org/view/Devtools/job/devtools-che-pullrequests-java-selenium-tests/$BUILD_NUMBER/) \n
    - [Test report](http://artifacts.ci.centos.org/devtools/che/che-pullrequests-java-selenium-tests/$BUILD_NUMBER/report/site/failsafe-report.html) \n \n
    Use command [ci-test] to rerun the test. "
    che-error-message: "E2E tests of Eclipse Che Multiuser on OCP has failed:\n
    - [Build details](https://ci.centos.org/view/Devtools/job/devtools-che-pullrequests-java-selenium-tests/$BUILD_NUMBER/) \n
    - [Test report](http://artifacts.ci.centos.org/devtools/che/che-pullrequests-java-selenium-tests/$BUILD_NUMBER/report/site/failsafe-report.html) \n \n
    Use command [ci-test] to rerun the test. "
    triggers:
        - github-pull-request:
            only-trigger-phrase: true
            <<: *che_github_pull_request_defaults
    <<: *che-pullrequest-template

- job-template:
    name: '{ci_project}-{git_repo}-release-{test_type}'

    scm:
      - git:
          url: https://github.com/{git_organization}/{git_repo}.git
          shallow_clone: true
          branches:
            - cico-release-test
    triggers:
      - github

    <<: *eclipse-che-automation-template

- job-template:
    name: '{ci_project}-{git_repo}-che-nightly'
    concurrent: false
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-eclipse-che-credentials
            - *quay-credentials
            - *che-bot-github-credentials
            - *eclipse-che-oss-sonatype
            - *che-bot-npm-auth-token
            - *eclipse-che-github-packages-credentials
    triggers:
        - timed: '0 0 * * *'
    scm:
        - git:
            url: https://{github_user}@github.com/{git_organization}/{git_repo}.git
            branches:
                - origin/master
    <<: *job_template_defaults

- job-template: &job-template-che-release-candidate
    name: '{ci_project}-{git_repo}-che-release-candidate'
    concurrent: false
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-eclipse-che-credentials
            - *che-bot-github-credentials
            - *eclipse-che-oss-sonatype
            - *eclipse-che-github-ssh-key
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - release-candidate
    triggers:
        - github
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-build-{branch}-coverage'
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
          - *kube-config-dsaas-stg
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-npm-publish-build-{branch}'
    description: |
      {jobdescription}
      If all goes well, npm is published
    node: "{ci_project}"
    wrappers:
        - ansicolor
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *kube-config-dsaas-stg
              - *npm-build-deliver-creds-gh-token
              - *npm-build-deliver-creds-npm-token
              - *fabric8-planner-test-token
              - *quay-credentials
              - *registry-devshift-credentials
    properties:
        - github:
            url: https://github.com/{git_organization}/{git_repo}/
        - inject:
            properties-content: |
               JENKINS_URL=https://ci.centos.org
    scm:
        - git:
            url: https://{github_user}@github.com/{git_organization}/{git_repo}.git
            credentials-id: "c4872223-4024-4cd4-8e09-1bbdc7d6e971"
            git-tool: ci-git
            shallow_clone: false
            skip-tag: True
            branches:
                - master

    triggers:
        - github
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-push-build-{branch}'
    description: |
      {jobdescription}
      If all goes well, fabric8 images are pushed
    node: "{ci_project}"
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *kube-config-dsaas-stg
              - *fabric8-maven-settingsxml
              - *fabric8cd-sonatype-creds
              - *npm-build-deliver-creds-gh-token
              - *fabric8-hub-token
              - *fabric8-build-devcluster
              - *fabric8-github-ssh-key
              - *fabric8-build-dockerio-dockercfg
              - *gpgkeys-for-signing-maven-artefacts
              - *quay-credentials
              - *registry-devshift-credentials
    properties:
        - github:
            url: https://github.com/{git_organization}/{git_repo}/
        - inject:
            properties-content: |
               JENKINS_URL=https://ci.centos.org
    scm:
        - git:
            url: https://{github_user}@github.com/{git_organization}/{git_repo}.git
            credentials-id: "c4872223-4024-4cd4-8e09-1bbdc7d6e971"
            git-tool: ci-git
            shallow_clone: false
            skip-tag: True
            branches:
                - master
                - cico-test

    triggers:
        - github
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-push-prcheck'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *fabric8-maven-settingsxml
            - *fabric8-hub-token
            - *fabric8-build-devcluster
            - *fabric8cd-sonatype-creds
            - *fabric8-github-ssh-key
            - *fabric8-build-dockerio-dockercfg
            - *quay-credentials
            - *registry-devshift-credentials
            - *gpgkeys-for-signing-maven-artefacts
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-fabric8-docs-prcheck'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *fabric8-hub-token
            - *quay-credentials
            - *registry-devshift-credentials
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-build-{branch}-push-client'
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
            - *fabric8-hub-token
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-nightly'
    concurrent: false
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *quay-eclipse-che-credentials
            - *quay-che-incubator-credentials
    triggers:
        - timed: '0 0 * * *'
    publishers:
        - email:
            recipients: ibuziuk@redhat.com mloriedo@redhat.com amisevsk@redhat.com vparfono@redhat.com
    scm:
        - git:
            url: https://{github_user}@github.com/{git_organization}/{git_repo}.git
            branches:
                - origin/master
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-pr-check'
    defaults: global
    triggers:
        - che_githubprb:
            trigger_phrase: '{trigger_phrase}'
            job_type: '{job_type}'
            che-success-message: '{che-success-message}'
            che-failure-message: '{che-failure-message}'
            che-error-message: '{che-error-message}'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *che-bot-github-credentials
            - *crw-bots-pull-secret
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-pr-check-happy-path'
    defaults: global
    triggers:
        - che_githubprb:
            trigger_phrase: '{trigger_phrase}'
            job_type: 'e2e - Happy path'
            che-success-message: 'Happy path tests passed.'
            che-failure-message: "### $ghprbPullAuthorLoginMention Happy Path PR check [build $BUILD_NUMBER] failed.\n
            Re-trigger by `[ci-test]` or `[ci-test-happy-path]`.\n
            | Link | URL |\n
            | ---- | :-: |\n
            | console | https://ci.centos.org/job/devtools-che-plugin-registry-pr-check-happy-path/$BUILD_NUMBER/console |\n
            | artifacts | http://artifacts.ci.centos.org/devtools/che/che-plugin-registry-prcheck/$BUILD_NUMBER/ |\n
            ### *Depending on failure reason, the artifacts or deployment may not be present.*"
            che-error-message: "### $ghprbPullAuthorLoginMention Happy Path PR check [build $BUILD_NUMBER] failed.\n
            Re-trigger by `[ci-test]` or `[ci-test-happy-path]`.\n
            | Link | URL |\n
            | ---- | :-: |\n
            | console | https://ci.centos.org/job/devtools-che-plugin-registry-pr-check-happy-path/$BUILD_NUMBER/console |\n
            | artifacts | http://artifacts.ci.centos.org/devtools/che/che-plugin-registry-prcheck/$BUILD_NUMBER/ |\n
            ### *Depending on failure reason, the artifacts or deployment may not be present.*"
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *che-bot-github-credentials
            - *quay-eclipse-che-credentials
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-pr-check-che-test-devfiles'
    defaults: global
    triggers:
        - che_githubprb:
            trigger_phrase: '{trigger_phrase}'
            job_type: 'e2e - devfiles tests'
            che-success-message: 'Devfiles tests passed.'
            che-failure-message: 'Devfiles tests failed. Re-trigger by `[ci-test-devfiles]`'
            che-error-message: 'Devfiles tests failed. Re-trigger by `[ci-test-devfiles]`'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
            - *che-bot-github-credentials
            - *quay-eclipse-che-credentials
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-release'
    concurrent: false
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *quay-eclipse-che-credentials
            - *quay-che-incubator-credentials
            - *registry-devshift-credentials
            - *rh-che-automation-credentials-dockerhub
    publishers:
        - email:
            recipients: ibuziuk@redhat.com mloriedo@redhat.com amisevsk@redhat.com vparfono@redhat.com
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - release
    triggers:
        - github
    <<: *job_template_build_defaults

- job-template:
    name: '{ci_project}-{git_repo}-release-preview'
    concurrent: false
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *quay-eclipse-che-credentials
            - *registry-devshift-credentials
    publishers:
        - email:
            recipients: ibuziuk@redhat.com mloriedo@redhat.com amisevsk@redhat.com vparfono@redhat.com
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - '{build_branch}'
    triggers:
        - github
    <<: *job_template_build_defaults

- wrapper:
    name: fabric8_launcher_credentials_wrapper
    wrappers:
        - credentials-binding:
            - text:
                credential-id: 061479ee-de4a-4fb0-b752-7b86659ba3ca
                variable: GENERATOR_DOCKER_HUB_PASSWORD
            - file:
                credential-id: f1d24e18-8f80-4284-9198-d44a713d17b4
                variable: FABRIC8_LAUNCHER_CREDENTIALS

- job-template:
    name: '{ci_project}-{git_repo}-generator-build-{branch}'
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    wrappers:
      - vault-secrets:
          <<: *vault_defaults
          secrets:
            - *kube-config-dsaas-stg
            - *quay-credentials
            - *registry-devshift-credentials
      - fabric8_launcher_credentials_wrapper
    <<: *job_template_build_defaults

- job-template:
    name: 'devtools-test-end-to-end-{test_url}-planner-api-test'
    triggers:
      - timed: '{ee_test_start_time}'
    wrappers:
      - credentials-binding:
        - text:
            credential-id: "{creds_id}"
            variable: EE_TEST_OSIO_TOKEN
    scm:
      - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    builders:
        - shell: |
            set -x
            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f jenkins-env.json
            env > jenkins-env

            set -e

            # Run E2E tests
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd yum -y install rsync
            rsync -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload-tests
            $ssh_cmd -t "cd payload-tests && {ci_cmd}"
            rtn_code=$?
            cico node done $CICO_ssid
            exit $rtn_code
    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-promote-to-prod'
    image_pattern: ''
    defaults: global
    node: devtools
    disabled: '{obj:disabled}'
     
    properties:
        - github:
            url: https://github.com/openshiftio/{git_repo}/
    scm:
        - git:
            url: https://github.com/openshiftio/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    triggers:
        - github
    builders:
        - shell: |
            # testing out the cico client
            set +e

            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"

            if [ -n "${{ghprbTargetBranch}}" ]; then
                git rebase --preserve-merges origin/${{ghprbTargetBranch}}
                rtn_code=$?
                if [ $rtn_code -ne 0 ]; then
                    echo "The branch can not be rebased onto origin/${{ghprbTargetBranch}}."
                    exit $rtn_code
                fi
            else
                echo "Not a PR build, using master"
            fi


            $ssh_cmd -t "yum install -y docker && systemctl start docker"

            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin DRY_RUN=true /bin/bash ~/saasherder/fetch_and_apply.sh
            CONTEXTS=$(PATH=~/bin/:$PATH:~/.local/bin saasherder config get-contexts)
            for c in `echo $CONTEXTS`; do
                DIR=$(readlink -f $c-20* | tail -1)
                for f in `ls $DIR`; do
                    python ~/saasherder/check_image.py $DIR/$f '{image_pattern}'
                    cat $DIR/$f | $ssh_cmd docker run --rm -i quay.io/app-sre/manifest-bouncer:{manifest_bouncer_tag} --warn-only -
                done
            done

            cico node done $CICO_ssid

            set -ex
            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin /bin/bash ~/saasherder/fetch_and_apply.sh

- job-template:
    name: '{ci_project}-{git_repo}-promote-to-prod-v4'
    image_pattern: ''
    defaults: global
    node: devtools
    disabled: '{obj:disabled}'
     
    properties:
        - github:
            url: https://github.com/openshiftio/{git_repo}/
    scm:
        - git:
            url: https://github.com/openshiftio/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    triggers:
        - github
    builders:
        - shell: |
            # testing out the cico client
            set +e

            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"

            if [ -n "${{ghprbTargetBranch}}" ]; then
                git rebase --preserve-merges origin/${{ghprbTargetBranch}}
                rtn_code=$?
                if [ $rtn_code -ne 0 ]; then
                    echo "The branch can not be rebased onto origin/${{ghprbTargetBranch}}."
                    exit $rtn_code
                fi
            else
                echo "Not a PR build, using master"
            fi


            $ssh_cmd -t "yum install -y docker && systemctl start docker"

            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin DRY_RUN=true /bin/bash ~/saasherder/fetch_and_apply.sh
            CONTEXTS=$(PATH=~/bin/:$PATH:~/.local/bin saasherder config get-contexts)
            for c in `echo $CONTEXTS`; do
                DIR=$(readlink -f $c-20* | tail -1)
                for f in `ls $DIR`; do
                    python ~/saasherder/check_image.py $DIR/$f '{image_pattern}'
                    cat $DIR/$f | $ssh_cmd docker run --rm -i quay.io/app-sre/manifest-bouncer:{manifest_bouncer_tag} --warn-only -
                done
            done

            cico node done $CICO_ssid

            set -ex
            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin /bin/bash ~/saasherder/fetch_and_apply.sh

- job-template:
    name: '{ci_project}-{git_repo}-promote-to-prod-test'
    disabled: '{obj:disabled}'
    image_pattern: ''
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
          - *kube-config-dsaas-stg
    builders:
        - shell: |
            # testing out the cico client
            set +e

            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"

            set -ex

            $ssh_cmd -t "yum install -y docker && systemctl start docker"

            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin DRY_RUN=true /bin/bash ~/saasherder/fetch_and_apply.sh
            CONTEXTS=$(PATH=~/bin/:$PATH:~/.local/bin saasherder config get-contexts)
            for c in `echo $CONTEXTS`; do
                DIR=$(readlink -f $c-20* | tail -1)
                for f in `ls $DIR`; do
                    python ~/saasherder/check_image.py $DIR/$f '{image_pattern}'
                    cat $DIR/$f | $ssh_cmd docker run --rm -i quay.io/app-sre/manifest-bouncer:{manifest_bouncer_tag} --warn-only -
                done
            done

            cico node done $CICO_ssid

    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-promote-to-prod-test-v4'
    disabled: '{obj:disabled}'
    image_pattern: ''
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
          - *kube-config-dsaas-stg
    builders:
        - shell: |
            # testing out the cico client
            set +e

            export CICO_API_KEY=$(cat ~/duffy.key )

            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done

            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"

            set -ex

            $ssh_cmd -t "yum install -y docker && systemctl start docker"

            ENVIRONMENT=production PATH=~/bin/:$PATH:~/.local/bin DRY_RUN=true /bin/bash ~/saasherder/fetch_and_apply.sh
            CONTEXTS=$(PATH=~/bin/:$PATH:~/.local/bin saasherder config get-contexts)
            for c in `echo $CONTEXTS`; do
                DIR=$(readlink -f $c-20* | tail -1)
                for f in `ls $DIR`; do
                    python ~/saasherder/check_image.py $DIR/$f '{image_pattern}'
                    cat $DIR/$f | $ssh_cmd docker run --rm -i quay.io/app-sre/manifest-bouncer:{manifest_bouncer_tag} --warn-only -
                done
            done

            cico node done $CICO_ssid

    <<: *job_template_defaults

- job-template:
    name: '{ci_project}-{git_repo}-copr-mercator-build-{branch}'
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - *kube-config-dsaas-stg
              - *copr-mercator-api-token
    scm:
        - git:
            url: https://github.com/{git_organization}/{git_repo}.git
            shallow_clone: true
            branches:
                - master
    <<: *job_template_build_defaults

- contract_tests_consumer_template: &contract_tests_consumer_template
    name: 'contract_tests_consumer_template'
    defaults: global
    node: devtools
    timeout: 60m
    scm_git_branch: master
    properties:
        - github:
            url: '{github_url}'
    scm:
        - git-scm:
            git_url: '{scm_git_url}'
            git_basedir: ''
    wrappers:
        - ansicolor
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - secret-path: 'devtools-osio-ci/contract-tests-creds'
                secret-values:
                    - env-var: 'PACT_BROKER_USERNAME'
                      vault-key: '{pact_broker_creds_username}'
                    - env-var: 'PACT_BROKER_PASSWORD'
                      vault-key: '{pact_broker_creds_password}'
    builders:
        - shell: |
            set +e
            set +x
            export PACT_BROKER_URL="{pact_broker_url}"
            export PACT_VERSION="${{ghprbActualCommit}}"
            export PACT_TAGS="PR-${{ghprbPullId}}"

             cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f jenkins-env.json
            env > jenkins-env
             cp ~/artifacts.key .
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname
            set -x
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd "yum -y -d1 --setopt tsflags='nodocs' install rsync"
            rsync --delete -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            /usr/bin/timeout {timeout} $ssh_cmd -t "cd payload && /bin/bash cico_run_contract_tests_consumer.sh"
            rtn_code=$?
            if [[ $rtn_code -eq 124 ]]; then
               echo "BUILD TIMEOUT";
            else
               rsync --delete -Ha -e "ssh $sshopts" $CICO_hostname:payload/ $(pwd) || rtn_code=$?
            fi
            cico node done $CICO_ssid
            exit $rtn_code
    publishers:
        - email:
            recipients: pmacik@redhat.com
            notify-every-unstable-build: true

- job-template:
    name: 'devtools-contract-test-consumer-{consumer}-{provider}'
    triggers:
        - github-pull-request:
            status-context: "ci.centos.org PR build (contract tests)"
            <<: *github_pull_request_defaults
    <<: *contract_tests_consumer_template

- contract_tests_provider_template: &contract_tests_provider_template
    name: 'contract_tests_provider_template'
    defaults: global
    node: devtools
    timeout: 60m
    zabbix_enabled: true
    scm_git_branch: master
    archive_artifacts: 'true'
    pact_version: latest
    properties:
        - github:
            url: '{github_url}'
    scm:
        - git-scm:
            git_url: '{scm_git_url}'
            git_basedir: ''
    wrappers:
        - ansicolor
        - vault-secrets:
            <<: *vault_defaults
            secrets:
              - secret-path: 'devtools-osio-ci/contract-tests-creds'
                secret-values:
                    - env-var: 'PACT_BROKER_USERNAME'
                      vault-key: '{pact_broker_creds_username}'
                    - env-var: 'PACT_BROKER_PASSWORD'
                      vault-key: '{pact_broker_creds_password}'
    builders:
        - shell: |
            set +e
            set +x
            export PACT_CONSUMER="{pact_consumer}"
            export PACT_VERSION="{pact_version}"
            export PACT_BROKER_URL="{pact_broker_url}"
            export ARCHIVE_ARTIFACTS="{archive_artifacts}"

            cp ~/cico-tools/env-toolkit .
            ./env-toolkit dump -f jenkins-env.json
            env > jenkins-env

            cp ~/artifacts.key .
            export CICO_API_KEY=$(cat ~/duffy.key )
            # get node
            n=1
            while true
            do
                cico_output=$(cico node get -f value -c ip_address -c comment)
                if [ $? -eq 0 ]; then
                    read CICO_hostname CICO_ssid <<< $cico_output
                    if  [ ! -z "$CICO_hostname" ]; then
                        # we got hostname from cico
                        break
                    fi
                    echo "'cico node get' succeed, but can't get hostname from output"
                fi
                if [ $n -gt 15 ]; then
                    # give up after 15 tries
                    echo "giving up on 'cico node get'"
                    exit 1
                fi
                echo "'cico node get' failed, trying again in 60s ($n/15)"
                n=$[$n+1]
                sleep 60
            done
            echo 'Using Host' $CICO_hostname
            set -x
            sshopts="-t -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -l root"
            ssh_cmd="ssh $sshopts $CICO_hostname"
            $ssh_cmd "yum -y -d1 --setopt tsflags='nodocs' install rsync"
            rsync --delete -e "ssh $sshopts" -Ha $(pwd)/ $CICO_hostname:payload
            /usr/bin/timeout {timeout} $ssh_cmd -t "cd payload && /bin/bash cico_run_contract_tests_provider.sh"
            rtn_code=$?
            if [[ $rtn_code -eq 124 ]]; then
               echo "BUILD TIMEOUT";
            else
               rsync --delete -Ha -e "ssh $sshopts" $CICO_hostname:payload/ $(pwd) || rtn_code=$?
            fi
            cico node done $CICO_ssid
            exit $rtn_code
    publishers:
        - email:
            recipients: pmacik@redhat.com
            notify-every-unstable-build: true

- job-template:
    name: 'devtools-contract-test-provider-{consumer}-{provider}'
    triggers:
        - github-pull-request:
            status-context: "ci.centos.org PR build (contract tests)"
            <<: *github_pull_request_defaults
    <<: *contract_tests_provider_template

- job-template:
    name: 'devtools-contract-test-provider-{consumer}-fabric8-auth'
    triggers:
        - github-pull-request:
            status-context: "ci.centos.org PR build (contract tests)"
            <<: *github_pull_request_defaults
    wrappers:
        - vault-secrets:
            <<: *vault_defaults
            secrets:
                - secret-path: 'devtools-osio-ci/contract-tests-creds'
                  secret-values:
                        - env-var: 'PACT_BROKER_USERNAME'
                          vault-key: '{pact_broker_creds_username}'
                        - env-var: 'PACT_BROKER_PASSWORD'
                          vault-key: '{pact_broker_creds_password}'
                        - env-var: 'OSIO_USERNAME'
                          vault-key: '{osio_username_cred}'
                        - env-var: 'OSIO_PASSWORD'
                          vault-key: '{osio_password_cred}'
                        - env-var: 'OSIO_CLUSTER_URL'
                          vault-key: '{osio_cluster_url_cred}'
                        - env-var: 'ONLINE_REGISTRATION_SERVICE_ACCOUNT_CLIENT_ID'
                          vault-key: '{service_account_client_id_cred}'
                        - env-var: 'ONLINE_REGISTRATION_SERVICE_ACCOUNT_CLIENT_SECRET'
                          vault-key: '{service_account_client_secret_cred}'
    <<: *contract_tests_provider_template
