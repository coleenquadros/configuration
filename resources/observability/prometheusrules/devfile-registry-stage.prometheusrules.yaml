---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: devfile-registry-stage
spec:
  groups:
  - name: devfile-registry-stage-latency
    rules:
    - alert: IndexServerHTTPLatency
      expr: sum(rate(index_http_request_duration_seconds_bucket{namespace="devfile-registry-stage", le="1.5"} [10m])) / sum(rate(index_http_request_duration_seconds_count{namespace="devfile-registry-stage"} [10m])) < 0.99
      labels:
        service: devfile-registry
        severity: medium
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#indexserverhttplatency"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        message: "{{ $labels.namespace }} showing response times longer than 2.5 seconds for index registry server"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
    - alert: OCIServerHTTPLatency
      expr: sum(rate(registry_http_request_duration_seconds_bucket{namespace="devfile-registry-stage", le="5"} [10m])) / sum(rate(registry_http_request_duration_seconds_count{namespace="devfile-registry-stage"} [10m])) < 0.99
      labels:
        service: devfile-registry
        severity: medium
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#ociserverhttplatency"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        message: "{{ $labels.namespace }} showing response times longer than 5 seconds for oci registry server"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
  - name: SLOs-haproxy_backend_http_responses_total
    rules:
    - alert: OCIServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=oci-server-preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#ociservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate5m{route="oci-server-preview",namespace="devfile-registry-stage"}) > (14.40 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1h{route="oci-server-preview",namespace="devfile-registry-stage"}) > (14.40 * (1-0.90000))
      for: 2m
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: oci-server-preview
        severity: medium
    - alert: OCIServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=oci-server-preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#ociservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate30m{route="oci-server-preview",namespace="devfile-registry-stage"}) > (6.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate6h{route="oci-server-preview",namespace="devfile-registry-stage"}) > (6.00 * (1-0.90000))
      for: 15m
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: oci-server-preview
        severity: medium
    - alert: OCIServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=oci-server-preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#ociservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate2h{route="oci-server-preview",namespace="devfile-registry-stage"}) > (3.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1d{route="oci-server-preview",namespace="devfile-registry-stage"}) > (3.00 * (1-0.90000))
      for: 1h
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: oci-server-preview
        severity: medium
    - alert: OCIServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=oci-server-preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#ociservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate6h{route="oci-server-preview",namespace="devfile-registry-stage"}) > (1.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate3d{route="oci-server-preview",namespace="devfile-registry-stage"}) > (1.00 * (1-0.90000))
      for: 3h
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: oci-server-preview
        severity: medium
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[1d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[1d]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate1d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[1h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[1h]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate1h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[2h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[2h]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate2h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[30m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[30m]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate30m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[3d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[3d]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate3d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[5m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[5m]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate5m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage",code=~"5.."}[6h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="oci-server-preview",namespace="devfile-registry-stage"}[6h]))
      labels:
        namespace: devfile-registry-stage
        route: oci-server-preview
      record: haproxy_backend_http_responses_total:burnrate6h
    - alert: IndexServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#indexservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-stage-0.k3s7.p1.openshiftapps.com/k8s/ns/devfile-registry-stage/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate5m{route="preview",namespace="devfile-registry-stage"}) > (14.40 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1h{route="preview",namespace="devfile-registry-stage"}) > (14.40 * (1-0.90000))
      for: 2m
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: preview
        severity: medium
    - alert: IndexServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#indexservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-prod-03.z5a2.p1.openshiftapps.com/k8s/ns/devfile-registry-production/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate30m{route="preview",namespace="devfile-registry-stage"}) > (6.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate6h{route="preview",namespace="devfile-registry-stage"}) > (6.00 * (1-0.90000))
      for: 15m
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: preview
        severity: medium
    - alert: IndexServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#indexservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-prod-03.z5a2.p1.openshiftapps.com/k8s/ns/devfile-registry-production/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate2h{route="preview",namespace="devfile-registry-stage"}) > (3.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1d{route="preview",namespace="devfile-registry-stage"}) > (3.00 * (1-0.90000))
      for: 1h
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: preview
        severity: medium
    - alert: IndexServerErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=preview,namespace=devfile-registry-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/devfile-registry/sop/#indexservererrorbudgetburn"
        dashboard: "https://grafana.app-sre.devshift.net/d/7s_TsTsGz/devfile-registry-service?orgId=1"
        link_url: "https://console-openshift-console.apps.app-sre-prod-03.z5a2.p1.openshiftapps.com/k8s/ns/devfile-registry-production/pods"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate6h{route="preview",namespace="devfile-registry-stage"}) > (1.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate3d{route="preview",namespace="devfile-registry-stage"}) > (1.00 * (1-0.90000))
      for: 3h
      labels:
        service: devfile-registry
        namespace: devfile-registry-stage
        route: preview
        severity: medium
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[1d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[1d]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate1d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[1h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[1h]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate1h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[2h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[2h]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate2h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[30m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[30m]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate30m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[3d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[3d]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate3d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[5m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[5m]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate5m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage",code=~"5.."}[6h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="preview",namespace="devfile-registry-stage"}[6h]))
      labels:
        namespace: devfile-registry-stage
        route: preview
      record: haproxy_backend_http_responses_total:burnrate6h
