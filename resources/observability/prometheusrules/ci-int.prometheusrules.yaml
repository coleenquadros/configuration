---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    prometheus: app-sre
    role: alert-rules
  name: ci-int-alertrules
spec:
  groups:
  # Alerting for Jenkins jobs
  - name: jenkins-jobs.rules
    rules:
    # Hive team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-hive-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: hive
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics"
        # Using @hive-cop explicitly in the message doesn't work, but this is supposed to, per
        # https://api.slack.com/reference/surfaces/formatting#mentioning-groups
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure <!subteam^SLRCTERUZ>"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # AppSRE jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-workers-cleanup',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: ci-int
      annotations:
        runbook: "https://gitlab.cee.redhat.com/dtsd/housekeeping/blob/master/docs/ci/ci-int/ci-int.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-app-interface-gl-build-master',job='jenkins_int'} > 0"
      for: 5m
      labels:
        severity: critical
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-build-master-failure.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='app-interface-output-run',job='jenkins_int'} > 0"
      labels:
        severity: critical-fts
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-output-run-failure.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-app-interface-gl-periodic-job-app-interface-reporter',job='jenkins_int'} > 0"
      labels:
        severity: high
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='gitkeeper-run',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/push-saas-metrics.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # RHEL ci-int nodes subscription
    - alert: RHEL7Subscription
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-node-rhel7-check',job='jenkins_int'} > 0"
      for: 130m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}RHEL7 subscription isn't valid (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}RHEL7 subscription has problems, docker builds aren't possible{% endraw %}"
    - alert: RHEL8Subscription
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-node-rhel8-check',job='jenkins_int'} > 0"
      for: 130m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}RHEL8 subscription isn't valid (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}RHEL8 subscription has problems, docker builds aren't possible{% endraw %}"
    # ClusterImageSets jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='clusterimageset-run',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/clusterimagesets.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # UHC jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-clusters-service-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-gateway-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-api-test-production-provision',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-api-test-staging-provision',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-cluster-cleaner-staging',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-cloud-redhat-com-push-insights-beta',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-cloud-redhat-com-push-insights-stable',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # UHC team SD-B jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-account-manager-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        channel: service-development-b
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-ocm-resources-ocm-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        channel: service-development-b
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "@ocm-resources {{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # Cincinnati team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-cincinnati-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: cincinnati
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net/d/cincinnati/cincinnati"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # Insights Compliance team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='insights-platform-compliance-ssg-gl-build-main',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: compliance
        channel: team-clouddot-compliance-deployment-alarms
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/compliance/compliance"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='RedHatInsights-compliance-backend-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: compliance
        channel: team-clouddot-compliance-deployment-alarms
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/compliance/compliance"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # SREP team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-aws-account-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-certman-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-pagerduty-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-deadmanssnitch-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-dedicated-admin-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-configure-alertmanager-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-managed-cluster-config-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    # Alerting on health of Jenkins system
    - alert: JenkinsHealthCheck
      labels:
        severity: critical-fts
        service: ci-int
      expr: jenkins_health_check_score < 1
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Jenkins health degraded {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsNodeOffline
      labels:
        severity: critical-fts
        service: ci-int
      expr: jenkins_node_offline_value > 1
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: One or more Jenkins nodes are offline {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsJvmMemoryStarvation
      labels:
        severity: critical-fts
        service: ci-int
      expr: (vm_memory_total_max{job="jenkins_int"} - vm_memory_total_used{job="jenkins_int"}) / vm_memory_total_max{job="jenkins_int"} * 100.0 < 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Less than 10% memory available more than 5 minutes {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsExecutorSaturation
      labels:
        severity: medium
        service: ci-int
      expr: 100 * (jenkins_executor_free_value / jenkins_executor_count_value) < 50
      for: 10m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Less than 50% executors available more than 10 minutes {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsJvmMemoryStarvation
      labels:
        severity: medium
        service: ci-int
      expr: (vm_memory_total_max{job="jenkins_int"} - vm_memory_total_used{job="jenkins_int"}) / vm_memory_total_max{job="jenkins_int"} * 100.0 < 25
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Less than 25% memory available more than 5 minutes {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsJvmCPUStarvation
      labels:
        severity: medium
        service: ci-int
      # ci.int has 8 cores right now, so this is 75% utilization
      expr: vm_cpu_load{job="jenkins_int"} * 100 > 600
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: CPU Load > 75% for more than 5 minutes {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    # Alerting on health of Jenkins Web
    # We need this recording rule until someone works on https://github.com/jenkinsci/prometheus-plugin/issues/100
    - record: jenkins:http_responseCodes_total
      expr: sum({__name__=~"http_responseCodes_.*"}) by (instance)
    - alert: JenkinsWebForbidden
      labels:
        severity: medium
        service: ci-int
      expr: |
        sum(rate(http_responseCodes_forbidden_total{instance="ci.int.devshift.net:443"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.int.devshift.net:443"}[5m])) * 100 > 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Jenkins server is returning 403 for {{ $value }}% of requests {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsWebNotFound
      labels:
        severity: medium
        service: ci-int
      expr: |
        sum(rate(http_responseCodes_notFound_total{instance="ci.int.devshift.net:443"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.int.devshift.net:443"}[5m])) * 100 > 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Jenkins server is returning 404 for {{ $value }}% of requests {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsWebServerError
      labels:
        severity: critical-fts
        service: ci-int
      expr: |
        sum(rate(http_responseCodes_serverError_total{instance="ci.int.devshift.net:443"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.int.devshift.net:443"}[5m])) * 100 > 5
      for: 2m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Jenkins server is returning serverError for {{ $value }}% of requests {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    - alert: JenkinsWebServiceUnavailable
      labels:
        severity: critical-fts
        service: ci-int
      expr: |
        sum(rate(http_responseCodes_serviceUnavailable_total{instance="ci.int.devshift.net:443"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.int.devshift.net:443"}[5m])) * 100 > 5
      for: 2m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{% raw %} {{ $labels.instance }}: Jenkins server is returning serviceUnavailable for {{ $value }}% of requests {% endraw %}"
        link_url: "{% raw %} https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }} {% endraw %}"
    # App-sre team gitlab alerts
    - alert: 2xxProbeFailingGitLab
      labels:
        severity: critical-fts
        service: ci-int
      expr: up{job="blackbox_2xx_gitlab"} == 0 or probe_success{job="blackbox_2xx_gitlab"} == 0
      for: 30m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/dtsd/housekeeping/blob/master/docs/pnt-devops-escalations.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "GitLab has been unreachable for 30 minutes."
        link_url: "https://gitlab.cee.redhat.com/"
    # App-sre team ci-int alerts
    - alert: 2xxProbeFailingCIInt
      labels:
        severity: critical-fts
        service: ci-int
      expr: up{job="blackbox_2xx_ci_int"} == 0 or probe_success{job="blackbox_2xx_ci_int"} == 0
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/app-sre/sop/CentralCIInstanceDown.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "ci-int has been unreachable for 5 minutes."
        link_url: "https://ci.int.devshift.net/"
    # General alerting rules applied to all services
    - expr: |
        max by (instance, device) ((node_filesystem_size_bytes{fstype=~"ext[234]|btrfs|xfs|zfs"}
        - node_filesystem_avail_bytes{fstype=~"ext[234]|btrfs|xfs|zfs"})
        / node_filesystem_size_bytes{fstype=~"ext[234]|btrfs|xfs|zfs"})
      record: 'node:node_filesystem_usage:'
    - expr: |
        max by (instance, device) (node_filesystem_avail_bytes{fstype=~"ext[234]|btrfs|xfs|zfs"} / node_filesystem_size_bytes{fstype=~"ext[234]|btrfs|xfs|zfs"})
      record: 'node:node_filesystem_avail:'
    - alert: JenkinsInstanceDown
      expr: up{job=~".*jenkins.*"} == 0
      for: 5m
      labels:
        severity: critical-fts
        service: ci-int
      annotations:
        message: "{% raw %}{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.{% endraw %}"
        summary: "{% raw %}Instance {{ $labels.instance }} down{% endraw %}"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/CentralCIInstanceDown.md"
    - alert: CriticalCPULoad
      expr: '100 - (avg by (instance) (irate(node_cpu_seconds_total{job="node",mode="idle"}[5m])) * 100) > 96'
      for: 2m
      labels:
        severity: critical-fts
        service: ci-int
      annotations:
        message: "{% raw %}{{ $labels.instance }} of job {{ $labels.job }} has Critical CPU load for more than 2 minutes.{% endraw %}"
        summary: "{% raw %}Instance {{ $labels.instance }} - Critical CPU load{% endraw %}"
    - alert: CriticalMemoryUsage
      expr: '(1 - ((node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_SReclaimable_bytes) / node_memory_MemTotal_bytes)) * 100 > 98'
      for: 5m
      labels:
        severity: critical-fts
        service: ci-int
      annotations:
        message: "{% raw %}{{ $labels.instance }} has Critical Memory Usage more than 5 minutes.{% endraw %}"
        summary: "{% raw %}Instance {{ $labels.instance }} has Critical Memory Usage{% endraw %}"
    - alert: OutOfMemory
      expr: (node_memory_MemFree_bytes + node_memory_Cached_bytes + node_memory_Buffers_bytes + node_memory_SReclaimable_bytes) / node_memory_MemTotal_bytes * 100 < 10
      for: 30m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}Out of memory (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}Node memory is filling up (< 10% left)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}{% endraw %}"
    - alert: CriticalDiskSpace
      expr: 'node_filesystem_free_bytes{job="node",filesystem!~"^/run(/|$)"} / node_filesystem_size_bytes{job="node"} < 0.1'
      for: 4m
      labels:
        severity: critical-fts
        service: ci-int
      annotations:
        message: "{% raw %}{{ $labels.instance }} of job {{ $labels.job }} has less than 10% space remaining.{% endraw %}"
        summary: "{% raw %}Instance {{ $labels.instance }} - Critical disk space usage{% endraw %}"
    - alert: PredictNodeDiskFull
      annotations:
        message: "{% raw %}Device {{ $labels.device }} of node {{ $labels.instance }} will be full within the next 2 hours.{% endraw %}"
      expr: |
        (node:node_filesystem_usage: > 0.85) and (predict_linear(node:node_filesystem_avail:[30m], 3600 * 2) < 0)
      for: 10m
      labels:
        severity: critical-fts
        service: ci-int
    - alert: PredictNodeDiskFull
      annotations:
        message: "{% raw %}Device {{ $labels.device }} of node {{ $labels.instance }} will be full within the next 24 hours.{% endraw %}"
      expr: |
        (node:node_filesystem_usage: > 0.85) and (predict_linear(node:node_filesystem_avail:[6h], 3600 * 24) < 0)
      for: 30m
      labels:
        severity: high
        service: ci-int
    - alert: RebootRequired
      expr: "node_reboot_required > 0"
      labels:
        severity: high
        service: ci-int
      annotations:
        message: "{% raw %}{{ $labels.instance }} requires a reboot.{% endraw %}"
        summary: "{% raw %}Instance {{ $labels.instance }} - reboot required{% endraw %}"
    - alert: UnusualNetworkThroughputIn
      expr: sum by (instance) (irate(node_network_receive_bytes_total[2m])) / 1024 / 1024 > 100
      for: 30m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}Unusual network throughput in (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}Host network interfaces are probably receiving too much data (> 100 MB/s)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}{% endraw %}"
    - alert: UnusualNetworkThroughputOut
      expr: sum by (instance) (irate(node_network_transmit_bytes_total[2m])) / 1024 / 1024 > 100
      for: 30m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}Unusual network throughput out (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}Host network interfaces are probably sending too much data (> 100 MB/s)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}{% endraw %}"
    - alert: OutOfInodes
      expr: node_filesystem_files_free{mountpoint ="/"} / node_filesystem_files{mountpoint ="/"} * 100 < 10
      for: 30m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}Out of inodes (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}Disk is almost running out of available inodes (< 10% left)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}{% endraw %}"
