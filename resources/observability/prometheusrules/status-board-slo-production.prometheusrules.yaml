---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: status-board-slo-production
spec:
  groups:


    # generated from https://promtools.dev/alerts/errors
    - name: SLOs-haproxy_backend_http_responses_total
      rules:
        - alert: ErrorBudgetBurn5mto1h
          annotations:
            message: 'High error budget burn for route=status-board-production,exported_namespace=status-board-production (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-availability.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate5m{route="status-board-production",exported_namespace="status-board-production"}) > (14.40 * (1-0.90000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1h{route="status-board-production",exported_namespace="status-board-production"}) > (14.40 * (1-0.90000))
          for: 2m
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
            severity: medium
        - alert: ErrorBudgetBurn30mto6h
          annotations:
            message: 'High error budget burn for route=status-board-production,exported_namespace=status-board-production (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-availability.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate30m{route="status-board-production",exported_namespace="status-board-production"}) > (6.00 * (1-0.90000))
            and
            sum(haproxy_backend_http_responses_total:burnrate6h{route="status-board-production",exported_namespace="status-board-production"}) > (6.00 * (1-0.90000))
          for: 15m
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
            severity: medium
        - alert: ErrorBudgetBurn2hto1d
          annotations:
            message: 'High error budget burn for route=status-board-production,exported_namespace=status-board-production (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-availability.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate2h{route="status-board-production",exported_namespace="status-board-production"}) > (3.00 * (1-0.90000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1d{route="status-board-production",exported_namespace="status-board-production"}) > (3.00 * (1-0.90000))
          for: 1h
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
            severity: medium
        - alert: ErrorBudgetBurn6hto3d
          annotations:
            message: 'High error budget burn for route=status-board-production,exported_namespace=status-board-production (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-availability.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate6h{route="status-board-production",exported_namespace="status-board-production"}) > (1.00 * (1-0.90000))
            and
            sum(haproxy_backend_http_responses_total:burnrate3d{route="status-board-production",exported_namespace="status-board-production"}) > (1.00 * (1-0.90000))
          for: 3h
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
            severity: medium
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[1d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[1d]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate1d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[1h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[1h]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate1h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[2h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[2h]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate2h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[30m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[30m]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate30m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[3d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[3d]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate3d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[5m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[5m]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate5m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production",code=~"5.."}[6h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="status-board-production",exported_namespace="status-board-production"}[6h]))
          labels:
            service: status-board
            exported_namespace: status-board-production
            route: status-board-production
          record: haproxy_backend_http_responses_total:burnrate6h

    # generated from https://promtools.dev/alerts/latency
    - name: SLOs-api_inbound_request_duration
      rules:
        - alert: Latency5mto1hor30mto6hBudgetBurn
          annotations:
            message: 'High requests latency budget burn for namespace=status-board-production,job=status-board-metrics,latency=1 (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-latency.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            (
              latencytarget:api_inbound_request_duration:rate1h{namespace="status-board-production",job="status-board-metrics",latency="1"} > (14.4*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate5m{namespace="status-board-production",job="status-board-metrics",latency="1"} > (14.4*(1-0.99000))
            )
            or
            (
              latencytarget:api_inbound_request_duration:rate6h{namespace="status-board-production",job="status-board-metrics",latency="1"} > (6*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate30m{namespace="status-board-production",job="status-board-metrics",latency="1"} > (6*(1-0.99000))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
            severity: medium
        - alert: Latency2hto1dor6hto3dBudgetBurn
          annotations:
            message: 'High requests latency budget burn for namespace=status-board-production,job=status-board-metrics,latency=1 (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/status-board/sops/status-board-latency.md"
            dashboard: "https://grafana.app-sre.devshift.net/d/statusboard/status-board?orgId=1&var-datasource=app-sre-prod-04-prometheus"
          expr: |
            (
              latencytarget:api_inbound_request_duration:rate1d{namespace="status-board-production",job="status-board-metrics",latency="1"} > (3*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate2h{namespace="status-board-production",job="status-board-metrics",latency="1"} > (3*(1-0.99000))
            )
            or
            (
              latencytarget:api_inbound_request_duration:rate3d{namespace="status-board-production",job="status-board-metrics",latency="1"} > (1 * (1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate6h{namespace="status-board-production",job="status-board-metrics",latency="1"} > (1 * (1-0.99000))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
            severity: medium
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[5m]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[5m]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate5m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[30m]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[30m]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate30m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[1h]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[1h]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate1h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[2h]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[2h]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate2h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[6h]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[6h]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate6h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[1d]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[1d]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate1d
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{namespace="status-board-production",job="status-board-metrics",le="1",code!~"5.."}[3d]))
              /
              sum(rate(api_inbound_request_duration_count{namespace="status-board-production",job="status-board-metrics"}[3d]))
            )
          labels:
            service: status-board
            job: status-board-metrics
            latency: "1"
            namespace: status-board-production
          record: latencytarget:api_inbound_request_duration:rate3d
