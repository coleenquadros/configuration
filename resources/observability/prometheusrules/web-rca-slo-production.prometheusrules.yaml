---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: web-rca-slo-production
spec:
  groups:


  # generated from https://promtools.dev/alerts/errors
  - name: SLOs-haproxy_backend_http_responses_total
    rules:
    - alert: ErrorBudgetBurn5mto1h
      annotations:
        message: 'High error budget burn for route=web-rca-production,exported_namespace=web-rca-production (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-availability.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate5m{route="web-rca-production",exported_namespace="web-rca-production"}) > (14.40 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1h{route="web-rca-production",exported_namespace="web-rca-production"}) > (14.40 * (1-0.90000))
      for: 2m
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
        severity: high
    - alert: ErrorBudgetBurn30mto6h
      annotations:
        message: 'High error budget burn for route=web-rca-production,exported_namespace=web-rca-production (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-availability.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate30m{route="web-rca-production",exported_namespace="web-rca-production"}) > (6.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate6h{route="web-rca-production",exported_namespace="web-rca-production"}) > (6.00 * (1-0.90000))
      for: 15m
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
        severity: high
    - alert: ErrorBudgetBurn2hto1d
      annotations:
        message: 'High error budget burn for route=web-rca-production,exported_namespace=web-rca-production (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-availability.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate2h{route="web-rca-production",exported_namespace="web-rca-production"}) > (3.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1d{route="web-rca-production",exported_namespace="web-rca-production"}) > (3.00 * (1-0.90000))
      for: 1h
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
        severity: high
    - alert: ErrorBudgetBurn6hto3d
      annotations:
        message: 'High error budget burn for route=web-rca-production,exported_namespace=web-rca-production (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-availability.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate6h{route="web-rca-production",exported_namespace="web-rca-production"}) > (1.00 * (1-0.90000))
        and
        sum(haproxy_backend_http_responses_total:burnrate3d{route="web-rca-production",exported_namespace="web-rca-production"}) > (1.00 * (1-0.90000))
      for: 3h
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
        severity: high
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[1d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[1d]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate1d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[1h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[1h]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate1h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[2h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[2h]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate2h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[30m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[30m]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate30m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[3d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[3d]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate3d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[5m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[5m]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate5m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production",code=~"5.."}[6h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="web-rca-production",exported_namespace="web-rca-production"}[6h]))
      labels:
        service: web-rca
        exported_namespace: web-rca-production
        route: web-rca-production
      record: haproxy_backend_http_responses_total:burnrate6h


  # generated from https://promtools.dev/alerts/latency
  - name: SLOs-api_inbound_request_duration
    rules:
    - alert: Latency5mto1hor30mto6hBudgetBurn
      annotations:
        message: 'High requests latency budget burn for namespace=web-rca-production,job=web-rca-metrics,latency=1 (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-latency.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        (
          latencytarget:api_inbound_request_duration:rate1h{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (14.4*(1-0.99000))
          and
          latencytarget:api_inbound_request_duration:rate5m{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (14.4*(1-0.99000))
        )
        or
        (
          latencytarget:api_inbound_request_duration:rate6h{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (6*(1-0.99000))
          and
          latencytarget:api_inbound_request_duration:rate30m{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (6*(1-0.99000))
        )
      labels:
        job: web-rca-metrics
        latency: "1"
        namespace: web-rca-production
        service: web-rca
        severity: high
    - alert: Latency2hto1dor6hto3dBudgetBurn
      annotations:
        message: 'High requests latency budget burn for namespace=web-rca-production,job=web-rca-metrics,latency=1 (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-latency.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/_7_Ul_07k/web-rca?orgId=1&var-datasource=app-sre-prod-04-prometheus"
      expr: |
        (
          latencytarget:api_inbound_request_duration:rate1d{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (3*(1-0.99000))
          and
          latencytarget:api_inbound_request_duration:rate2h{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (3*(1-0.99000))
        )
        or
        (
          latencytarget:api_inbound_request_duration:rate3d{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (1 * (1-0.99000))
          and
          latencytarget:api_inbound_request_duration:rate6h{latency="1", namespace="web-rca-production",job="web-rca-metrics"} > (1 * (1-0.99000))
        )
      labels:
        job: web-rca-metrics
        latency: "1"
        namespace: web-rca-production
        service: web-rca
        severity: high
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[5m]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[5m]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate5m
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[30m]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[30m]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate30m
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[1h]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[1h]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate1h
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[2h]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[2h]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        latency: "1"
        namespace: web-rca-production
      record: latencytarget:api_inbound_request_duration:rate2h
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[6h]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[6h]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate6h
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[1d]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[1d]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate1d
    - expr: |
        1 - (
          sum(rate(api_inbound_request_duration_bucket{namespace="web-rca-production",job="web-rca-metrics",le="1000.0",code!~"5.."}[3d]))
          /
          sum(rate(api_inbound_request_duration_count{namespace="web-rca-production",job="web-rca-metrics"}[3d]))
        )
      labels:
        service: web-rca
        job: web-rca-metrics
        namespace: web-rca-production
        latency: "1"
      record: latencytarget:api_inbound_request_duration:rate3d
