---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: osd-fleet-manager-production
spec:
  groups:
    - name: osd-fleet-manager-production
      rules:
        - alert: OSD Fleet Manager down - blue sector
          annotations:
            message: "No instances found for OSD Fleet Manager on blue sector OSD Fleet Manager is down."
          expr: |
            absent(up{service="fleet-manager-metrics-blue",namespace="osd-fleet-manager-production"} == 1)
          for: 15m
          labels:
            severity: high
            team: osd
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager

        - alert: OSD Fleet Manager down - green sector
          annotations:
            message: "No instances found for OSD Fleet Manager on green sector OSD Fleet Manager is down."
          expr: |
            absent(up{service="fleet-manager-metrics-green",namespace="osd-fleet-manager-production"} == 1)
          for: 15m
          labels:
            severity: high
            team: osd
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager

        - alert: OSD Fleet Manager down - eu-west-1 sector
          annotations:
            message: "No instances found for OSD Fleet Manager on eu-west-1 sector OSD Fleet Manager is down."
          expr: |
            absent(up{service="fleet-manager-metrics-eu-west-1",namespace="osd-fleet-manager-production"} == 1)
          for: 15m
          labels:
            severity: high
            team: osd
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager
    
        - alert: OSD Fleet manager crashing - production
          annotations:
            message: OSD Fleet manager production clusters container '{{ $labels.container }}' of pod '{{ $labels.pod }}' is crashing
          expr: |
            sum(increase(kube_pod_container_status_restarts_total{namespace="osd-fleet-manager-production",pod=~"^fleet-manager-.*$"}[10m]))
            by (pod,container)
            >= 2
          for: 1m
          labels:
            severity: high
            team: osd
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager
            
        # SLO Availability p99
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: OSD Fleet Manager returning 5xx error budget burn 5m to 1h
          annotations:
            message: 'High error budget burn of returning 5xx error codes for {{ $labels.service }}(current value: {{ $value }})'
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate5m{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (13.44 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (13.44 * (1-0.99000))
          for: 2m
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: high
            team: osd
        - alert: OSD Fleet Manager returning 5xx error budget burn 30m to 6h 
          annotations:
            message: 'High error budget burn of returning 5xx error codes for {{ $labels.service }}(current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate30m{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (5.60 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate6h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (5.60 * (1-0.99000))
          for: 15m
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
        - alert: OSD Fleet Manager returning 5xx error budget burn 2h to 1d
          annotations:
            message: 'High error budget burn of returning 5xx error codes for {{ $labels.service }}(current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate2h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (2.80 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1d{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (2.80 * (1-0.99000))
          for: 1h
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
        - alert: OSD Fleet Manager returning 5xx error budget burn 6h to 3d
          annotations:
            message: 'High error budget burn of returning 5xx error codes for {{ $labels.service }}(current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate6h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (1.00 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate3d{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (1.00 * (1-0.99000))
          for: 3h
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[1d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[1d]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate1d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[1h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[1h]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate1h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[2h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[2h]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate2h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[30m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[30m]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate30m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[3d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[3d]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate3d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[5m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[5m]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate5m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production",code=~"5.."}[6h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}[6h]))
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate6h

        # SLO API Latency p90 < 100ms
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: OSD Fleet Manager Latency p90 < 100ms 30m to 6h budget burn
          annotations:
            message: "High 1h/6h requests latency budget burn for OSD Fleet Manager API p90 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            latencytarget:api_inbound_request_duration_bucket:rate6h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (5.6*(1 - 0.90000))
            and
            latencytarget:api_inbound_request_duration_bucket:rate30m{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (5.6*(1 - 0.90000))
          labels:
            service: osd-fleet-manager
            latency: "0.1"
            quantile: "90"
            namespace: osd-fleet-manager-production
            severity: medium
        - alert: OSD Fleet Manager Latency p90 < 100ms 6h to 3d budget burn 
          annotations:
            message: "High 1d/3d requests latency budget burn for OSD Fleet Manager API p90 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            (
              latencytarget:api_inbound_request_duration_bucket:rate1d{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (2.8*(1 - 0.90000))
              and
              latencytarget:api_inbound_request_duration_bucket:rate2h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (2.8*(1 - 0.90000))
            )
            or
            (
              latencytarget:api_inbound_request_duration_bucket:rate3d{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (1*(1 - 0.90000))
              and
              latencytarget:api_inbound_request_duration_bucket:rate6h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",le="0.1"} > (1*(1 - 0.90000))
            )
          labels:
            service: osd-fleet-manager
            latency: "0.1"
            quantile: "90"
            namespace: osd-fleet-manager-production
            severity: medium
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[5m]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[5m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate5m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[30m]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[30m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate30m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[1h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[1h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate1h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[2h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[2h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate2h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[6h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[6h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate6h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[1d]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[1d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate1d
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="0.1",code!~"5.."}[3d]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[3d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate3d

        # SLO API Latency p99 < 1s
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: OSD Fleet Manager Latency p99 < 1s 30m to 6h budget burn 
          annotations:
            message: "High 6h requests latency budget burn for OSD Fleet Manager API p99 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            latencytarget:api_inbound_request_duration_bucket:rate6h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (5.6*(1-0.99000))
            and
            latencytarget:api_inbound_request_duration_bucket:rate30m{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (5.6*(1-0.99000))
          labels:
            service: osd-fleet-manager
            latency: "1"
            quantile: "99"
            namespace: osd-fleet-manager-production
            severity: medium
        - alert: OSD Fleet Manager Latency p99 < 1s 6h to 3d budget burn
          annotations:
            message: "High 1d/3d requests latency budget burn for OSD Fleet Manager API p99 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            (
              latencytarget:api_inbound_request_duration_bucket:rate1d{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (2.8*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration_bucket:rate2h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (2.8*(1-0.99000))
            )
            or
            (
              latencytarget:api_inbound_request_duration_bucket:rate3d{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (1*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration_bucket:rate6h{service="fleet-manager-metrics",namespace="osd-fleet-manager-production",latency="1"} > (1*(1-0.99000))
            )
          labels:
            service: osd-fleet-manager
            latency: "1"
            quantile: "99"
            namespace: osd-fleet-manager-production
            severity: medium
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[5m]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[5m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate5m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[30m]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[30m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate30m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[1h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[1h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate1h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[2h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[2h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate2h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[6h]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[6h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate6h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[1d]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[1d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate1d
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket_bucket{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",le="1",code!~"5.."}[3d]))
              /
              sum(rate(api_inbound_request_duration_bucket_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production"}[3d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: osd-fleet-manager-production
          record: latencytarget:api_inbound_request_duration_bucket:rate3d

        # SLO Correctness (Create) p99
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: OSD Fleet Manager Cluster Creation 30m to 6h budget burn
          annotations:
            message: "High 6h error budget burn for OSD Fleet Manager create Cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate30m{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (5.60 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate6h{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (5.60 * (1-0.99000))
          for: 15m
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: create
            severity: medium
        - alert: OSD Fleet Manager Cluster Creation 2h to 1d budget burn
          annotations:
            message: "High 1d error budget burn for OSD Fleet Manager create Cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate2h{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (2.80 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate1d{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (2.80 * (1-0.99000))
          for: 1h
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: create
            severity: medium
        - alert: OSD Fleet Manager Cluster Creation 6h to 3d budget burn
          annotations:
            message: "High 3d error budget burn for OSD Fleet Manager create Cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate6h{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (1.00 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate3d{namespace="osd-fleet-manager-production",operation="create"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (1.00 * (1-0.99000))
          for: 3h
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: create
            severity: medium
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[1d]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[1d]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate1d
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[1h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[1h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate1h
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[2h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[2h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate2h
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[30m]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[30m]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate30m
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[3d]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[3d]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate3d
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[5m]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[5m]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate5m
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[6h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="create"}[6h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: create
          record: fleet_manager_cluster_operations:burnrate6h

        # SLO Correctness (Delete) p99
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: OSD Fleet Manager Cluster Deletion 30m to 6h budget burn
          annotations:
            message: "High 6h error budget burn for OSD Fleet Manager delete Cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate30m{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (5.60 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate6h{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (5.60 * (1-0.99000))
          for: 15m
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: delete
            severity: medium
        - alert: OSD Fleet Manager Cluster Deletion 2h to 1d budget burn
          annotations:
            message: "High 1d error budget burn for OSD Fleet Manager delete Cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate2h{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (2.80 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate1d{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (2.80 * (1-0.99000))
          for: 1h
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: delete
            severity: medium
        - alert: OSD Fleet Manager Cluster Deletion 6h to 3d budget burn
          annotations:
            message: "High 3d error budget burn for OSD Fleet Manager delete cluster operations in sector {{ $labels.sector }} (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate6h{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (1.00 * (1-0.99000))
            and
            sum by (sector) (label_replace(fleet_manager_cluster_operations:burnrate3d{namespace="osd-fleet-manager-production",operation="delete"}, "sector", "$1", "service", "fleet-manager-metrics-(.*)")) > (1.00 * (1-0.99000))
          for: 3h
          labels:
            service: osd-fleet-manager
            namespace: osd-fleet-manager-production
            operation: delete
            severity: medium
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[1d]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[1d]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate1d
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[1h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[1h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate1h
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[2h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[2h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate2h
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[30m]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[30m]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate30m
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[3d]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[3d]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate3d
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[5m]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[5m]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate5m
        - expr: |
            1 - (
              sum(rate(fleet_manager_cluster_operations_success_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[6h]))
              /
              sum(rate(fleet_manager_cluster_operations_total_count{service=~"fleet-manager-metrics.*",namespace="osd-fleet-manager-production",operation="delete"}[6h]))
            )
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
            operation: delete
          record: fleet_manager_cluster_operations:burnrate6h

    - name: osd-fleet-manager-reconciler
      rules:
        - expr: |
            sum by (worker_type, service) (rate(fleet_manager_reconciler_failure_count[5m]))
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: reconciler:fleet_manager_reconciler_failure_count:rate5m
        - alert: OSD Fleet Manager reconciler failure
          annotations:
            message: "The reconciler of type {{ $labels.worker_type }} for sector {{ $labels.sector }} failed with a rate of {{ $value }}/s over the last 15 minutes."
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            label_replace(reconciler:fleet_manager_reconciler_failure_count:rate5m, "sector", "$1", "service", "fleet-manager-metrics-(.*)") > 0
          for: 15m
          labels:
            severity: high
            team: osd
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager

        - expr: |
            max by (worker_type, service) (fleet_manager_reconciler_duration_in_seconds)
          labels:
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: reconciler:fleet_manager_reconciler_duration_in_seconds:max
        - alert: OSD Fleet Manager reconciler long duration
          annotations:
            message: "The maximum reconciler duration was {{ $value | humanizeDuration }} for sector {{ $labels.sector }} over the last 15 minutes."
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            label_replace(reconciler:fleet_manager_reconciler_duration_in_seconds:max, "sector", "$1", "service", "fleet-manager-metrics-(.*)") > 30
          for: 15m
          labels:
            severity: medium
            namespace: osd-fleet-manager-production
            service: osd-fleet-manager

    - name: osd-fleet-manager-saturation-level
      rules:
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[5m])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[5m]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[5m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate5m
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[30m])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[30m]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[30m]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate30m
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[1h])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[1h]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[1h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate1h
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[2h])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[2h]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[2h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate2h
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[6h])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[6h]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[6h]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate6h
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[1d])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[1d]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[1d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate1d
        - expr: |
            sum by (region, service_cluster) (rate(fleet_manager_management_cluster_hosted_cluster_count{namespace="osd-fleet-manager-production"}[3d])) 
            /
            (
            sum by (region, service_cluster) (rate(fleet_manager_available_management_clusters_by_service_cluster_count{namespace="osd-fleet-manager-production"}[3d]))
            *
            sum by (region, service_cluster) (rate(fleet_manager_max_desired_hosted_cluster_count{service=~"fleet-manager-metrics.*",namespace="$namespace"}[3d]))
            )
          labels:
            service: osd-fleet-manager
            job: fleet-manager-metrics
            namespace: osd-fleet-manager-production
          record: saturation:fleet_manager_saturation_level:rate3d
        - alert: OSD Fleet Manager saturation level exceeding 90% error budget burn 5m to 1h
          annotations:
            message: 'High error budget burn of saturation level exceeding 90% for Service Cluster {{ $labels.service_cluster }} in region {{ $labels.region }} (current value: {{ $value }})'
          expr: |
            sum(saturation:fleet_manager_saturation_level:rate5m{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (13.44 * (1-0.90000))
            and
            sum(saturation:fleet_manager_saturation_level:rate1h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (13.44 * (1-0.90000))
          for: 2m
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: high
            team: osd
        - alert: OSD Fleet Manager saturation level exceeding 90% error budget burn 30m to 6h 
          annotations:
            message: 'High error budget burn of saturation level exceeding 90% for Service Cluster {{ $labels.service_cluster }} in region {{ $labels.region }} (current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(saturation:fleet_manager_saturation_level:rate30m{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (5.60 * (1-0.90000))
            and
            sum(saturation:fleet_manager_saturation_level:rate6h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (5.60 * (1-0.90000))
          for: 15m
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
        - alert: OSD Fleet Manager saturation level exceeding 90% error budget burn 2h to 1d
          annotations:
            message: 'High error budget burn of saturation level exceeding 90% for Service Cluster {{ $labels.service_cluster }} in region {{ $labels.region }} (current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(saturation:fleet_manager_saturation_level:rate2h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (2.80 * (1-0.90000))
            and
            sum(saturation:fleet_manager_saturation_level:rate1d{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (2.80 * (1-0.90000))
          for: 1h
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
        - alert: OSD Fleet Manager saturation level exceeding 90% error budget burn 6h to 3d
          annotations:
            message: 'High error budget burn of saturation level exceeding 90% for for Service Cluster {{ $labels.service_cluster }} in region {{ $labels.region }} (current value: {{ $value }})'
            dashboard: "https://grafana.app-sre.devshift.net/d/osd_fleet_manager/osd-fleet-manager-metrics"
            runbook: ""
          expr: |
            sum(saturation:fleet_manager_saturation_level:rate6h{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (1.00 * (1-0.90000))
            and
            sum(saturation:fleet_manager_saturation_level:rate3d{route="osd-fleet-manager",exported_namespace="osd-fleet-manager-production"}) > (1.00 * (1-0.90000))
          for: 3h
          labels:
            service: osd-fleet-manager
            exported_namespace: osd-fleet-manager-production
            route: osd-fleet-manager
            severity: medium
